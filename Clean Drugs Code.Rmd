---
title: "Clean Drugs Code"
author: "Amanda Wright"
date: "6/28/2020"
output: html_document
---


# Workspace
## Packages
```{r}
library(mi)
library(psych)
library(readxl)
library(nnet)
library(lme4)
library(MuMIn)
library(gridExtra)
library(knitr)
library(kableExtra)
library(plyr)
library(stringr)
library(broom)
library(tidyverse)
library(MatchIt)
```

## Codebook
```{r}
codebook_drug_pers <- read_xlsx("~/Desktop/NLSY79study/drug_pers/codebook_drug_pers.xlsx")

codebook_child <- read_xlsx("~/Desktop/NLSY79study/drug_pers/codebook_drug_pers.xlsx", sheet = "Child") %>% filter(Include == "Yes")

codebook_mom <- read_xlsx("~/Desktop/NLSY79study/drug_pers/codebook_drug_pers.xlsx", sheet = "Mom") %>% filter(Include == "Yes")
```


# Data
## Children Data
### Load
```{r}
#drug and personality data

drug_pers_data <- read.table('~/Desktop/NLSY79study/drug_pers/drug_pers.dat', sep=' ')

names(drug_pers_data) <- c('C0000100',
  'C0000200',
  'C0005300',
  'C0005400',
  'C0005700',
  'C0573400',
  'C0573500',
  'C0573600',
  'C0573700',
  'C0573800',
  'C0573900',
  'C0731100',
  'C0732500',
  'C0732600',
  'C0732700',
  'C0732800',
  'C0732900',
  'C0733000',
  'C0733100',
  'C0733200',
  'C0733300',
  'C0793800',
  'C0793900',
  'C0794000',
  'C0794100',
  'C0794200',
  'C0794300',
  'C0942800',
  'C0944200',
  'C0944300',
  'C0944400',
  'C0944500',
  'C0944600',
  'C0944700',
  'C0944800',
  'C0944900',
  'C0945000',
  'C0993800',
  'C0993900',
  'C0994000',
  'C0994100',
  'C0994200',
  'C0994300',
  'C1137600',
  'C1139000',
  'C1139200',
  'C1139300',
  'C1139600',
  'C1139700',
  'C1139800',
  'C1139900',
  'C1140000',
  'C1140100',
  'C1140200',
  'C1140300',
  'C1140400',
  'C1194100',
  'C1194200',
  'C1194300',
  'C1194400',
  'C1194500',
  'C1194600',
  'C1366600',
  'C1368000',
  'C1368200',
  'C1368300',
  'C1368600',
  'C1368700',
  'C1368800',
  'C1368900',
  'C1369000',
  'C1369100',
  'C1369200',
  'C1369300',
  'C1369400',
  'C1369600',
  'C1369700',
  'C1369800',
  'C1369900',
  'C1370000',
  'C1370100',
  'C1370200',
  'C1370300',
  'C1370400',
  'C1370500',
  'C1370600',
  'C1370700',
  'C1370800',
  'C1370900',
  'C1501900',
  'C1502000',
  'C1502100',
  'C1502200',
  'C1502300',
  'C1502400',
  'C1558800',
  'C1558900',
  'C1559000',
  'C1559100',
  'C1559200',
  'C1559300',
  'C1588900',
  'C1590300',
  'C1590500',
  'C1590600',
  'C1590900',
  'C1591000',
  'C1591100',
  'C1591200',
  'C1591300',
  'C1591400',
  'C1591500',
  'C1591600',
  'C1591700',
  'C1591800',
  'C1592000',
  'C1592100',
  'C1592200',
  'C1592300',
  'C1592400',
  'C1592500',
  'C1592600',
  'C1592700',
  'C1592800',
  'C1592900',
  'C1593000',
  'C1593100',
  'C1593200',
  'C1593300',
  'C1593400',
  'C1794500',
  'C1794600',
  'C1794700',
  'C1794800',
  'C1794900',
  'C1795000',
  'C1927800',
  'C1930900',
  'C1931100',
  'C1931200',
  'C1931500',
  'C1931600',
  'C1931700',
  'C1931800',
  'C1931900',
  'C1932000',
  'C1932100',
  'C1932200',
  'C1932300',
  'C1932400',
  'C1932500',
  'C1932700',
  'C1932800',
  'C1932900',
  'C1933000',
  'C1933100',
  'C1933200',
  'C1933300',
  'C1933400',
  'C1933500',
  'C1933600',
  'C1933700',
  'C1933800',
  'C1933900',
  'C1934000',
  'C1934100',
  'C1934200',
  'C1934300',
  'C1934400',
  'C1934500',
  'C1934600',
  'C1934700',
  'C1934800',
  'C1934900',
  'C1935000',
  'C1935100',
  'C1935200',
  'C1935300',
  'C1935400',
  'C1935500',
  'C1935600',
  'C2466500',
  'C2470100',
  'C2470300',
  'C2470400',
  'C2470700',
  'C2470800',
  'C2470900',
  'C2471000',
  'C2471100',
  'C2471200',
  'C2471300',
  'C2471400',
  'C2471500',
  'C2471600',
  'C2471700',
  'C2471900',
  'C2472000',
  'C2472100',
  'C2472200',
  'C2472300',
  'C2472400',
  'C2472500',
  'C2472600',
  'C2472700',
  'C2472800',
  'C2472900',
  'C2473000',
  'C2473100',
  'C2473200',
  'C2473300',
  'C2473400',
  'C2473500',
  'C2473600',
  'C2473700',
  'C2473800',
  'C2473900',
  'C2474000',
  'C2474100',
  'C2474200',
  'C2474300',
  'C2474400',
  'C2474500',
  'C2474600',
  'C2474700',
  'C2474800',
  'C2497400',
  'C2497900',
  'C2498400',
  'C2498900',
  'C2499400',
  'C2499900',
  'C2525900',
  'C2526400',
  'C2526900',
  'C2527400',
  'C2527900',
  'C2528400',
  'C2766200',
  'C2767900',
  'C2768100',
  'C2768200',
  'C2768500',
  'C2768600',
  'C2768700',
  'C2768800',
  'C2768900',
  'C2769000',
  'C2769100',
  'C2769200',
  'C2769300',
  'C2769400',
  'C2769500',
  'C2769700',
  'C2769800',
  'C2769900',
  'C2770000',
  'C2770100',
  'C2770200',
  'C2770300',
  'C2770400',
  'C2770500',
  'C2770600',
  'C2770700',
  'C2770800',
  'C2770900',
  'C2771000',
  'C2771100',
  'C2771200',
  'C2771300',
  'C2771400',
  'C2771500',
  'C2771600',
  'C2771700',
  'C2771800',
  'C2771900',
  'C2772000',
  'C2772100',
  'C2772200',
  'C2772300',
  'C2772400',
  'C2797200',
  'C2797700',
  'C2798200',
  'C2798700',
  'C2799200',
  'C2799700',
  'C3045900',
  'C3047800',
  'C3048000',
  'C3048100',
  'C3048400',
  'C3048500',
  'C3048600',
  'C3048700',
  'C3048800',
  'C3048900',
  'C3049000',
  'C3049100',
  'C3049200',
  'C3049300',
  'C3049400',
  'C3049600',
  'C3049700',
  'C3049800',
  'C3049900',
  'C3050000',
  'C3050100',
  'C3050200',
  'C3050300',
  'C3050400',
  'C3050500',
  'C3050600',
  'C3050700',
  'C3050800',
  'C3050900',
  'C3051000',
  'C3051100',
  'C3051300',
  'C3051301',
  'C3051302',
  'C3051303',
  'C3105200',
  'C3105700',
  'C3106200',
  'C3106700',
  'C3107200',
  'C3107700',
  'C3366700',
  'C3368600',
  'C3368602',
  'C3368603',
  'C3368700',
  'C3368800',
  'C3368900',
  'C3369000',
  'C3369100',
  'C3369200',
  'C3369300',
  'C3369400',
  'C3369500',
  'C3369600',
  'C3369700',
  'C3369900',
  'C3370000',
  'C3370100',
  'C3370200',
  'C3370300',
  'C3370400',
  'C3370500',
  'C3370600',
  'C3370700',
  'C3370800',
  'C3370900',
  'C3371000',
  'C3371100',
  'C3371200',
  'C3371300',
  'C3371400',
  'C3371600',
  'C3371601',
  'C3371602',
  'C3371603',
  'C3608900',
  'C3609400',
  'C3609900',
  'C3610400',
  'C3610900',
  'C3611400',
  'C3870400',
  'C3872300',
  'C3872302',
  'C3872303',
  'C3872400',
  'C3872500',
  'C3872600',
  'C3872700',
  'C3872800',
  'C3872900',
  'C3873000',
  'C3873100',
  'C3873200',
  'C3873300',
  'C3873400',
  'C3873600',
  'C3873700',
  'C3873800',
  'C3873900',
  'C3874000',
  'C3874100',
  'C3874200',
  'C3874300',
  'C3874400',
  'C3874500',
  'C3874600',
  'C3874700',
  'C3874800',
  'C3874900',
  'C3875000',
  'C3875100',
  'C3875300',
  'C3875301',
  'C3875302',
  'C3875303',
  'C3987500',
  'C3988000',
  'C3988500',
  'C3989000',
  'C3989500',
  'C3990000',
  'C5118600',
  'C5120500',
  'C5120502',
  'C5120503',
  'C5120600',
  'C5120700',
  'C5120800',
  'C5120900',
  'C5121000',
  'C5121100',
  'C5121200',
  'C5121300',
  'C5121400',
  'C5121500',
  'C5121600',
  'C5121800',
  'C5121900',
  'C5122000',
  'C5122100',
  'C5122200',
  'C5122300',
  'C5122400',
  'C5122500',
  'C5122600',
  'C5122700',
  'C5122800',
  'C5122900',
  'C5123000',
  'C5123100',
  'C5123200',
  'C5123300',
  'C5123500',
  'C5123501',
  'C5123502',
  'C5123503',
  'C5531500',
  'C5532000',
  'C5532500',
  'C5533000',
  'C5533500',
  'C5534000',
  'C5696100',
  'C5698000',
  'C5698002',
  'C5698003',
  'C5698100',
  'C5698200',
  'C5698300',
  'C5698400',
  'C5698500',
  'C5698600',
  'C5698700',
  'C5698800',
  'C5698900',
  'C5699000',
  'C5699100',
  'C5699300',
  'C5699400',
  'C5699500',
  'C5699600',
  'C5699700',
  'C5699800',
  'C5699900',
  'C5700000',
  'C5700100',
  'C5700200',
  'C5700300',
  'C5700400',
  'C5700500',
  'C5700600',
  'C5700700',
  'C5700800',
  'C5701000',
  'C5701001',
  'C5701002',
  'C5701003',
  'C5807700',
  'C5808200',
  'C5808700',
  'C5809200',
  'C5809700',
  'C5810200',
  'C5968000',
  'C5969900',
  'C5969902',
  'C5969903',
  'C5970000',
  'C5970100',
  'C5970200',
  'C5970300',
  'C5970400',
  'C5970500',
  'C5970600',
  'C5970700',
  'C5970800',
  'C5970900',
  'C5971000',
  'C5971200',
  'C5971300',
  'C5971400',
  'C5971500',
  'C5971600',
  'C5971700',
  'C5971800',
  'C5971900',
  'C5972000',
  'C5972100',
  'C5972200',
  'C5972300',
  'C5972400',
  'C5972500',
  'C5972600',
  'C5972700',
  'C5972900',
  'C5972901',
  'C5972902',
  'C5972903',
  'C6053500',
  'C6054000',
  'C6054500',
  'C6055000',
  'C6055500',
  'C6056000',
  'Y0031300',
  'Y0275400',
  'Y0275500',
  'Y0275600',
  'Y0278400',
  'Y0278500',
  'Y0278600',
  'Y0281200',
  'Y0281300',
  'Y0283800',
  'Y0283900',
  'Y0286300',
  'Y0286400',
  'Y0288500',
  'Y0334300',
  'Y0334400',
  'Y0334500',
  'Y0334600',
  'Y0334700',
  'Y0334800',
  'Y0334900',
  'Y0335000',
  'Y0335100',
  'Y0335200',
  'Y0335300',
  'Y0335400',
  'Y0335500',
  'Y0335600',
  'Y0335700',
  'Y0335800',
  'Y0335900',
  'Y0336000',
  'Y0336100',
  'Y0336200',
  'Y0336300',
  'Y0336400',
  'Y0336500',
  'Y0336600',
  'Y0358000',
  'Y0358100',
  'Y0358200',
  'Y0358300',
  'Y0358400',
  'Y0358500',
  'Y0358600',
  'Y0358900',
  'Y0359000',
  'Y0359200',
  'Y0359500',
  'Y0359600',
  'Y0359700',
  'Y0360300',
  'Y0364400',
  'Y0364500',
  'Y0364600',
  'Y0364700',
  'Y0364800',
  'Y0364900',
  'Y0365000',
  'Y0365100',
  'Y0365200',
  'Y0365300',
  'Y0365400',
  'Y0365500',
  'Y0365600',
  'Y0365700',
  'Y0365800',
  'Y0365900',
  'Y0366000',
  'Y0366100',
  'Y0366200',
  'Y0366300',
  'Y0366400',
  'Y0366500',
  'Y0366600',
  'Y0367600',
  'Y0368200',
  'Y0416200',
  'Y0590800',
  'Y0590900',
  'Y0591000',
  'Y0592900',
  'Y0593000',
  'Y0593100',
  'Y0594900',
  'Y0595000',
  'Y0595100',
  'Y0596700',
  'Y0634700',
  'Y0634800',
  'Y0634900',
  'Y0635000',
  'Y0635100',
  'Y0635200',
  'Y0635300',
  'Y0635400',
  'Y0635500',
  'Y0635600',
  'Y0635700',
  'Y0635800',
  'Y0635900',
  'Y0636000',
  'Y0636100',
  'Y0636200',
  'Y0636300',
  'Y0636400',
  'Y0636500',
  'Y0636600',
  'Y0636700',
  'Y0636800',
  'Y0636900',
  'Y0637000',
  'Y0652300',
  'Y0652400',
  'Y0652500',
  'Y0652600',
  'Y0652700',
  'Y0652800',
  'Y0652900',
  'Y0653000',
  'Y0653100',
  'Y0653300',
  'Y0653600',
  'Y0653700',
  'Y0654300',
  'Y0658400',
  'Y0658500',
  'Y0658600',
  'Y0658700',
  'Y0658800',
  'Y0658900',
  'Y0659000',
  'Y0659100',
  'Y0659200',
  'Y0659300',
  'Y0659400',
  'Y0659500',
  'Y0659600',
  'Y0659700',
  'Y0659800',
  'Y0659900',
  'Y0660000',
  'Y0660100',
  'Y0660200',
  'Y0660300',
  'Y0660400',
  'Y0660500',
  'Y0660600',
  'Y0660700',
  'Y0661800',
  'Y0706300',
  'Y0890700',
  'Y0890800',
  'Y0890900',
  'Y0929200',
  'Y0929300',
  'Y0929400',
  'Y0929500',
  'Y0929600',
  'Y0929700',
  'Y0929800',
  'Y0929900',
  'Y0930000',
  'Y0930100',
  'Y0930200',
  'Y0930300',
  'Y0930400',
  'Y0930500',
  'Y0930600',
  'Y0930700',
  'Y0930800',
  'Y0930900',
  'Y0931000',
  'Y0931100',
  'Y0931200',
  'Y0931300',
  'Y0931400',
  'Y0931500',
  'Y0948400',
  'Y0948500',
  'Y0948600',
  'Y0948700',
  'Y0948800',
  'Y0948900',
  'Y0949000',
  'Y0949100',
  'Y0949200',
  'Y0949400',
  'Y0949700',
  'Y0949800',
  'Y0950400',
  'Y0954100',
  'Y0954300',
  'Y0954400',
  'Y0954500',
  'Y0954600',
  'Y0954700',
  'Y0954800',
  'Y0954900',
  'Y0955000',
  'Y0955100',
  'Y0955200',
  'Y0955300',
  'Y0955400',
  'Y0955500',
  'Y0955600',
  'Y0955700',
  'Y0955800',
  'Y0955900',
  'Y0956000',
  'Y0956100',
  'Y0956200',
  'Y0956300',
  'Y0956400',
  'Y0956500',
  'Y0956600',
  'Y0956700',
  'Y0957200',
  'Y0957300',
  'Y0957400',
  'Y0957500',
  'Y0957600',
  'Y0958800',
  'Y1011400',
  'Y1159200',
  'Y1159300',
  'Y1159400',
  'Y1159500',
  'Y1159600',
  'Y1159700',
  'Y1159800',
  'Y1159900',
  'Y1160000',
  'Y1160100',
  'Y1160200',
  'Y1160300',
  'Y1160400',
  'Y1160500',
  'Y1160600',
  'Y1160700',
  'Y1160800',
  'Y1160900',
  'Y1161000',
  'Y1161100',
  'Y1161200',
  'Y1161300',
  'Y1161400',
  'Y1161500',
  'Y1161600',
  'Y1161700',
  'Y1161800',
  'Y1161900',
  'Y1162000',
  'Y1162100',
  'Y1164900',
  'Y1165000',
  'Y1165100',
  'Y1165200',
  'Y1165300',
  'Y1165400',
  'Y1165500',
  'Y1165600',
  'Y1165700',
  'Y1167900',
  'Y1168000',
  'Y1168100',
  'Y1168200',
  'Y1168300',
  'Y1168400',
  'Y1168500',
  'Y1168600',
  'Y1168700',
  'Y1168800',
  'Y1168900',
  'Y1169000',
  'Y1169100',
  'Y1169200',
  'Y1169300',
  'Y1169400',
  'Y1169500',
  'Y1169600',
  'Y1170500',
  'Y1170600',
  'Y1170700',
  'Y1170800',
  'Y1170900',
  'Y1171000',
  'Y1171300',
  'Y1171400',
  'Y1171500',
  'Y1171600',
  'Y1171700',
  'Y1171800',
  'Y1171900',
  'Y1172000',
  'Y1172100',
  'Y1172200',
  'Y1172300',
  'Y1172400',
  'Y1172500',
  'Y1172600',
  'Y1172700',
  'Y1172800',
  'Y1253600',
  'Y1394300',
  'Y1394400',
  'Y1394500',
  'Y1394600',
  'Y1394700',
  'Y1394800',
  'Y1394900',
  'Y1395000',
  'Y1395100',
  'Y1395200',
  'Y1395300',
  'Y1395400',
  'Y1395500',
  'Y1395600',
  'Y1395700',
  'Y1395800',
  'Y1395900',
  'Y1396000',
  'Y1396100',
  'Y1396200',
  'Y1396300',
  'Y1396400',
  'Y1396500',
  'Y1396600',
  'Y1396700',
  'Y1396800',
  'Y1396900',
  'Y1397000',
  'Y1397100',
  'Y1397200',
  'Y1403400',
  'Y1403600',
  'Y1403700',
  'Y1404000',
  'Y1404100',
  'Y1404200',
  'Y1404300',
  'Y1404400',
  'Y1404500',
  'Y1404600',
  'Y1404700',
  'Y1404800',
  'Y1405500',
  'Y1407000',
  'Y1407100',
  'Y1407200',
  'Y1407300',
  'Y1407400',
  'Y1407500',
  'Y1407600',
  'Y1407700',
  'Y1407800',
  'Y1407900',
  'Y1408000',
  'Y1408100',
  'Y1408200',
  'Y1408300',
  'Y1408400',
  'Y1408500',
  'Y1408600',
  'Y1408700',
  'Y1408800',
  'Y1409700',
  'Y1409800',
  'Y1409900',
  'Y1410000',
  'Y1410100',
  'Y1410200',
  'Y1410500',
  'Y1410600',
  'Y1410700',
  'Y1410800',
  'Y1410900',
  'Y1411000',
  'Y1411100',
  'Y1411200',
  'Y1411300',
  'Y1411400',
  'Y1411500',
  'Y1411600',
  'Y1411700',
  'Y1411800',
  'Y1411900',
  'Y1412000',
  'Y1416300',
  'Y1486700',
  'Y1645800',
  'Y1645900',
  'Y1646000',
  'Y1646100',
  'Y1646200',
  'Y1646300',
  'Y1646400',
  'Y1646500',
  'Y1646600',
  'Y1646700',
  'Y1646800',
  'Y1646900',
  'Y1647000',
  'Y1647100',
  'Y1647200',
  'Y1647300',
  'Y1647400',
  'Y1647500',
  'Y1647600',
  'Y1647700',
  'Y1647800',
  'Y1647900',
  'Y1648000',
  'Y1648100',
  'Y1648200',
  'Y1648300',
  'Y1648400',
  'Y1648500',
  'Y1648600',
  'Y1648700',
  'Y1654600',
  'Y1654800',
  'Y1654900',
  'Y1655200',
  'Y1655300',
  'Y1655400',
  'Y1655500',
  'Y1655600',
  'Y1655700',
  'Y1655800',
  'Y1655900',
  'Y1656000',
  'Y1656700',
  'Y1656800',
  'Y1656900',
  'Y1658300',
  'Y1658400',
  'Y1658500',
  'Y1658600',
  'Y1658700',
  'Y1658800',
  'Y1658900',
  'Y1659000',
  'Y1659100',
  'Y1659200',
  'Y1659300',
  'Y1659400',
  'Y1659500',
  'Y1659600',
  'Y1659700',
  'Y1659800',
  'Y1659900',
  'Y1660000',
  'Y1660100',
  'Y1660200',
  'Y1660500',
  'Y1660600',
  'Y1660700',
  'Y1660800',
  'Y1660900',
  'Y1661000',
  'Y1661300',
  'Y1661400',
  'Y1661500',
  'Y1661600',
  'Y1661700',
  'Y1661800',
  'Y1661900',
  'Y1662000',
  'Y1662100',
  'Y1662200',
  'Y1662300',
  'Y1662400',
  'Y1662500',
  'Y1662600',
  'Y1662700',
  'Y1662800',
  'Y1667700',
  'Y1883500',
  'Y1917600',
  'Y1917700',
  'Y1917800',
  'Y1917900',
  'Y1918000',
  'Y1918100',
  'Y1918200',
  'Y1918300',
  'Y1918400',
  'Y1918500',
  'Y1918600',
  'Y1918700',
  'Y1918800',
  'Y1918900',
  'Y1919000',
  'Y1919100',
  'Y1919200',
  'Y1919300',
  'Y1919400',
  'Y1919500',
  'Y1919600',
  'Y1919700',
  'Y1919800',
  'Y1919900',
  'Y1920000',
  'Y1920100',
  'Y1920200',
  'Y1920300',
  'Y1920400',
  'Y1920500',
  'Y1927300',
  'Y1927500',
  'Y1927600',
  'Y1928000',
  'Y1928100',
  'Y1928200',
  'Y1928300',
  'Y1928400',
  'Y1928500',
  'Y1928600',
  'Y1928700',
  'Y1928800',
  'Y1929600',
  'Y1929700',
  'Y1931400',
  'Y1931500',
  'Y1931600',
  'Y1931700',
  'Y1931800',
  'Y1931900',
  'Y1932000',
  'Y1932200',
  'Y1932300',
  'Y1932400',
  'Y1932500',
  'Y1932600',
  'Y1932700',
  'Y1932800',
  'Y1932900',
  'Y1933000',
  'Y1933100',
  'Y1933200',
  'Y1933300',
  'Y1933400',
  'Y1933900',
  'Y1934000',
  'Y1934100',
  'Y1934200',
  'Y1934400',
  'Y1934500',
  'Y1934800',
  'Y1934900',
  'Y1935000',
  'Y1935100',
  'Y1935200',
  'Y1935300',
  'Y1935400',
  'Y1935500',
  'Y1935600',
  'Y1935700',
  'Y1935800',
  'Y1935900',
  'Y1936000',
  'Y1936100',
  'Y1936200',
  'Y1936300',
  'Y1941000',
  'Y2197600',
  'Y2197700',
  'Y2232800',
  'Y2232900',
  'Y2233000',
  'Y2233100',
  'Y2233200',
  'Y2233300',
  'Y2233400',
  'Y2233500',
  'Y2233600',
  'Y2233700',
  'Y2233800',
  'Y2233900',
  'Y2234000',
  'Y2234100',
  'Y2234200',
  'Y2234300',
  'Y2234400',
  'Y2234500',
  'Y2234600',
  'Y2234700',
  'Y2234800',
  'Y2234900',
  'Y2235000',
  'Y2235100',
  'Y2235200',
  'Y2235300',
  'Y2235400',
  'Y2235500',
  'Y2235600',
  'Y2235700',
  'Y2244200',
  'Y2244400',
  'Y2244500',
  'Y2244900',
  'Y2245000',
  'Y2245100',
  'Y2245200',
  'Y2245300',
  'Y2245400',
  'Y2245500',
  'Y2245600',
  'Y2245700',
  'Y2246400',
  'Y2246500',
  'Y2246600',
  'Y2247400',
  'Y2247500',
  'Y2247600',
  'Y2247700',
  'Y2247800',
  'Y2247900',
  'Y2248000',
  'Y2248200',
  'Y2248300',
  'Y2248400',
  'Y2248500',
  'Y2248600',
  'Y2248700',
  'Y2248800',
  'Y2248900',
  'Y2249000',
  'Y2249100',
  'Y2249200',
  'Y2249300',
  'Y2249400',
  'Y2249900',
  'Y2250000',
  'Y2250100',
  'Y2250200',
  'Y2250400',
  'Y2250500',
  'Y2250800',
  'Y2250900',
  'Y2251000',
  'Y2251100',
  'Y2251200',
  'Y2251300',
  'Y2251400',
  'Y2251500',
  'Y2251600',
  'Y2251700',
  'Y2251800',
  'Y2251900',
  'Y2252000',
  'Y2252100',
  'Y2252200',
  'Y2252300',
  'Y2257000',
  'Y2267000',
  'Y2537300',
  'Y2537500',
  'Y2584400',
  'Y2584500',
  'Y2584600',
  'Y2584700',
  'Y2584800',
  'Y2584900',
  'Y2585000',
  'Y2585100',
  'Y2585200',
  'Y2585300',
  'Y2585400',
  'Y2585500',
  'Y2585600',
  'Y2585700',
  'Y2585800',
  'Y2585900',
  'Y2586000',
  'Y2586100',
  'Y2586200',
  'Y2586300',
  'Y2586400',
  'Y2586500',
  'Y2586600',
  'Y2586700',
  'Y2586800',
  'Y2586900',
  'Y2587000',
  'Y2587100',
  'Y2587200',
  'Y2587300',
  'Y2587400',
  'Y2587500',
  'Y2587600',
  'Y2587700',
  'Y2596300',
  'Y2596500',
  'Y2596600',
  'Y2597000',
  'Y2597100',
  'Y2597200',
  'Y2597300',
  'Y2597400',
  'Y2597500',
  'Y2597600',
  'Y2597700',
  'Y2597800',
  'Y2599000',
  'Y2599900',
  'Y2600000',
  'Y2600100',
  'Y2600200',
  'Y2600300',
  'Y2600400',
  'Y2600500',
  'Y2600700',
  'Y2600800',
  'Y2600900',
  'Y2601000',
  'Y2601100',
  'Y2601200',
  'Y2601300',
  'Y2601500',
  'Y2601600',
  'Y2601700',
  'Y2601800',
  'Y2602000',
  'Y2602100',
  'Y2602400',
  'Y2602500',
  'Y2602600',
  'Y2602700',
  'Y2602800',
  'Y2602900',
  'Y2603000',
  'Y2603100',
  'Y2603200',
  'Y2603300',
  'Y2603400',
  'Y2603500',
  'Y2603600',
  'Y2603700',
  'Y2603800',
  'Y2603900',
  'Y2608600',
  'Y2885400',
  'Y2885600',
  'Y2932300',
  'Y2932400',
  'Y2932500',
  'Y2932600',
  'Y2932700',
  'Y2932800',
  'Y2932900',
  'Y2933000',
  'Y2933100',
  'Y2933200',
  'Y2933300',
  'Y2933400',
  'Y2933500',
  'Y2933600',
  'Y2933700',
  'Y2933800',
  'Y2933900',
  'Y2934000',
  'Y2934100',
  'Y2934200',
  'Y2934300',
  'Y2934400',
  'Y2934500',
  'Y2934700',
  'Y2934800',
  'Y2934900',
  'Y2935000',
  'Y2935100',
  'Y2935200',
  'Y2935300',
  'Y2935400',
  'Y2935500',
  'Y2935600',
  'Y2935700',
  'Y2946000',
  'Y2946200',
  'Y2946300',
  'Y2947300',
  'Y2947400',
  'Y2947500',
  'Y2947600',
  'Y2947700',
  'Y2947800',
  'Y2947900',
  'Y2948000',
  'Y2948100',
  'Y2949300',
  'Y2949400',
  'Y2949500',
  'Y2950000',
  'Y2950100',
  'Y2950200',
  'Y2950300',
  'Y2950400',
  'Y2950500',
  'Y2950600',
  'Y2950800',
  'Y2950900',
  'Y2951000',
  'Y2951100',
  'Y2951200',
  'Y2951300',
  'Y2951400',
  'Y2951600',
  'Y2951700',
  'Y2951800',
  'Y2951900',
  'Y2952100',
  'Y2952200',
  'Y2952500',
  'Y2952600',
  'Y2952700',
  'Y2952800',
  'Y2952900',
  'Y2953000',
  'Y2953100',
  'Y2953200',
  'Y2953300',
  'Y2953400',
  'Y2953500',
  'Y2953600',
  'Y2953700',
  'Y2953800',
  'Y2953900',
  'Y2954000',
  'Y2958700',
  'Y3302400',
  'Y3302500',
  'Y3302600',
  'Y3302700',
  'Y3302800',
  'Y3302900',
  'Y3303000',
  'Y3303100',
  'Y3303200',
  'Y3303300',
  'Y3303400',
  'Y3303500',
  'Y3303600',
  'Y3303700',
  'Y3303800',
  'Y3303900',
  'Y3304000',
  'Y3304100',
  'Y3304200',
  'Y3304300',
  'Y3304400',
  'Y3304500',
  'Y3304600',
  'Y3304800',
  'Y3304900',
  'Y3305000',
  'Y3305100',
  'Y3305200',
  'Y3305300',
  'Y3305400',
  'Y3305500',
  'Y3305600',
  'Y3305700',
  'Y3305800',
  'Y3315000',
  'Y3315002',
  'Y3315003',
  'Y3315900',
  'Y3316000',
  'Y3316100',
  'Y3316300',
  'Y3316400',
  'Y3316500',
  'Y3316600',
  'Y3316700',
  'Y3317900',
  'Y3318000',
  'Y3318100',
  'Y3318600',
  'Y3318700',
  'Y3318800',
  'Y3318900',
  'Y3319000',
  'Y3319100',
  'Y3319200',
  'Y3319400',
  'Y3319500',
  'Y3319600',
  'Y3319700',
  'Y3319800',
  'Y3319900',
  'Y3320000',
  'Y3320200',
  'Y3320300',
  'Y3320400',
  'Y3320500',
  'Y3320700',
  'Y3320800',
  'Y3321100',
  'Y3321200',
  'Y3321300',
  'Y3321400',
  'Y3321500',
  'Y3321600',
  'Y3321700',
  'Y3321800',
  'Y3321900',
  'Y3322000',
  'Y3322100',
  'Y3322200',
  'Y3322300',
  'Y3322400',
  'Y3322500',
  'Y3322600',
  'Y3325705',
  'Y3326211',
  'Y3538600',
  'Y3538700',
  'Y3538800',
  'Y3538900',
  'Y3539000',
  'Y3645200',
  'Y3645300',
  'Y3645400',
  'Y3645500',
  'Y3645600',
  'Y3645700',
  'Y3645800',
  'Y3645900',
  'Y3646000',
  'Y3646100',
  'Y3646200',
  'Y3646300',
  'Y3646400',
  'Y3646500',
  'Y3646600',
  'Y3646700',
  'Y3646800',
  'Y3646900',
  'Y3647000',
  'Y3647100',
  'Y3647200',
  'Y3647300',
  'Y3647400',
  'Y3647800',
  'Y3647900',
  'Y3648000',
  'Y3648100',
  'Y3648200',
  'Y3648300',
  'Y3648400',
  'Y3648500',
  'Y3648600',
  'Y3648700',
  'Y3648800',
  'Y3658800',
  'Y3658802',
  'Y3658803',
  'Y3659200',
  'Y3659700',
  'Y3659800',
  'Y3659900',
  'Y3660000',
  'Y3660100',
  'Y3660200',
  'Y3660300',
  'Y3660400',
  'Y3660500',
  'Y3660600',
  'Y3660700',
  'Y3660800',
  'Y3661300',
  'Y3661500',
  'Y3661700',
  'Y3661800',
  'Y3661900',
  'Y3662400',
  'Y3662500',
  'Y3662600',
  'Y3662700',
  'Y3662800',
  'Y3662900',
  'Y3663000',
  'Y3663200',
  'Y3663300',
  'Y3663400',
  'Y3663500',
  'Y3663600',
  'Y3663700',
  'Y3663800',
  'Y3663900',
  'Y3664000',
  'Y3664200',
  'Y3664300',
  'Y3664500',
  'Y3664600',
  'Y3664700',
  'Y3664900',
  'Y3665000',
  'Y3665100',
  'Y3665200',
  'Y3665300',
  'Y3665500',
  'Y3665600',
  'Y3665900',
  'Y3666000',
  'Y3666100',
  'Y3666200',
  'Y3666300',
  'Y3666400',
  'Y3666500',
  'Y3666600',
  'Y3666700',
  'Y3666800',
  'Y3666900',
  'Y3667000',
  'Y3667100',
  'Y3667200',
  'Y3667300',
  'Y3670805')

# Handle missing values

  drug_pers_data[drug_pers_data == -1] = NA  # Refused 
  drug_pers_data[drug_pers_data == -2] = NA  # Dont know 
  drug_pers_data[drug_pers_data == -3] = NA  # Invalid missing 
  drug_pers_data[drug_pers_data == -7] = NA  # Missing


# IDs of mom & children
  
moms <- unique((drug_pers_data %>% 
  select(C0000100, C0000200) %>%
  setNames(c("PROC_CID", "PROC_MID")))$PROC_CID)

part_ids <- drug_pers_data %>% 
  select(C0000100, C0000200, C0005700, C0005400) %>%
  setNames(c("PROC_CID", "PROC_MID", "Dem_DOBYear", "DemCSex")) %>%
  filter(!is.na(PROC_CID) & !is.na(PROC_MID))

moms <- unique(part_ids$PROC_MID)
```

## Mom Match Data
### Load
```{r}
#mother data

mom_match_data <- read.table('mommatch.dat', sep=' ')
names(mom_match_data) <- c('G0005300',
  'G0007900',
  'G0013100',
  'G0015700',
  'G0020900',
  'G0023500',
  'G0028700',
  'G0031300',
  'G0036500',
  'G0039100',
  'G0044300',
  'G0046900',
  'G0052100',
  'G0054700',
  'G0059900',
  'G0062500',
  'G0067700',
  'G0070300',
  'G0075500',
  'G0078100',
  'G0083300',
  'G0085900',
  'G0091100',
  'G0093700',
  'G0098900',
  'G0101500',
  'G0106700',
  'G0109300',
  'G0114500',
  'G0117100',
  'G0126200',
  'G0127500',
  'G0131400',
  'G0132700',
  'G0143000',
  'G0143100',
  'G0148200',
  'G0148300',
  'G0158600',
  'G0158700',
  'G0163800',
  'G0163900',
  'G0174200',
  'G0174300',
  'G0179400',
  'G0179500',
  'G0189800',
  'G0189900',
  'G0195000',
  'G0195100',
  'G0205400',
  'G0205500',
  'G0210600',
  'G0210700',
  'G0221100',
  'G0221200',
  'G0226300',
  'G0226400',
  'G0227400',
  'G0228100',
  'G0228900',
  'G0229500',
  'G0239600',
  'G0241600',
  'G0241900',
  'G0242100',
  'G0242900',
  'G0243400',
  'G0257700',
  'G0260300',
  'G0260500',
  'G0260700',
  'G0273400',
  'G0276000',
  'G0279900',
  'G0281900',
  'G0290100',
  'G0292700',
  'G0297100',
  'G0299300',
  'G0308100',
  'G0309300',
  'G0313100',
  'G0314300',
  'R0000100',
  'R0017300',
  'R0173600',
  'R0188000',
  'R0214700',
  'R0214800',
  'R0217501',
  'R0217900',
  'R0229200',
  'R0305700',
  'R0305900',
  'R0309200',
  'R0309300',
  'R0402800',
  'R0405601',
  'R0406010',
  'R0406310',
  'R0417400',
  'R0612100',
  'R0618410',
  'R0618601',
  'R0618810',
  'R0664500',
  'R0828400',
  'R0898401',
  'R0898510',
  'R0898600',
  'R0905900',
  'R1075700',
  'R1144500',
  'R1144710',
  'R1144901',
  'R1205800',
  'R1395100',
  'R1395200',
  'R1395300',
  'R1395400',
  'R1395500',
  'R1395600',
  'R1395700',
  'R1395800',
  'R1396000',
  'R1396100',
  'R1396200',
  'R1396300',
  'R1396400',
  'R1396500',
  'R1396600',
  'R1396700',
  'R1396800',
  'R1396900',
  'R1397000',
  'R1397100',
  'R1397200',
  'R1397300',
  'R1397400',
  'R1397500',
  'R1397600',
  'R1397700',
  'R1397800',
  'R1397900',
  'R1398000',
  'R1398100',
  'R1398200',
  'R1398300',
  'R1398400',
  'R1398500',
  'R1398600',
  'R1398700',
  'R1398800',
  'R1398900',
  'R1399000',
  'R1399100',
  'R1399200',
  'R1399300',
  'R1399400',
  'R1399500',
  'R1399600',
  'R1399700',
  'R1399800',
  'R1399900',
  'R1400000',
  'R1400100',
  'R1400200',
  'R1400300',
  'R1400400',
  'R1400500',
  'R1400600',
  'R1400700',
  'R1400800',
  'R1400900',
  'R1401000',
  'R1401100',
  'R1401200',
  'R1401300',
  'R1401400',
  'R1401500',
  'R1401600',
  'R1401700',
  'R1401800',
  'R1401900',
  'R1402000',
  'R1402100',
  'R1402200',
  'R1402300',
  'R1402400',
  'R1402500',
  'R1402600',
  'R1402700',
  'R1404000',
  'R1404100',
  'R1404200',
  'R1406400',
  'R1406500',
  'R1407400',
  'R1407700',
  'R1407800',
  'R1408700',
  'R1408800',
  'R1451400',
  'R1519700',
  'R1519910',
  'R1520101',
  'R1605100',
  'R1790803',
  'R1798600',
  'R1890300',
  'R1890400',
  'R1890801',
  'R1905600',
  'R2153903',
  'R2160200',
  'R2257400',
  'R2257500',
  'R2257901',
  'R2306500',
  'R2362503',
  'R2369100',
  'R2444600',
  'R2444700',
  'R2445301',
  'R2500000',
  'R2509000',
  'R2591200',
  'R2591300',
  'R2591400',
  'R2591500',
  'R2591800',
  'R2591900',
  'R2592000',
  'R2592100',
  'R2720800',
  'R2720900',
  'R2721000',
  'R2721100',
  'R2721200',
  'R2721300',
  'R2721400',
  'R2721500',
  'R2721600',
  'R2721700',
  'R2721800',
  'R2721900',
  'R2722000',
  'R2735403',
  'R2870100',
  'R2870200',
  'R2871000',
  'R2900000',
  'R2908100',
  'R2982903',
  'R3073900',
  'R3074000',
  'R3074700',
  'R3100000',
  'R3110200',
  'R3198000',
  'R3198100',
  'R3198200',
  'R3198300',
  'R3222300',
  'R3222400',
  'R3222500',
  'R3222600',
  'R3293303',
  'R3400500',
  'R3400700',
  'R3401400',
  'R3500000',
  'R3510200',
  'R3655900',
  'R3656100',
  'R3656800',
  'R3700000',
  'R3710200',
  'R3793300',
  'R3793400',
  'R3793500',
  'R3793600',
  'R3807200',
  'R3807400',
  'R3884200',
  'R3884300',
  'R3884400',
  'R3884500',
  'R3884600',
  'R3884700',
  'R3884800',
  'R3884900',
  'R3911003',
  'R3915000',
  'R3915100',
  'R3915200',
  'R3915300',
  'R3915400',
  'R3915500',
  'R3915600',
  'R3915700',
  'R3915800',
  'R3915900',
  'R3916000',
  'R3916100',
  'R4006400',
  'R4006600',
  'R4007300',
  'R4100300',
  'R4137900',
  'R4392303',
  'R4417500',
  'R4417700',
  'R4418400',
  'R4500300',
  'R4526500',
  'R4856200',
  'R4856300',
  'R4856400',
  'R4856500',
  'R4873900',
  'R4874000',
  'R4960000',
  'R4960100',
  'R4960200',
  'R4960300',
  'R4960400',
  'R4960500',
  'R4960600',
  'R4960700',
  'R5046603',
  'R5053100',
  'R5053200',
  'R5053300',
  'R5053400',
  'R5053500',
  'R5053600',
  'R5053700',
  'R5053800',
  'R5053900',
  'R5054000',
  'R5054100',
  'R5054200',
  'R5080500',
  'R5080700',
  'R5081400',
  'R5165800',
  'R5166000',
  'R5166700',
  'R5200300',
  'R5221800',
  'R5526300',
  'R5526400',
  'R5526500',
  'R5526600',
  'R5537300',
  'R5537400',
  'R5537500',
  'R5537600',
  'R5615500',
  'R5615600',
  'R5615700',
  'R5615800',
  'R5615900',
  'R5616000',
  'R5616100',
  'R5616200',
  'R5728003',
  'R5800200',
  'R5821800',
  'R6252400',
  'R6252500',
  'R6252800',
  'R6252900',
  'R6253100',
  'R6253200',
  'R6253500',
  'R6342600',
  'R6342700',
  'R6342800',
  'R6342900',
  'R6343000',
  'R6343100',
  'R6343200',
  'R6343300',
  'R6426003',
  'R6430400',
  'R6430500',
  'R6430600',
  'R6430700',
  'R6430800',
  'R6430900',
  'R6431000',
  'R6431100',
  'R6431200',
  'R6431300',
  'R6431400',
  'R6431500',
  'R6478500',
  'R6478700',
  'R6479300',
  'R6530300',
  'R6540400',
  'R6803100',
  'R6803200',
  'R6803300',
  'R6803400',
  'R6803500',
  'R6803600',
  'R6886100',
  'R6886200',
  'R6886300',
  'R6886400',
  'R6886500',
  'R6886600',
  'R6886700',
  'R6886800',
  'R6940103',
  'R7006300',
  'R7006500',
  'R7007000',
  'R7090700',
  'R7103600',
  'R7455400',
  'R7455500',
  'R7455600',
  'R7455700',
  'R7455800',
  'R7455900',
  'R7456000',
  'R7456100',
  'R7456200',
  'R7456300',
  'R7456400',
  'R7456500',
  'R7456600',
  'R7456700',
  'R7456800',
  'R7456900',
  'R7457000',
  'R7457100',
  'R7457200',
  'R7457300',
  'R7703500',
  'R7703700',
  'R7704300',
  'R7800600',
  'R7810500',
  'R8164100',
  'R8164200',
  'R8164300',
  'R8164400',
  'R8164500',
  'R8164600',
  'R8164700',
  'R8164800',
  'R8164900',
  'R8165000',
  'R8165100',
  'R8165200',
  'R8165300',
  'R8165400',
  'R8300800',
  'R8378703',
  'R8495900',
  'R8496100',
  'R8496700',
  'T0001000',
  'T0014400',
  'T0373100',
  'T0373200',
  'T0373300',
  'T0373400',
  'T0373500',
  'T0373600',
  'T0373700',
  'T0373800',
  'T0373900',
  'T0374000',
  'T0911100',
  'T0987500',
  'T0987800',
  'T0988500',
  'T1200800',
  'T1214300',
  'T1526500',
  'T1526600',
  'T1526700',
  'T1526800',
  'T1526900',
  'T1527000',
  'T1527100',
  'T1527200',
  'T1527300',
  'T1527400',
  'T1527500',
  'T1527600',
  'T1527700',
  'T1527800',
  'T2075400',
  'T2142702',
  'T2209800',
  'T2210000',
  'T2210500',
  'T2260700',
  'T2272800',
  'T2565300',
  'T2565400',
  'T2565500',
  'T2565600',
  'T2565700',
  'T2565800',
  'T2565900',
  'T2566000',
  'T3044000',
  'T3107600',
  'T3107800',
  'T3108400',
  'T3195700',
  'T3212900',
  'T3548400',
  'T3548500',
  'T3548600',
  'T3548700',
  'T3976200',
  'T4045802',
  'T4112100',
  'T4112300',
  'T4112900',
  'T4181500',
  'T4201100',
  'T4523500',
  'T4523600',
  'T4523700',
  'T4523800',
  'T4523900',
  'T4524000',
  'T4524100',
  'T4524200',
  'T4914500',
  'T5022300',
  'T5022600',
  'T5023300',
  'T5152100',
  'T5176100',
  'T5461300',
  'T5461400',
  'T5461500',
  'T5461600',
  'T5461700',
  'T5461800',
  'T5461900',
  'T5462000',
  'T5684500',
  'T5770600',
  'T5770800',
  'T5771200')

# Handle missing values

  mom_match_data[mom_match_data == -1] = NA  # Refused 
  mom_match_data[mom_match_data == -2] = NA  # Dont know 
  mom_match_data[mom_match_data == -3] = NA  # Invalid missing 
  mom_match_data[mom_match_data == -4] = NA  # Valid missing 
  mom_match_data[mom_match_data == -5] = NA  # Non-interview 
```
### Clean
```{r}
mom_match_data <- tbl_df(mom_match_data) %>% select(one_of(codebook_mom$RNUM))

# get vector of original reference numbers (column names) of the mom data
mom_long_cols <- (codebook_mom %>% filter(!is.na(Rule.Age)))$RNUM

# get vector of the new variable names of the mom data
mom_new_cols <- (codebook_mom %>% filter(!is.na(Rule.Age)))$comb_varname


mom_long <- mom_match_data %>% 
  filter(R0000100 %in% moms) %>%
  select(R0000100, one_of(mom_long_cols)) %>%               # select ID, DOB, and items for compositing
  gather(key = item, value = value, one_of(mom_long_cols)) %>% # switch to long format
  setNames(c("PROC_MID", "item", "value")) %>% # rename columns
  full_join(part_ids) %>%
  mutate(item = mapvalues(item, mom_long_cols, mom_new_cols)) %>% # recode items to to new names
  mutate(item = mapvalues(item, mom_long_cols, mom_new_cols),
         value = ifelse(grepl("MJail_MRes", item) == T & value == 5, 1,
                 ifelse(grepl("MJail_MRes", item) == T & !is.na(value) == T, 0, 
                 ifelse(grepl("MJail_MRes", item) == F, value, NA))),
         value = ifelse(grepl("ParDvrcd", item) == T & value == 3, 1,
                 ifelse(grepl("ParDvrcd", item) == T & !is.na(value) == T, 0, 
                 ifelse(grepl("ParDvrcd", item) == F, value, NA))),
         value = ifelse(grepl("HHMomDead", item) == T & value == 65, 1,
                 ifelse(grepl("HHMomDead", item) == T & !is.na(value) == T, 0, 
                 ifelse(grepl("HHMomDead", item) == F, value, NA)))) %>% # recode items to to new names
  left_join((codebook_mom %>% # add in rules for compositing and reverse coding
               select(comb_varname, Rule.Age, Rule.Item, reverse_code) %>% 
               filter(comb_varname %in% mom_new_cols) %>% 
               mutate(item = comb_varname))) 
```

## Children Match Data
### Load
```{r}
#child match data

child_match_data <- read.table('matchchild.dat', sep=' ')
names(child_match_data) <- c('C0000100',
  'C0000200',
  'C0005300',
  'C0005400',
  'C0005700',
  'C0005800',
  'C0007400',
  'C0007600',
  'C0007700',
  'C0007800',
  'C0007900',
  'C0008000',
  'C0008010',
  'C0008020',
  'C0008030',
  'C0008040',
  'C0008042',
  'C0008043',
  'C0008044',
  'C0008045',
  'C0008046',
  'C0008047',
  'C0008048',
  'C0090300',
  'C0090700',
  'C0090900',
  'C0093400',
  'C0093800',
  'C0094000',
  'C0096500',
  'C0096900',
  'C0097100',
  'C0099600',
  'C0100000',
  'C0102700',
  'C0103100',
  'C0103300',
  'C0105800',
  'C0106200',
  'C0106400',
  'C0108900',
  'C0109300',
  'C0109500',
  'C0112000',
  'C0112400',
  'C0112600',
  'C0115600',
  'C0116300',
  'C0117200',
  'C0118700',
  'C0119400',
  'C0120300',
  'C0122600',
  'C0123700',
  'C0125800',
  'C0126900',
  'C0127417',
  'C0127428',
  'C0127617',
  'C0127628',
  'C0127817',
  'C0127828',
  'C0127917',
  'C0127928',
  'C0128000',
  'C0128017',
  'C0128028',
  'C0320200',
  'C0320300',
  'C0320400',
  'C0320500',
  'C0320510',
  'C0320520',
  'C0320530',
  'C0320540',
  'C0326500',
  'C0326600',
  'C0326700',
  'C0326800',
  'C0326900',
  'C0327000',
  'C0327100',
  'C0327200',
  'C0327300',
  'C0327400',
  'C0327500',
  'C0327600',
  'C0328100',
  'C0328300',
  'C0328400',
  'C0328600',
  'C0328800',
  'C0329100',
  'C0329200',
  'C0338500',
  'C0338600',
  'C0338700',
  'C0338800',
  'C0404300',
  'C0404400',
  'C0404500',
  'C0404700',
  'C0404800',
  'C0405000',
  'C0405100',
  'C0405200',
  'C0405400',
  'C0405500',
  'C0405600',
  'C0405700',
  'C0405800',
  'C0405900',
  'C0406000',
  'C0406100',
  'C0406200',
  'C0406300',
  'C0406400',
  'C0406500',
  'C0406700',
  'C0407900',
  'C0408000',
  'C0429700',
  'C0430100',
  'C0430500',
  'C0430700',
  'C0540900',
  'C0541000',
  'C0541500',
  'C0541600',
  'C0541800',
  'C0541900',
  'C0542000',
  'C0542100',
  'C0542200',
  'C0542300',
  'C0542800',
  'C0542900',
  'C0543700',
  'C0543800',
  'C0543900',
  'C0544000',
  'C0544100',
  'C0544200',
  'C0544300',
  'C0544400',
  'C0544500',
  'C0544600',
  'C0544700',
  'C0544800',
  'C0544900',
  'C0545000',
  'C0545100',
  'C0545200',
  'C0545300',
  'C0545500',
  'C0545600',
  'C0545700',
  'C0545800',
  'C0545900',
  'C0546000',
  'C0546100',
  'C0546300',
  'C0546400',
  'C0546500',
  'C0546600',
  'C0546700',
  'C0546800',
  'C0546900',
  'C0547000',
  'C0547100',
  'C0551300',
  'C0570300',
  'C0570700',
  'C0571100',
  'C0571800',
  'C0571900',
  'C0572000',
  'C0572100',
  'C0572200',
  'C0572300',
  'C0572400',
  'C0572500',
  'C0572510',
  'C0572600',
  'C0572700',
  'C0572710',
  'C0573400',
  'C0573500',
  'C0573600',
  'C0573700',
  'C0573800',
  'C0573900',
  'C0579600',
  'C0579700',
  'C0579900',
  'C0580200',
  'C0580500',
  'C0593100',
  'C0593200',
  'C0593400',
  'C0593500',
  'C0593700',
  'C0593800',
  'C0593900',
  'C0594100',
  'C0594200',
  'C0594300',
  'C0594400',
  'C0594500',
  'C0594600',
  'C0594700',
  'C0594800',
  'C0594900',
  'C0595000',
  'C0595100',
  'C0595200',
  'C0595300',
  'C0595400',
  'C0595600',
  'C0606000',
  'C0606300',
  'C0606400',
  'C0606600',
  'C0606700',
  'C0624700',
  'C0625100',
  'C0625500',
  'C0625700',
  'C0727200',
  'C0727300',
  'C0727400',
  'C0727500',
  'C0727600',
  'C0727700',
  'C0727800',
  'C0727900',
  'C0730600',
  'C0730700',
  'C0730800',
  'C0730900',
  'C0731000',
  'C0731200',
  'C0731300',
  'C0731400',
  'C0733600',
  'C0751300',
  'C0751400',
  'C0751900',
  'C0752000',
  'C0752200',
  'C0752300',
  'C0752400',
  'C0752500',
  'C0752600',
  'C0752700',
  'C0753300',
  'C0753400',
  'C0754400',
  'C0754500',
  'C0754600',
  'C0754700',
  'C0754800',
  'C0754900',
  'C0755000',
  'C0755100',
  'C0755200',
  'C0755300',
  'C0755400',
  'C0755500',
  'C0755600',
  'C0755700',
  'C0755800',
  'C0755900',
  'C0756000',
  'C0756200',
  'C0756300',
  'C0756400',
  'C0756500',
  'C0756600',
  'C0756700',
  'C0756800',
  'C0757000',
  'C0757100',
  'C0757200',
  'C0757300',
  'C0757400',
  'C0757500',
  'C0757600',
  'C0757700',
  'C0757800',
  'C0758700',
  'C0758800',
  'C0758900',
  'C0759000',
  'C0759100',
  'C0759200',
  'C0759300',
  'C0759400',
  'C0759500',
  'C0759600',
  'C0759700',
  'C0759800',
  'C0759900',
  'C0760000',
  'C0760100',
  'C0760200',
  'C0760300',
  'C0760400',
  'C0760500',
  'C0760700',
  'C0760800',
  'C0760900',
  'C0761000',
  'C0761100',
  'C0761200',
  'C0761300',
  'C0761500',
  'C0761600',
  'C0761700',
  'C0761800',
  'C0761900',
  'C0762000',
  'C0762100',
  'C0762200',
  'C0762300',
  'C0763200',
  'C0763300',
  'C0763400',
  'C0763500',
  'C0763600',
  'C0763700',
  'C0763800',
  'C0763900',
  'C0768100',
  'C0782800',
  'C0786000',
  'C0786100',
  'C0790300',
  'C0790700',
  'C0791100',
  'C0791500',
  'C0792200',
  'C0792300',
  'C0792400',
  'C0792500',
  'C0792600',
  'C0792700',
  'C0792800',
  'C0792900',
  'C0792910',
  'C0793000',
  'C0793100',
  'C0793110',
  'C0793800',
  'C0793900',
  'C0794000',
  'C0794100',
  'C0794200',
  'C0794300',
  'C0799100',
  'C0799200',
  'C0799400',
  'C0799700',
  'C0800000',
  'C0812100',
  'C0812200',
  'C0812400',
  'C0812500',
  'C0812700',
  'C0812800',
  'C0812900',
  'C0813100',
  'C0813200',
  'C0813300',
  'C0813400',
  'C0813500',
  'C0813600',
  'C0813700',
  'C0813800',
  'C0813900',
  'C0814000',
  'C0814100',
  'C0814200',
  'C0814300',
  'C0814400',
  'C0814600',
  'C0826100',
  'C0826400',
  'C0826500',
  'C0826700',
  'C0826800',
  'C0834100',
  'C0834500',
  'C0834900',
  'C0835100',
  'C0938400',
  'C0938500',
  'C0938600',
  'C0938700',
  'C0938800',
  'C0938900',
  'C0939000',
  'C0939100',
  'C0942300',
  'C0942400',
  'C0942500',
  'C0942600',
  'C0942700',
  'C0942900',
  'C0943000',
  'C0943100',
  'C0945300',
  'C0952400',
  'C0952500',
  'C0953000',
  'C0953100',
  'C0953200',
  'C0953300',
  'C0953500',
  'C0953600',
  'C0953700',
  'C0953900',
  'C0954000',
  'C0954100',
  'C0954200',
  'C0954300',
  'C0954900',
  'C0955000',
  'C0956000',
  'C0956100',
  'C0956200',
  'C0956300',
  'C0956400',
  'C0956600',
  'C0956700',
  'C0956800',
  'C0956900',
  'C0957000',
  'C0957100',
  'C0957200',
  'C0957300',
  'C0957400',
  'C0957500',
  'C0957600',
  'C0957700',
  'C0957800',
  'C0957900',
  'C0958000',
  'C0958200',
  'C0958300',
  'C0958400',
  'C0958500',
  'C0958600',
  'C0958700',
  'C0958900',
  'C0959000',
  'C0959100',
  'C0959200',
  'C0959400',
  'C0959500',
  'C0959600',
  'C0959700',
  'C0959800',
  'C0959900',
  'C0960000',
  'C0960100',
  'C0960200',
  'C0961200',
  'C0961300',
  'C0961400',
  'C0961500',
  'C0961600',
  'C0961700',
  'C0961800',
  'C0961900',
  'C0962000',
  'C0962100',
  'C0962200',
  'C0962300',
  'C0962400',
  'C0962500',
  'C0962600',
  'C0962700',
  'C0962800',
  'C0962900',
  'C0963000',
  'C0963200',
  'C0963300',
  'C0963400',
  'C0963500',
  'C0963600',
  'C0963700',
  'C0963900',
  'C0964000',
  'C0964100',
  'C0964200',
  'C0964400',
  'C0964500',
  'C0964600',
  'C0964700',
  'C0964800',
  'C0964900',
  'C0965000',
  'C0965100',
  'C0965200',
  'C0966200',
  'C0966300',
  'C0966400',
  'C0966500',
  'C0966600',
  'C0966700',
  'C0966800',
  'C0966900',
  'C0971100',
  'C0985800',
  'C0988700',
  'C0988800',
  'C0990300',
  'C0990700',
  'C0991100',
  'C0991500',
  'C0992200',
  'C0992300',
  'C0992400',
  'C0992500',
  'C0992600',
  'C0992700',
  'C0992800',
  'C0992900',
  'C0993000',
  'C0993100',
  'C0993800',
  'C0993900',
  'C0994000',
  'C0994100',
  'C0994200',
  'C0994300',
  'C0998300',
  'C0998400',
  'C0998600',
  'C0998900',
  'C0999200',
  'C1002100',
  'C1002400',
  'C1002500',
  'C1002700',
  'C1002800',
  'C1002900',
  'C1003100',
  'C1003200',
  'C1003300',
  'C1003400',
  'C1003500',
  'C1003600',
  'C1003700',
  'C1003800',
  'C1003900',
  'C1004000',
  'C1004100',
  'C1004200',
  'C1004300',
  'C1004400',
  'C1004600',
  'C1006300',
  'C1007400',
  'C1010600',
  'C1011700',
  'C1013300',
  'C1016100',
  'C1016700',
  'C1016800',
  'C1017000',
  'C1017100',
  'C1023200',
  'C1023600',
  'C1024000',
  'C1024200',
  'C1130100',
  'C1131900',
  'C1132000',
  'C1132100',
  'C1132200',
  'C1132300',
  'C1132400',
  'C1132500',
  'C1132600',
  'C1136200',
  'C1137100',
  'C1137200',
  'C1137300',
  'C1137400',
  'C1137500',
  'C1137700',
  'C1137800',
  'C1137900',
  'C1139100',
  'C1139400',
  'C1139500',
  'C1150500',
  'C1150600',
  'C1151100',
  'C1151200',
  'C1151300',
  'C1151400',
  'C1151600',
  'C1151700',
  'C1151800',
  'C1152000',
  'C1152100',
  'C1152200',
  'C1152300',
  'C1152400',
  'C1153000',
  'C1153100',
  'C1154100',
  'C1154200',
  'C1154300',
  'C1154400',
  'C1154500',
  'C1154700',
  'C1154800',
  'C1154900',
  'C1155000',
  'C1155100',
  'C1155200',
  'C1155300',
  'C1155400',
  'C1155500',
  'C1155600',
  'C1155700',
  'C1155800',
  'C1155900',
  'C1156000',
  'C1156100',
  'C1156300',
  'C1156400',
  'C1156500',
  'C1156600',
  'C1156700',
  'C1156800',
  'C1157000',
  'C1157100',
  'C1157200',
  'C1157300',
  'C1157500',
  'C1157600',
  'C1157700',
  'C1157800',
  'C1157900',
  'C1158000',
  'C1158100',
  'C1158200',
  'C1158300',
  'C1159400',
  'C1159500',
  'C1159600',
  'C1159700',
  'C1159800',
  'C1159900',
  'C1160000',
  'C1160100',
  'C1160200',
  'C1160300',
  'C1160400',
  'C1160500',
  'C1160600',
  'C1160700',
  'C1160800',
  'C1160900',
  'C1161000',
  'C1161100',
  'C1161200',
  'C1161400',
  'C1161500',
  'C1161600',
  'C1161700',
  'C1161800',
  'C1161900',
  'C1162100',
  'C1162200',
  'C1162300',
  'C1162400',
  'C1162600',
  'C1162700',
  'C1162800',
  'C1162900',
  'C1163000',
  'C1163100',
  'C1163200',
  'C1163300',
  'C1163400',
  'C1164500',
  'C1164600',
  'C1164700',
  'C1164800',
  'C1164900',
  'C1165000',
  'C1165100',
  'C1165200',
  'C1169400',
  'C1184100',
  'C1187000',
  'C1187100',
  'C1190600',
  'C1191000',
  'C1191400',
  'C1191800',
  'C1192500',
  'C1192600',
  'C1192700',
  'C1192800',
  'C1192900',
  'C1193000',
  'C1193100',
  'C1193200',
  'C1193300',
  'C1193400',
  'C1194100',
  'C1194200',
  'C1194300',
  'C1194400',
  'C1194500',
  'C1194600',
  'C1198300',
  'C1198400',
  'C1198600',
  'C1198900',
  'C1199200',
  'C1205800',
  'C1206100',
  'C1206200',
  'C1206400',
  'C1206500',
  'C1206600',
  'C1206800',
  'C1206900',
  'C1207000',
  'C1207100',
  'C1207200',
  'C1207300',
  'C1207400',
  'C1207500',
  'C1207600',
  'C1207700',
  'C1207800',
  'C1207900',
  'C1208000',
  'C1208100',
  'C1208400',
  'C1209700',
  'C1213900',
  'C1216900',
  'C1219700',
  'C1220200',
  'C1220300',
  'C1220500',
  'C1220600',
  'C1240300',
  'C1240700',
  'C1241100',
  'C1241300',
  'C1357000',
  'C1357200',
  'C1357800',
  'C1360100',
  'C1360200',
  'C1360300',
  'C1360400',
  'C1360500',
  'C1360600',
  'C1360700',
  'C1360800',
  'C1363500',
  'C1363600',
  'C1363700',
  'C1363800',
  'C1363900',
  'C1364000',
  'C1365300',
  'C1366100',
  'C1366200',
  'C1366300',
  'C1366400',
  'C1366500',
  'C1366700',
  'C1366800',
  'C1366900',
  'C1368100',
  'C1368400',
  'C1368500',
  'C1369000',
  'C1401300',
  'C1401400',
  'C1401900',
  'C1402000',
  'C1402100',
  'C1402200',
  'C1402400',
  'C1402500',
  'C1402600',
  'C1402800',
  'C1402900',
  'C1403000',
  'C1403100',
  'C1403200',
  'C1403300',
  'C1403400',
  'C1403500',
  'C1403600',
  'C1404200',
  'C1404300',
  'C1405300',
  'C1405400',
  'C1405500',
  'C1405600',
  'C1405700',
  'C1405900',
  'C1406000',
  'C1406100',
  'C1406200',
  'C1406300',
  'C1406400',
  'C1406500',
  'C1406600',
  'C1406700',
  'C1406800',
  'C1406900',
  'C1407000',
  'C1407100',
  'C1407200',
  'C1407300',
  'C1407400',
  'C1407500',
  'C1407600',
  'C1407700',
  'C1407900',
  'C1408000',
  'C1408100',
  'C1408200',
  'C1408300',
  'C1408400',
  'C1408600',
  'C1408700',
  'C1408800',
  'C1408900',
  'C1409100',
  'C1409200',
  'C1409300',
  'C1409400',
  'C1409500',
  'C1409600',
  'C1409700',
  'C1409800',
  'C1409900',
  'C1410000',
  'C1410100',
  'C1410200',
  'C1410300',
  'C1411400',
  'C1411500',
  'C1411600',
  'C1411700',
  'C1411800',
  'C1411900',
  'C1412000',
  'C1412100',
  'C1412200',
  'C1412300',
  'C1412400',
  'C1412500',
  'C1412600',
  'C1412700',
  'C1412800',
  'C1412900',
  'C1413000',
  'C1413100',
  'C1413200',
  'C1413400',
  'C1413500',
  'C1413600',
  'C1413700',
  'C1413800',
  'C1413900',
  'C1414100',
  'C1414200',
  'C1414300',
  'C1414400',
  'C1414600',
  'C1414700',
  'C1414800',
  'C1414900',
  'C1415000',
  'C1415100',
  'C1415200',
  'C1415300',
  'C1415400',
  'C1415500',
  'C1415600',
  'C1415700',
  'C1415800',
  'C1416900',
  'C1417000',
  'C1417100',
  'C1417200',
  'C1417300',
  'C1417400',
  'C1417500',
  'C1417600',
  'C1421800',
  'C1436500',
  'C1440700',
  'C1440800',
  'C1498400',
  'C1498800',
  'C1499200',
  'C1499600',
  'C1500300',
  'C1500400',
  'C1500500',
  'C1500600',
  'C1500700',
  'C1500800',
  'C1500900',
  'C1501000',
  'C1501100',
  'C1501200',
  'C1501900',
  'C1502000',
  'C1502100',
  'C1502200',
  'C1502300',
  'C1502400',
  'C1507300',
  'C1507400',
  'C1507600',
  'C1507900',
  'C1508200',
  'C1525800',
  'C1526100',
  'C1526200',
  'C1526400',
  'C1526401',
  'C1526402',
  'C1526403',
  'C1526404',
  'C1526405',
  'C1526406',
  'C1526407',
  'C1526408',
  'C1526409',
  'C1526410',
  'C1526411',
  'C1526412',
  'C1526413',
  'C1526414',
  'C1526415',
  'C1526416',
  'C1526417',
  'C1526700',
  'C1530100',
  'C1530200',
  'C1532200',
  'C1555300',
  'C1555700',
  'C1556100',
  'C1556500',
  'C1557200',
  'C1557300',
  'C1557400',
  'C1557500',
  'C1557600',
  'C1557700',
  'C1557800',
  'C1557900',
  'C1558000',
  'C1558100',
  'C1558800',
  'C1558900',
  'C1559000',
  'C1559100',
  'C1559200',
  'C1559300',
  'C1564200',
  'C1564300',
  'C1564500',
  'C1564800',
  'C1565100',
  'C1578300',
  'C1578500',
  'C1579100',
  'C1582300',
  'C1582400',
  'C1582500',
  'C1582600',
  'C1582700',
  'C1582800',
  'C1582900',
  'C1583000',
  'C1585600',
  'C1585700',
  'C1585800',
  'C1585900',
  'C1586000',
  'C1586100',
  'C1586800',
  'C1588400',
  'C1588500',
  'C1588600',
  'C1588700',
  'C1588800',
  'C1589000',
  'C1589100',
  'C1589200',
  'C1590400',
  'C1590700',
  'C1590800',
  'C1591300',
  'C1603000',
  'C1603100',
  'C1603600',
  'C1603700',
  'C1603800',
  'C1603900',
  'C1604100',
  'C1604200',
  'C1604300',
  'C1604400',
  'C1604500',
  'C1604600',
  'C1604800',
  'C1604900',
  'C1605000',
  'C1605100',
  'C1605200',
  'C1605800',
  'C1605900',
  'C1607000',
  'C1607100',
  'C1607200',
  'C1607300',
  'C1607400',
  'C1607600',
  'C1607700',
  'C1607800',
  'C1607900',
  'C1608000',
  'C1608100',
  'C1608200',
  'C1608300',
  'C1608400',
  'C1608500',
  'C1608600',
  'C1608700',
  'C1608800',
  'C1608900',
  'C1609000',
  'C1609100',
  'C1609200',
  'C1609300',
  'C1609500',
  'C1609600',
  'C1609700',
  'C1609800',
  'C1609900',
  'C1610000',
  'C1610200',
  'C1610300',
  'C1610400',
  'C1610600',
  'C1610700',
  'C1610800',
  'C1610900',
  'C1611000',
  'C1611100',
  'C1611200',
  'C1611300',
  'C1611400',
  'C1611500',
  'C1611600',
  'C1611700',
  'C1611800',
  'C1611900',
  'C1613000',
  'C1613100',
  'C1613200',
  'C1613300',
  'C1613400',
  'C1613500',
  'C1613600',
  'C1613700',
  'C1613800',
  'C1613900',
  'C1614000',
  'C1614100',
  'C1614200',
  'C1614300',
  'C1614400',
  'C1614500',
  'C1614600',
  'C1614700',
  'C1614800',
  'C1615000',
  'C1615100',
  'C1615200',
  'C1615300',
  'C1615400',
  'C1615500',
  'C1615700',
  'C1615800',
  'C1615900',
  'C1616100',
  'C1616200',
  'C1616300',
  'C1616400',
  'C1616500',
  'C1616600',
  'C1616700',
  'C1616800',
  'C1616900',
  'C1617000',
  'C1617100',
  'C1617200',
  'C1617300',
  'C1617400',
  'C1618500',
  'C1618600',
  'C1618700',
  'C1618800',
  'C1618900',
  'C1619000',
  'C1619100',
  'C1619200',
  'C1623400',
  'C1643100',
  'C1643200',
  'C1644400',
  'C1652200',
  'C1652600',
  'C1653000',
  'C1653200',
  'C1760003',
  'C1760008',
  'C1760010',
  'C1760019',
  'C1760030',
  'C1760031',
  'C1760032',
  'C1760033',
  'C1760046',
  'C1760054',
  'C1760055',
  'C1760059',
  'C1760062',
  'C1760081',
  'C1760082',
  'C1760086',
  'C1760089',
  'C1772100',
  'C1772400',
  'C1772500',
  'C1772700',
  'C1772701',
  'C1772702',
  'C1772703',
  'C1772704',
  'C1772705',
  'C1772706',
  'C1772707',
  'C1772708',
  'C1772709',
  'C1772710',
  'C1772711',
  'C1772712',
  'C1772713',
  'C1772714',
  'C1772715',
  'C1772716',
  'C1772717',
  'C1773000',
  'C1773600',
  'C1777000',
  'C1779000',
  'C1779300',
  'C1779400',
  'C1779600',
  'C1779700',
  'C1791000',
  'C1791400',
  'C1791800',
  'C1792200',
  'C1792900',
  'C1793000',
  'C1793100',
  'C1793200',
  'C1793300',
  'C1793400',
  'C1793500',
  'C1793600',
  'C1793700',
  'C1793800',
  'C1794500',
  'C1794600',
  'C1794700',
  'C1794800',
  'C1794900',
  'C1795000',
  'C1799600',
  'C1799700',
  'C1799900',
  'C1800200',
  'C1800500',
  'C1801400',
  'C1801800',
  'C1802200',
  'C1802400',
  'C1899900',
  'C1900400',
  'C1900600',
  'C1901500',
  'C1902600',
  'C1902700',
  'C1902800',
  'C1902900',
  'C1904200',
  'C1905000',
  'C1905100',
  'C1905500',
  'C1905800',
  'C1907700',
  'C1907800',
  'C1908200',
  'C1908500',
  'C1916900',
  'C1917100',
  'C1917700',
  'C1920600',
  'C1920700',
  'C1920800',
  'C1920900',
  'C1921000',
  'C1921100',
  'C1921200',
  'C1921300',
  'C1923900',
  'C1924000',
  'C1924100',
  'C1924200',
  'C1924300',
  'C1924400',
  'C1925600',
  'C1927300',
  'C1927400',
  'C1927500',
  'C1927600',
  'C1927700',
  'C1927900',
  'C1928000',
  'C1928100',
  'C1931000',
  'C1931300',
  'C1931400',
  'C1931900',
  'C1943500',
  'C1943600',
  'C1944100',
  'C1944200',
  'C1944400',
  'C1944800',
  'C1945000',
  'C1945100',
  'C1945200',
  'C1945300',
  'C1945500',
  'C1945600',
  'C1945700',
  'C1945800',
  'C1946400',
  'C1947600',
  'C1947700',
  'C1947800',
  'C1947900',
  'C1948000',
  'C1948400',
  'C1948500',
  'C1948600',
  'C1948700',
  'C1948800',
  'C1948900',
  'C1949000',
  'C1949100',
  'C1949200',
  'C1949300',
  'C1949400',
  'C1949500',
  'C1949600',
  'C1949700',
  'C1949800',
  'C1949900',
  'C1950000',
  'C1950200',
  'C1950300',
  'C1950400',
  'C1950500',
  'C1950600',
  'C1950700',
  'C1951200',
  'C1951400',
  'C1951500',
  'C1951600',
  'C1951700',
  'C1951800',
  'C1951900',
  'C1952000',
  'C1952100',
  'C1952200',
  'C1952300',
  'C1952400',
  'C1952500',
  'C1952600',
  'C1952700',
  'C1953800',
  'C1953900',
  'C1954000',
  'C1954100',
  'C1954200',
  'C1954300',
  'C1954400',
  'C1954500',
  'C1954600',
  'C1954700',
  'C1954800',
  'C1954900',
  'C1955000',
  'C1955100',
  'C1955200',
  'C1955300',
  'C1955400',
  'C1955500',
  'C1955600',
  'C1955800',
  'C1955900',
  'C1956100',
  'C1956200',
  'C1956300',
  'C1956800',
  'C1957000',
  'C1957100',
  'C1957200',
  'C1957300',
  'C1957400',
  'C1957500',
  'C1957600',
  'C1957700',
  'C1957800',
  'C1957900',
  'C1958000',
  'C1958100',
  'C1958200',
  'C1958300',
  'C1959400',
  'C1959500',
  'C1959600',
  'C1959700',
  'C1959800',
  'C1959900',
  'C1960000',
  'C1960100',
  'C1964300',
  'C1980500',
  'C1980600',
  'C1983500',
  'C1983600',
  'C1984800',
  'C1988000',
  'C1989000',
  'C2246400',
  'C2246500',
  'C2252800',
  'C2253900',
  'C2254200',
  'C2254300',
  'C2254600',
  'C2254601',
  'C2254602',
  'C2254603',
  'C2254604',
  'C2254605',
  'C2254606',
  'C2254607',
  'C2254608',
  'C2254609',
  'C2254610',
  'C2254611',
  'C2254612',
  'C2254613',
  'C2254614',
  'C2254615',
  'C2254616',
  'C2254617',
  'C2254900',
  'C2257800',
  'C2257900',
  'C2258000',
  'C2258100',
  'C2261200',
  'C2263300',
  'C2264200',
  'C2264300',
  'C2264800',
  'C2264900',
  'C2265100',
  'C2265300',
  'C2265500',
  'C2265700',
  'C2265800',
  'C2266000',
  'C2266200',
  'C2266400',
  'C2266500',
  'C2266600',
  'C2266700',
  'C2266800',
  'C2266900',
  'C2267400',
  'C2267600',
  'C2267900',
  'C2268000',
  'C2268100',
  'C2268200',
  'C2268400',
  'C2268600',
  'C2268800',
  'C2268900',
  'C2269000',
  'C2269200',
  'C2269400',
  'C2269500',
  'C2273900',
  'C2288500',
  'C2288600',
  'C2288800',
  'C2288900',
  'C2311300',
  'C2311700',
  'C2312100',
  'C2312300',
  'C2417100',
  'C2417200',
  'C2417300',
  'C2417400',
  'C2418000',
  'C2418100',
  'C2419300',
  'C2419400',
  'C2419500',
  'C2419600',
  'C2419700',
  'C2419900',
  'C2420100',
  'C2420200',
  'C2420300',
  'C2420400',
  'C2420500',
  'C2420600',
  'C2420700',
  'C2420800',
  'C2420900',
  'C2421000',
  'C2421100',
  'C2421200',
  'C2421300',
  'C2421400',
  'C2421500',
  'C2421600',
  'C2421700',
  'C2421800',
  'C2422000',
  'C2422100',
  'C2422200',
  'C2422300',
  'C2422400',
  'C2422500',
  'C2422700',
  'C2422900',
  'C2423000',
  'C2423100',
  'C2423300',
  'C2423400',
  'C2423500',
  'C2423600',
  'C2423700',
  'C2423800',
  'C2423900',
  'C2424000',
  'C2424100',
  'C2424200',
  'C2424300',
  'C2424400',
  'C2424500',
  'C2424600',
  'C2425900',
  'C2426000',
  'C2426100',
  'C2426200',
  'C2426300',
  'C2426400',
  'C2426500',
  'C2426600',
  'C2426700',
  'C2426800',
  'C2426900',
  'C2427000',
  'C2427100',
  'C2427200',
  'C2427300',
  'C2427400',
  'C2427500',
  'C2427600',
  'C2427700',
  'C2427900',
  'C2428000',
  'C2428100',
  'C2428200',
  'C2428300',
  'C2428400',
  'C2428600',
  'C2428800',
  'C2428900',
  'C2429000',
  'C2429200',
  'C2429300',
  'C2429400',
  'C2429500',
  'C2429600',
  'C2429700',
  'C2429800',
  'C2429900',
  'C2430000',
  'C2430100',
  'C2430200',
  'C2430300',
  'C2430400',
  'C2430500',
  'C2431800',
  'C2431900',
  'C2432000',
  'C2432100',
  'C2432200',
  'C2432300',
  'C2432400',
  'C2432500',
  'C2437100',
  'C2454900',
  'C2455100',
  'C2455800',
  'C2458700',
  'C2458800',
  'C2458900',
  'C2459000',
  'C2459100',
  'C2459200',
  'C2459300',
  'C2459400',
  'C2462200',
  'C2462300',
  'C2462400',
  'C2462500',
  'C2462600',
  'C2462700',
  'C2463900',
  'C2466000',
  'C2466100',
  'C2466200',
  'C2466300',
  'C2466400',
  'C2466600',
  'C2466700',
  'C2466800',
  'C2470200',
  'C2470500',
  'C2470600',
  'C2471100',
  'C2494000',
  'C2495000',
  'C2497400',
  'C2497900',
  'C2498400',
  'C2498900',
  'C2499400',
  'C2499900',
  'C2500500',
  'C2500600',
  'C2502000',
  'C2502100',
  'C2502200',
  'C2502300',
  'C2503500',
  'C2503800',
  'C2504100',
  'C2504700',
  'C2504800',
  'C2504900',
  'C2505000',
  'C2505100',
  'C2505200',
  'C2505300',
  'C2505400',
  'C2505500',
  'C2505600',
  'C2506300',
  'C2506800',
  'C2507000',
  'C2507900',
  'C2508900',
  'C2509000',
  'C2509100',
  'C2509200',
  'C2510600',
  'C2511400',
  'C2511500',
  'C2511900',
  'C2512100',
  'C2514100',
  'C2514200',
  'C2514600',
  'C2514900',
  'C2521800',
  'C2522800',
  'C2525900',
  'C2526400',
  'C2526900',
  'C2527400',
  'C2527900',
  'C2528400',
  'C2529000',
  'C2529100',
  'C2530500',
  'C2530600',
  'C2530700',
  'C2530800',
  'C2532000',
  'C2532300',
  'C2532600',
  'C2533200',
  'C2533300',
  'C2533400',
  'C2533500',
  'C2533600',
  'C2533700',
  'C2533800',
  'C2533900',
  'C2534600',
  'C2535100',
  'C2535300',
  'C2536200',
  'C2537300',
  'C2537400',
  'C2537500',
  'C2537600',
  'C2538900',
  'C2539600',
  'C2539700',
  'C2539800',
  'C2540200',
  'C2540500',
  'C2542300',
  'C2542400',
  'C2542500',
  'C2542900',
  'C2543200',
  'C2552000',
  'C2552100',
  'C2552200',
  'C2553200',
  'C2553210',
  'C2553220',
  'C2582200',
  'C2582600',
  'C2583000',
  'C2583200',
  'C2583800',
  'C2584200',
  'C2584600',
  'C2584800',
  'C2690000',
  'C2690100',
  'C2692400',
  'C2692700',
  'C2692800',
  'C2693700',
  'C2693800',
  'C2693900',
  'C2694000',
  'C2696500',
  'C2696600',
  'C2696700',
  'C2696800',
  'C2697700',
  'C2697800',
  'C2697900',
  'C2698000',
  'C2698100',
  'C2698200',
  'C2698300',
  'C2698400',
  'C2699700',
  'C2701606',
  'C2701706',
  'C2701806',
  'C2702200',
  'C2702300',
  'C2702400',
  'C2702800',
  'C2702900',
  'C2703000',
  'C2705006',
  'C2705106',
  'C2705206',
  'C2706600',
  'C2709000',
  'C2709100',
  'C2709600',
  'C2709700',
  'C2709900',
  'C2710100',
  'C2710300',
  'C2710500',
  'C2710600',
  'C2710800',
  'C2711000',
  'C2711200',
  'C2711300',
  'C2711400',
  'C2711500',
  'C2711600',
  'C2711700',
  'C2712200',
  'C2712400',
  'C2712700',
  'C2712800',
  'C2712900',
  'C2713000',
  'C2713200',
  'C2713400',
  'C2713600',
  'C2713700',
  'C2713800',
  'C2714000',
  'C2714200',
  'C2714300',
  'C2714400',
  'C2714500',
  'C2714600',
  'C2714700',
  'C2714800',
  'C2714900',
  'C2715000',
  'C2715100',
  'C2715200',
  'C2715300',
  'C2715400',
  'C2715500',
  'C2715600',
  'C2715700',
  'C2715800',
  'C2715900',
  'C2716000',
  'C2716200',
  'C2716400',
  'C2716600',
  'C2716700',
  'C2716800',
  'C2717100',
  'C2717300',
  'C2717500',
  'C2717700',
  'C2717701',
  'C2717702',
  'C2717703',
  'C2717704',
  'C2717705',
  'C2717706',
  'C2717707',
  'C2717708',
  'C2717709',
  'C2718900',
  'C2719000',
  'C2719100',
  'C2719200',
  'C2719300',
  'C2719400',
  'C2719500',
  'C2719600',
  'C2719700',
  'C2719800',
  'C2719900',
  'C2720000',
  'C2720100',
  'C2720200',
  'C2720300',
  'C2720400',
  'C2720500',
  'C2720600',
  'C2720700',
  'C2720800',
  'C2720900',
  'C2721000',
  'C2721100',
  'C2721200',
  'C2721300',
  'C2721500',
  'C2721800',
  'C2721900',
  'C2722000',
  'C2722100',
  'C2722400',
  'C2722600',
  'C2722800',
  'C2723000',
  'C2723001',
  'C2723002',
  'C2723003',
  'C2723004',
  'C2723005',
  'C2723006',
  'C2723007',
  'C2723008',
  'C2723009',
  'C2724200',
  'C2724300',
  'C2724400',
  'C2724500',
  'C2724600',
  'C2724700',
  'C2724800',
  'C2724900',
  'C2727800',
  'C2736400',
  'C2741600',
  'C2742920',
  'C2742921',
  'C2742922',
  'C2742923',
  'C2751403',
  'C2753100',
  'C2755600',
  'C2756600',
  'C2760000',
  'C2760100',
  'C2760200',
  'C2760300',
  'C2760400',
  'C2760500',
  'C2760600',
  'C2760700',
  'C2763500',
  'C2763600',
  'C2763700',
  'C2763800',
  'C2763900',
  'C2764000',
  'C2765300',
  'C2765700',
  'C2765800',
  'C2765900',
  'C2766000',
  'C2766100',
  'C2766300',
  'C2766400',
  'C2766500',
  'C2768000',
  'C2768300',
  'C2768400',
  'C2768900',
  'C2792300',
  'C2793300',
  'C2793800',
  'C2793900',
  'C2794000',
  'C2797200',
  'C2797700',
  'C2798200',
  'C2798700',
  'C2799200',
  'C2799700',
  'C2800300',
  'C2800400',
  'C2801800',
  'C2801900',
  'C2802000',
  'C2802100',
  'C2802800',
  'C2803100',
  'C2803400',
  'C2804000',
  'C2804100',
  'C2804200',
  'C2804900',
  'C2805400',
  'C2805600',
  'C2806500',
  'C2807600',
  'C2807700',
  'C2807800',
  'C2807900',
  'C2809200',
  'C2809900',
  'C2810000',
  'C2810100',
  'C2810500',
  'C2810800',
  'C2812600',
  'C2812700',
  'C2812800',
  'C2813200',
  'C2813500',
  'C2820600',
  'C2820700',
  'C2820800',
  'C2821700',
  'C2821800',
  'C2821900',
  'C2854000',
  'C2854400',
  'C2854800',
  'C2855000',
  'C2971400',
  'C2971500',
  'C2973400',
  'C2973700',
  'C2973800',
  'C2974600',
  'C2974700',
  'C2974800',
  'C2976800',
  'C2976900',
  'C2977000',
  'C2977700',
  'C2977800',
  'C2977900',
  'C2978000',
  'C2978100',
  'C2978200',
  'C2978900',
  'C2980306',
  'C2980406',
  'C2980506',
  'C2980900',
  'C2981000',
  'C2981100',
  'C2982506',
  'C2982606',
  'C2983400',
  'C2985600',
  'C2985700',
  'C2986200',
  'C2986300',
  'C2986400',
  'C2986700',
  'C2986900',
  'C2987000',
  'C2987100',
  'C2987300',
  'C2987500',
  'C2987700',
  'C2987800',
  'C2987900',
  'C2988000',
  'C2988100',
  'C2988600',
  'C2988700',
  'C2989100',
  'C2989200',
  'C2989300',
  'C2989400',
  'C2989600',
  'C2989800',
  'C2989900',
  'C2990000',
  'C2990100',
  'C2990300',
  'C2990500',
  'C2990600',
  'C2990700',
  'C2990800',
  'C2990900',
  'C2991000',
  'C2991100',
  'C2991200',
  'C2991300',
  'C2991400',
  'C2991500',
  'C2991600',
  'C2991700',
  'C2991800',
  'C2991900',
  'C2992000',
  'C2992100',
  'C2992200',
  'C2992300',
  'C2992500',
  'C2992700',
  'C2992800',
  'C2992900',
  'C2993000',
  'C2993200',
  'C2993400',
  'C2993600',
  'C2993800',
  'C2993801',
  'C2993802',
  'C2993803',
  'C2993804',
  'C2993805',
  'C2993806',
  'C2993807',
  'C2993808',
  'C2993809',
  'C2995000',
  'C2995100',
  'C2995200',
  'C2995300',
  'C2995400',
  'C2995500',
  'C2995600',
  'C2995700',
  'C2995800',
  'C2995900',
  'C2996000',
  'C2996100',
  'C2996200',
  'C2996300',
  'C2996400',
  'C2996500',
  'C2996600',
  'C2996700',
  'C2996800',
  'C2996900',
  'C2997000',
  'C2997100',
  'C2997200',
  'C2997300',
  'C2997400',
  'C2997600',
  'C2997800',
  'C2997900',
  'C2998000',
  'C2998100',
  'C2998300',
  'C2998500',
  'C2998700',
  'C2998900',
  'C2998901',
  'C2998902',
  'C2998903',
  'C2998904',
  'C2998905',
  'C2998906',
  'C2998907',
  'C2998908',
  'C2998909',
  'C3000100',
  'C3000200',
  'C3000300',
  'C3000400',
  'C3000500',
  'C3000600',
  'C3000700',
  'C3000800',
  'C3002600',
  'C3008800',
  'C3013700',
  'C3030903',
  'C3032800',
  'C3035000',
  'C3036000',
  'C3039400',
  'C3039500',
  'C3039600',
  'C3039700',
  'C3039800',
  'C3039900',
  'C3040000',
  'C3040100',
  'C3043100',
  'C3043200',
  'C3043300',
  'C3043400',
  'C3043500',
  'C3043600',
  'C3044900',
  'C3045400',
  'C3045500',
  'C3045600',
  'C3045700',
  'C3045800',
  'C3046000',
  'C3046100',
  'C3046200',
  'C3047900',
  'C3048200',
  'C3048300',
  'C3048800',
  'C3101800',
  'C3102800',
  'C3105200',
  'C3105700',
  'C3106200',
  'C3106700',
  'C3107200',
  'C3107700',
  'C3108300',
  'C3108400',
  'C3109800',
  'C3109900',
  'C3110000',
  'C3110100',
  'C3111300',
  'C3111600',
  'C3111900',
  'C3112500',
  'C3112600',
  'C3112700',
  'C3114200',
  'C3114700',
  'C3114900',
  'C3115000',
  'C3116100',
  'C3116200',
  'C3116300',
  'C3116400',
  'C3117700',
  'C3118500',
  'C3118600',
  'C3119000',
  'C3119300',
  'C3121200',
  'C3121300',
  'C3121700',
  'C3122000',
  'C3130100',
  'C3130200',
  'C3130300',
  'C3131200',
  'C3131300',
  'C3131400',
  'C3137800',
  'C3138200',
  'C3138600',
  'C3138800',
  'C3356203',
  'C3358100',
  'C3360200',
  'C3361200',
  'C3363500',
  'C3363600',
  'C3363700',
  'C3363800',
  'C3363900',
  'C3364000',
  'C3364100',
  'C3364200',
  'C3364700',
  'C3364800',
  'C3364900',
  'C3365000',
  'C3365100',
  'C3365200',
  'C3365400',
  'C3365500',
  'C3365700',
  'C3365900',
  'C3366200',
  'C3366300',
  'C3366400',
  'C3366500',
  'C3366600',
  'C3366800',
  'C3366900',
  'C3367000',
  'C3368601',
  'C3368604',
  'C3368605',
  'C3369100',
  'C3388100',
  'C3388200',
  'C3388700',
  'C3388800',
  'C3388900',
  'C3389200',
  'C3389400',
  'C3389500',
  'C3389600',
  'C3389800',
  'C3390000',
  'C3390200',
  'C3390300',
  'C3390400',
  'C3390500',
  'C3390600',
  'C3391100',
  'C3391200',
  'C3391600',
  'C3391700',
  'C3391800',
  'C3391900',
  'C3392100',
  'C3392300',
  'C3392400',
  'C3392500',
  'C3392600',
  'C3392800',
  'C3393000',
  'C3393100',
  'C3393200',
  'C3393300',
  'C3393400',
  'C3393500',
  'C3393600',
  'C3393700',
  'C3393800',
  'C3393900',
  'C3394000',
  'C3394100',
  'C3394200',
  'C3394400',
  'C3394500',
  'C3394600',
  'C3394700',
  'C3394800',
  'C3395000',
  'C3395200',
  'C3395300',
  'C3395400',
  'C3395500',
  'C3395700',
  'C3395900',
  'C3396100',
  'C3396300',
  'C3396301',
  'C3396302',
  'C3396303',
  'C3396304',
  'C3396305',
  'C3396306',
  'C3396307',
  'C3396308',
  'C3396309',
  'C3397500',
  'C3397600',
  'C3397700',
  'C3397800',
  'C3397900',
  'C3398000',
  'C3398100',
  'C3398200',
  'C3398300',
  'C3398400',
  'C3398500',
  'C3398600',
  'C3398700',
  'C3398800',
  'C3398900',
  'C3399000',
  'C3399100',
  'C3399200',
  'C3399300',
  'C3399500',
  'C3399600',
  'C3399700',
  'C3399800',
  'C3399900',
  'C3400100',
  'C3400300',
  'C3400400',
  'C3400500',
  'C3400600',
  'C3400800',
  'C3401000',
  'C3401200',
  'C3401400',
  'C3401401',
  'C3401402',
  'C3401403',
  'C3401404',
  'C3401405',
  'C3401406',
  'C3401407',
  'C3401408',
  'C3401409',
  'C3402600',
  'C3402700',
  'C3402800',
  'C3402900',
  'C3403000',
  'C3403100',
  'C3403200',
  'C3403300',
  'C3407900',
  'C3551200',
  'C3551300',
  'C3553100',
  'C3553200',
  'C3553300',
  'C3554200',
  'C3555300',
  'C3555600',
  'C3555700',
  'C3557700',
  'C3557800',
  'C3557900',
  'C3558000',
  'C3558100',
  'C3558200',
  'C3558300',
  'C3558400',
  'C3558500',
  'C3563500',
  'C3563600',
  'C3563700',
  'C3563800',
  'C3563900',
  'C3564000',
  'C3564100',
  'C3564200',
  'C3564300',
  'C3566200',
  'C3566300',
  'C3566400',
  'C3566500',
  'C3566600',
  'C3566700',
  'C3566800',
  'C3566900',
  'C3567000',
  'C3567100',
  'C3567200',
  'C3567300',
  'C3567400',
  'C3567500',
  'C3567600',
  'C3567700',
  'C3567800',
  'C3567900',
  'C3569800',
  'C3571606',
  'C3571706',
  'C3571806',
  'C3571906',
  'C3572400',
  'C3572500',
  'C3572600',
  'C3572700',
  'C3573806',
  'C3574300',
  'C3579000',
  'C3580400',
  'C3604100',
  'C3605100',
  'C3608900',
  'C3609400',
  'C3609900',
  'C3610400',
  'C3610900',
  'C3611400',
  'C3612000',
  'C3612100',
  'C3613500',
  'C3613600',
  'C3613700',
  'C3613800',
  'C3615000',
  'C3615300',
  'C3615600',
  'C3616200',
  'C3616300',
  'C3616400',
  'C3616500',
  'C3616600',
  'C3616700',
  'C3616800',
  'C3616900',
  'C3618400',
  'C3618900',
  'C3619100',
  'C3619200',
  'C3620300',
  'C3620400',
  'C3620500',
  'C3620600',
  'C3621900',
  'C3622700',
  'C3622800',
  'C3623200',
  'C3623500',
  'C3625400',
  'C3625500',
  'C3625900',
  'C3626200',
  'C3634200',
  'C3634300',
  'C3634400',
  'C3635200',
  'C3641500',
  'C3641900',
  'C3642300',
  'C3642500',
  'C3859903',
  'C3861800',
  'C3863900',
  'C3864900',
  'C3867200',
  'C3867300',
  'C3867400',
  'C3867500',
  'C3867600',
  'C3867700',
  'C3867800',
  'C3867900',
  'C3868400',
  'C3868500',
  'C3868600',
  'C3868700',
  'C3868800',
  'C3868900',
  'C3869100',
  'C3869200',
  'C3869400',
  'C3869600',
  'C3869900',
  'C3870000',
  'C3870100',
  'C3870200',
  'C3870300',
  'C3870500',
  'C3870600',
  'C3870700',
  'C3872301',
  'C3872304',
  'C3872305',
  'C3872800',
  'C3895800',
  'C3895900',
  'C3897700',
  'C3897800',
  'C3897900',
  'C3898800',
  'C3900200',
  'C3900500',
  'C3900600',
  'C3901600',
  'C3901700',
  'C3901800',
  'C3901900',
  'C3904400',
  'C3904500',
  'C3904600',
  'C3904700',
  'C3905600',
  'C3905700',
  'C3905800',
  'C3905900',
  'C3906000',
  'C3906100',
  'C3906200',
  'C3906300',
  'C3907200',
  'C3908606',
  'C3908706',
  'C3908806',
  'C3909200',
  'C3909300',
  'C3909400',
  'C3910806',
  'C3910906',
  'C3911700',
  'C3913900',
  'C3914000',
  'C3914500',
  'C3914600',
  'C3914700',
  'C3915000',
  'C3915200',
  'C3915300',
  'C3915400',
  'C3915600',
  'C3915800',
  'C3916100',
  'C3916200',
  'C3916300',
  'C3916400',
  'C3916500',
  'C3917000',
  'C3917100',
  'C3917500',
  'C3917600',
  'C3917700',
  'C3917800',
  'C3918000',
  'C3918200',
  'C3918300',
  'C3918400',
  'C3918500',
  'C3918700',
  'C3918900',
  'C3919000',
  'C3919100',
  'C3919200',
  'C3919300',
  'C3919400',
  'C3919500',
  'C3919600',
  'C3919700',
  'C3919800',
  'C3919900',
  'C3920000',
  'C3920100',
  'C3920300',
  'C3920400',
  'C3920500',
  'C3920600',
  'C3920700',
  'C3920900',
  'C3921100',
  'C3921200',
  'C3921300',
  'C3921400',
  'C3921600',
  'C3921800',
  'C3922000',
  'C3922200',
  'C3922201',
  'C3922202',
  'C3922203',
  'C3922204',
  'C3922205',
  'C3922206',
  'C3922207',
  'C3922208',
  'C3922209',
  'C3923400',
  'C3923500',
  'C3923600',
  'C3923700',
  'C3923800',
  'C3923900',
  'C3924000',
  'C3924100',
  'C3924200',
  'C3924300',
  'C3924400',
  'C3924500',
  'C3924600',
  'C3924700',
  'C3924800',
  'C3924900',
  'C3925000',
  'C3925100',
  'C3925200',
  'C3925400',
  'C3925500',
  'C3925600',
  'C3925700',
  'C3925800',
  'C3926000',
  'C3926200',
  'C3926300',
  'C3926400',
  'C3926500',
  'C3926700',
  'C3926900',
  'C3927100',
  'C3927300',
  'C3927301',
  'C3927302',
  'C3927303',
  'C3927304',
  'C3927305',
  'C3927306',
  'C3927307',
  'C3927308',
  'C3927309',
  'C3928500',
  'C3928600',
  'C3928700',
  'C3928800',
  'C3928900',
  'C3929000',
  'C3929100',
  'C3929200',
  'C3933800',
  'C3951500',
  'C3952900',
  'C3953400',
  'C3953500',
  'C3984100',
  'C3985100',
  'C3987500',
  'C3988000',
  'C3988500',
  'C3989000',
  'C3989500',
  'C3990000',
  'C3990600',
  'C3990700',
  'C3992100',
  'C3992200',
  'C3992300',
  'C3992400',
  'C3993600',
  'C3993900',
  'C3994200',
  'C3994800',
  'C3994900',
  'C3995000',
  'C3995100',
  'C3995200',
  'C3995300',
  'C3995400',
  'C3995500',
  'C3995600',
  'C3995700',
  'C3997200',
  'C3997700',
  'C3997900',
  'C3998000',
  'C3999100',
  'C3999200',
  'C3999300',
  'C3999400',
  'C4000700',
  'C4001500',
  'C4001600',
  'C4002000',
  'C4002300',
  'C4004200',
  'C4004300',
  'C4004700',
  'C4005000',
  'C4012700',
  'C4012800',
  'C4012900',
  'C4013700',
  'C4013800',
  'C4013900',
  'C4020000',
  'C4020400',
  'C4020800',
  'C4021000',
  'C5108103',
  'C5110000',
  'C5112100',
  'C5113100',
  'C5115400',
  'C5115500',
  'C5115600',
  'C5115700',
  'C5115800',
  'C5115900',
  'C5116000',
  'C5116100',
  'C5116600',
  'C5116700',
  'C5116800',
  'C5116900',
  'C5117000',
  'C5117100',
  'C5117300',
  'C5117400',
  'C5117600',
  'C5117800',
  'C5118100',
  'C5118200',
  'C5118300',
  'C5118400',
  'C5118500',
  'C5118700',
  'C5118800',
  'C5118900',
  'C5120501',
  'C5120504',
  'C5120505',
  'C5121000',
  'C5144800',
  'C5144900',
  'C5147600',
  'C5147700',
  'C5147800',
  'C5148700',
  'C5150000',
  'C5150300',
  'C5150400',
  'C5151200',
  'C5151300',
  'C5151400',
  'C5153400',
  'C5153500',
  'C5153600',
  'C5154300',
  'C5154400',
  'C5154500',
  'C5154600',
  'C5154700',
  'C5154800',
  'C5157400',
  'C5158806',
  'C5158906',
  'C5159006',
  'C5159400',
  'C5159500',
  'C5159600',
  'C5161406',
  'C5161506',
  'C5161606',
  'C5162700',
  'C5165400',
  'C5165500',
  'C5166000',
  'C5166100',
  'C5166200',
  'C5166500',
  'C5166600',
  'C5166700',
  'C5166900',
  'C5167100',
  'C5167300',
  'C5167400',
  'C5167500',
  'C5167600',
  'C5167700',
  'C5168200',
  'C5168300',
  'C5168700',
  'C5168800',
  'C5168900',
  'C5169000',
  'C5169200',
  'C5169400',
  'C5169500',
  'C5169600',
  'C5169700',
  'C5169900',
  'C5170100',
  'C5170200',
  'C5170300',
  'C5170400',
  'C5170500',
  'C5170600',
  'C5170700',
  'C5170800',
  'C5170900',
  'C5171000',
  'C5171100',
  'C5171200',
  'C5171300',
  'C5171500',
  'C5171600',
  'C5171700',
  'C5171800',
  'C5171900',
  'C5172100',
  'C5172300',
  'C5172400',
  'C5172500',
  'C5172600',
  'C5172800',
  'C5173000',
  'C5173200',
  'C5173400',
  'C5173401',
  'C5173402',
  'C5173403',
  'C5173404',
  'C5173405',
  'C5173406',
  'C5173407',
  'C5173408',
  'C5173409',
  'C5174600',
  'C5174700',
  'C5174800',
  'C5174900',
  'C5175000',
  'C5175100',
  'C5175200',
  'C5175300',
  'C5175400',
  'C5175500',
  'C5175600',
  'C5175700',
  'C5175800',
  'C5175900',
  'C5176000',
  'C5176100',
  'C5176200',
  'C5176300',
  'C5176400',
  'C5176600',
  'C5176700',
  'C5176800',
  'C5176900',
  'C5177000',
  'C5177200',
  'C5177400',
  'C5177500',
  'C5177600',
  'C5177700',
  'C5177900',
  'C5178100',
  'C5178300',
  'C5178500',
  'C5178501',
  'C5178502',
  'C5178503',
  'C5178504',
  'C5178505',
  'C5178506',
  'C5178507',
  'C5178508',
  'C5178509',
  'C5179700',
  'C5179800',
  'C5179900',
  'C5180000',
  'C5180100',
  'C5180200',
  'C5180300',
  'C5180400',
  'C5183900',
  'C5195600',
  'C5197000',
  'C5528000',
  'C5529000',
  'C5531500',
  'C5532000',
  'C5532500',
  'C5533000',
  'C5533500',
  'C5534000',
  'C5534600',
  'C5534700',
  'C5536100',
  'C5536200',
  'C5536300',
  'C5536400',
  'C5537600',
  'C5537900',
  'C5538200',
  'C5538800',
  'C5538900',
  'C5539000',
  'C5539100',
  'C5539200',
  'C5539300',
  'C5539400',
  'C5539500',
  'C5541000',
  'C5541500',
  'C5541700',
  'C5541800',
  'C5542900',
  'C5543000',
  'C5543100',
  'C5543200',
  'C5544500',
  'C5545300',
  'C5545400',
  'C5545800',
  'C5546100',
  'C5548000',
  'C5548100',
  'C5548500',
  'C5548800',
  'C5556700',
  'C5556800',
  'C5556900',
  'C5557700',
  'C5557800',
  'C5557900',
  'C5564100',
  'C5564500',
  'C5564900',
  'C5565100',
  'C5685403',
  'C5687300',
  'C5689400',
  'C5690400',
  'C5692700',
  'C5692800',
  'C5692900',
  'C5693000',
  'C5693100',
  'C5693200',
  'C5693300',
  'C5693400',
  'C5693900',
  'C5694000',
  'C5694100',
  'C5694200',
  'C5694300',
  'C5694400',
  'C5694600',
  'C5694700',
  'C5694900',
  'C5695100',
  'C5695600',
  'C5695700',
  'C5695800',
  'C5695900',
  'C5696000',
  'C5696200',
  'C5696300',
  'C5696400',
  'C5698001',
  'C5698004',
  'C5698005',
  'C5698500',
  'C5722100',
  'C5722200',
  'C5724900',
  'C5725000',
  'C5725100',
  'C5725900',
  'C5727100',
  'C5727400',
  'C5727500',
  'C5728300',
  'C5728400',
  'C5728500',
  'C5730500',
  'C5730600',
  'C5730700',
  'C5731400',
  'C5731500',
  'C5731600',
  'C5731700',
  'C5731800',
  'C5731900',
  'C5734400',
  'C5736206',
  'C5736306',
  'C5736406',
  'C5736506',
  'C5737000',
  'C5737100',
  'C5737200',
  'C5737300',
  'C5738406',
  'C5738900',
  'C5741600',
  'C5741700',
  'C5742200',
  'C5742300',
  'C5742400',
  'C5742700',
  'C5742900',
  'C5743000',
  'C5743100',
  'C5743300',
  'C5743500',
  'C5743800',
  'C5743900',
  'C5744000',
  'C5744100',
  'C5744200',
  'C5744700',
  'C5744800',
  'C5745200',
  'C5745300',
  'C5745400',
  'C5745500',
  'C5745700',
  'C5745900',
  'C5746000',
  'C5746100',
  'C5746200',
  'C5746400',
  'C5746600',
  'C5746700',
  'C5746800',
  'C5746900',
  'C5747000',
  'C5747100',
  'C5747200',
  'C5747300',
  'C5747400',
  'C5747500',
  'C5747600',
  'C5747700',
  'C5747800',
  'C5748000',
  'C5748100',
  'C5748200',
  'C5748300',
  'C5748400',
  'C5748600',
  'C5748800',
  'C5748900',
  'C5749000',
  'C5749100',
  'C5749300',
  'C5749500',
  'C5749700',
  'C5749900',
  'C5749901',
  'C5749902',
  'C5749903',
  'C5749904',
  'C5749905',
  'C5749906',
  'C5749907',
  'C5749908',
  'C5749909',
  'C5751100',
  'C5751200',
  'C5751300',
  'C5751400',
  'C5751500',
  'C5751600',
  'C5751700',
  'C5751800',
  'C5751900',
  'C5752000',
  'C5752100',
  'C5752200',
  'C5752300',
  'C5752400',
  'C5752500',
  'C5752600',
  'C5752700',
  'C5752800',
  'C5752900',
  'C5753100',
  'C5753200',
  'C5753300',
  'C5753400',
  'C5753500',
  'C5753700',
  'C5753900',
  'C5754000',
  'C5754100',
  'C5754200',
  'C5754400',
  'C5754600',
  'C5754800',
  'C5755000',
  'C5755001',
  'C5755002',
  'C5755003',
  'C5755004',
  'C5755005',
  'C5755006',
  'C5755007',
  'C5755008',
  'C5755009',
  'C5756200',
  'C5756300',
  'C5756400',
  'C5756500',
  'C5756600',
  'C5756700',
  'C5756800',
  'C5756900',
  'C5759800',
  'C5770500',
  'C5771900',
  'C5804300',
  'C5805300',
  'C5807700',
  'C5808200',
  'C5808700',
  'C5809200',
  'C5809700',
  'C5810200',
  'C5810800',
  'C5810900',
  'C5812000',
  'C5812100',
  'C5812200',
  'C5813400',
  'C5813700',
  'C5814000',
  'C5814600',
  'C5814700',
  'C5814800',
  'C5816100',
  'C5817200',
  'C5817300',
  'C5817400',
  'C5817500',
  'C5818800',
  'C5819600',
  'C5819700',
  'C5820100',
  'C5820400',
  'C5822300',
  'C5822400',
  'C5822800',
  'C5823100',
  'C5830700',
  'C5830800',
  'C5830900',
  'C5831700',
  'C5831800',
  'C5831900',
  'C5837600',
  'C5838000',
  'C5838400',
  'C5838600',
  'C5957303',
  'C5959200',
  'C5961300',
  'C5962300',
  'C5964600',
  'C5964700',
  'C5964800',
  'C5964900',
  'C5965000',
  'C5965100',
  'C5965200',
  'C5965300',
  'C5965800',
  'C5965900',
  'C5966000',
  'C5966100',
  'C5966200',
  'C5966300',
  'C5966500',
  'C5966600',
  'C5966800',
  'C5967000',
  'C5967500',
  'C5967600',
  'C5967700',
  'C5967800',
  'C5967900',
  'C5968100',
  'C5968200',
  'C5968300',
  'C5969901',
  'C5969904',
  'C5969905',
  'C5970400',
  'C5993800',
  'C5993900',
  'C5996600',
  'C5996700',
  'C5996800',
  'C5997600',
  'C5998600',
  'C5998900',
  'C5999000',
  'C6000000',
  'C6000100',
  'C6000200',
  'C6000300',
  'C6002800',
  'C6002900',
  'C6003000',
  'C6003100',
  'C6004000',
  'C6004100',
  'C6004200',
  'C6004300',
  'C6004400',
  'C6004500',
  'C6004600',
  'C6004700',
  'C6007500',
  'C6008906',
  'C6009006',
  'C6009106',
  'C6009500',
  'C6009600',
  'C6009700',
  'C6010706',
  'C6011200',
  'C6013800',
  'C6013900',
  'C6014000',
  'C6014100',
  'C6014600',
  'C6014700',
  'C6015100',
  'C6015200',
  'C6015300',
  'C6015400',
  'C6015600',
  'C6015800',
  'C6015900',
  'C6016000',
  'C6016100',
  'C6016300',
  'C6016500',
  'C6016600',
  'C6016700',
  'C6016800',
  'C6016900',
  'C6017000',
  'C6017100',
  'C6017200',
  'C6017300',
  'C6017400',
  'C6017500',
  'C6017600',
  'C6017700',
  'C6017900',
  'C6018000',
  'C6018100',
  'C6018200',
  'C6018300',
  'C6018500',
  'C6018700',
  'C6018800',
  'C6018900',
  'C6019000',
  'C6019200',
  'C6019400',
  'C6019600',
  'C6019800',
  'C6019801',
  'C6019802',
  'C6019803',
  'C6019804',
  'C6019805',
  'C6019806',
  'C6019807',
  'C6019808',
  'C6019809',
  'C6021000',
  'C6021100',
  'C6021200',
  'C6021300',
  'C6021400',
  'C6021500',
  'C6021600',
  'C6021700',
  'C6021800',
  'C6021900',
  'C6022000',
  'C6022100',
  'C6022200',
  'C6022300',
  'C6022400',
  'C6022500',
  'C6022600',
  'C6022700',
  'C6022800',
  'C6023000',
  'C6023100',
  'C6023200',
  'C6023300',
  'C6023400',
  'C6023600',
  'C6023800',
  'C6023900',
  'C6024000',
  'C6024100',
  'C6024300',
  'C6024500',
  'C6024700',
  'C6024900',
  'C6024901',
  'C6024902',
  'C6024903',
  'C6024904',
  'C6024905',
  'C6024906',
  'C6024907',
  'C6024908',
  'C6024909',
  'C6026100',
  'C6026200',
  'C6026300',
  'C6026400',
  'C6026500',
  'C6026600',
  'C6026700',
  'C6026800',
  'C6028600',
  'C6037300',
  'C6038700',
  'C6053500',
  'C6054000',
  'C6054500',
  'C6055000',
  'C6055500',
  'C6056000',
  'C6057000',
  'C6057100',
  'C6068700',
  'C6068800',
  'C6071100',
  'C6071200',
  'C6071300',
  'C6071900',
  'C6072800',
  'C6073100',
  'C6073200',
  'C6073800',
  'C6073900',
  'C6075300',
  'C6075400',
  'C6075900',
  'C6076000',
  'C6076100',
  'C6076200',
  'C6076800',
  'C6077406',
  'C6077600',
  'C6078306',
  'C6078700',
  'C6080900',
  'C6081000',
  'C6081500',
  'C6081600',
  'C6081700',
  'C6082000',
  'C6082200',
  'C6082400',
  'C6082500',
  'C6082600',
  'C6082700',
  'C6082800',
  'C6083300',
  'C6083400',
  'C6083800',
  'C6083900',
  'C6084000',
  'C6084100',
  'C6084300',
  'C6084500',
  'C6084600',
  'C6084700',
  'C6084800',
  'C6085000',
  'C6085200',
  'C6085300',
  'C6085400',
  'C6085500',
  'C6085600',
  'C6085700',
  'C6085800',
  'C6085900',
  'C6086000',
  'C6086100',
  'C6086200',
  'C6086300',
  'C6086400',
  'C6086600',
  'C6086700',
  'C6086800',
  'C6086900',
  'C6087000',
  'C6087200',
  'C6087400',
  'C6087500',
  'C6087600',
  'C6087700',
  'C6087900',
  'C6088100',
  'C6088400',
  'C6088401',
  'C6088402',
  'C6088403',
  'C6088404',
  'C6088405',
  'C6088406',
  'C6088407',
  'C6088408',
  'C6088409',
  'C6089600',
  'C6089700',
  'C6089800',
  'C6089900',
  'C6090000',
  'C6090100',
  'C6090200',
  'C6090300',
  'C6090400',
  'C6090500',
  'C6090600',
  'C6090700',
  'C6090800',
  'C6090900',
  'C6091000',
  'C6091100',
  'C6091200',
  'C6091300',
  'C6091400',
  'C6091600',
  'C6091700',
  'C6091800',
  'C6091900',
  'C6092000',
  'C6092200',
  'C6092400',
  'C6092500',
  'C6092600',
  'C6092700',
  'C6092900',
  'C6093100',
  'C6093300',
  'C6093500',
  'C6093501',
  'C6093502',
  'C6093503',
  'C6093504',
  'C6093505',
  'C6093506',
  'C6093507',
  'C6093508',
  'C6093509',
  'C6094700',
  'C6094800',
  'C6094900',
  'C6095000',
  'C6095100',
  'C6095200',
  'C6095300',
  'C6095400',
  'C6097000',
  'C6104500',
  'C6105700',
  'S0043500',
  'S0043600',
  'S0043700',
  'S0062900',
  'S0063000',
  'S0063100',
  'Y0000100',
  'Y0029400',
  'Y0031300',
  'Y0032400',
  'Y0032800',
  'Y0033000',
  'Y0033200',
  'Y0041600',
  'Y0199300',
  'Y0199400',
  'Y0199500',
  'Y0199600',
  'Y0199700',
  'Y0199800',
  'Y0200200',
  'Y0200400',
  'Y0201200',
  'Y0201500',
  'Y0201600',
  'Y0217100',
  'Y0217200',
  'Y0217300',
  'Y0217400',
  'Y0217500',
  'Y0217900',
  'Y0218100',
  'Y0219100',
  'Y0219200',
  'Y0230500',
  'Y0230600',
  'Y0230700',
  'Y0230800',
  'Y0231200',
  'Y0231400',
  'Y0232400',
  'Y0247300',
  'Y0247400',
  'Y0247500',
  'Y0247600',
  'Y0248000',
  'Y0248200',
  'Y0249200',
  'Y0260000',
  'Y0260100',
  'Y0260200',
  'Y0260300',
  'Y0260700',
  'Y0260900',
  'Y0261600',
  'Y0267600',
  'Y0267700',
  'Y0267800',
  'Y0267900',
  'Y0268300',
  'Y0268500',
  'Y0269200',
  'Y0296600',
  'Y0297000',
  'Y0297008',
  'Y0297011',
  'Y0297015',
  'Y0297018',
  'Y0297021',
  'Y0299500',
  'Y0299505',
  'Y0299508',
  'Y0301800',
  'Y0301900',
  'Y0302206',
  'Y0303906',
  'Y0305606',
  'Y0307900',
  'Y0308000',
  'Y0335901',
  'Y0335902',
  'Y0335903',
  'Y0358400',
  'Y0367900',
  'Y0368000',
  'Y0368100',
  'Y0368300',
  'Y0368400',
  'Y0375100',
  'Y0375400',
  'Y0375500',
  'Y0375600',
  'Y0376500',
  'Y0376600',
  'Y0378100',
  'Y0378200',
  'Y0378400',
  'Y0414300',
  'Y0416200',
  'Y0417300',
  'Y0417700',
  'Y0417900',
  'Y0418100',
  'Y0425200',
  'Y0570600',
  'Y0570700',
  'Y0570800',
  'Y0570900',
  'Y0571000',
  'Y0571100',
  'Y0571500',
  'Y0571700',
  'Y0572500',
  'Y0572800',
  'Y0572900',
  'Y0582700',
  'Y0582800',
  'Y0582900',
  'Y0583000',
  'Y0583100',
  'Y0583500',
  'Y0583700',
  'Y0584200',
  'Y0584300',
  'Y0604000',
  'Y0604500',
  'Y0604508',
  'Y0604511',
  'Y0604515',
  'Y0604518',
  'Y0604521',
  'Y0604600',
  'Y0604605',
  'Y0604608',
  'Y0605400',
  'Y0605500',
  'Y0605806',
  'Y0606606',
  'Y0607306',
  'Y0608800',
  'Y0608900',
  'Y0636301',
  'Y0636302',
  'Y0636303',
  'Y0652700',
  'Y0661500',
  'Y0661600',
  'Y0661700',
  'Y0661900',
  'Y0662000',
  'Y0668800',
  'Y0669100',
  'Y0669200',
  'Y0669300',
  'Y0669800',
  'Y0670200',
  'Y0670300',
  'Y0671800',
  'Y0671900',
  'Y0672100',
  'Y0677400',
  'Y0677500',
  'Y0704400',
  'Y0706300',
  'Y0707300',
  'Y0707700',
  'Y0707900',
  'Y0708100',
  'Y0715100',
  'Y0871200',
  'Y0871300',
  'Y0871400',
  'Y0871500',
  'Y0871600',
  'Y0871700',
  'Y0871800',
  'Y0871900',
  'Y0872000',
  'Y0872100',
  'Y0872200',
  'Y0872300',
  'Y0872400',
  'Y0873100',
  'Y0873200',
  'Y0873500',
  'Y0873600',
  'Y0875100',
  'Y0875600',
  'Y0875700',
  'Y0875800',
  'Y0875900',
  'Y0890100',
  'Y0890200',
  'Y0890300',
  'Y0890400',
  'Y0890500',
  'Y0890600',
  'Y0897100',
  'Y0897608',
  'Y0897611',
  'Y0897618',
  'Y0897622',
  'Y0898200',
  'Y0899906',
  'Y0900006',
  'Y0900106',
  'Y0900206',
  'Y0900306',
  'Y0903100',
  'Y0903200',
  'Y0930801',
  'Y0930802',
  'Y0930803',
  'Y0948800',
  'Y0958400',
  'Y0958500',
  'Y0958700',
  'Y0958900',
  'Y0959000',
  'Y0959100',
  'Y0966200',
  'Y0966500',
  'Y0966600',
  'Y0966700',
  'Y0967200',
  'Y0967600',
  'Y0967700',
  'Y0969200',
  'Y0969300',
  'Y0969500',
  'Y0985000',
  'Y0986000',
  'Y0986200',
  'Y0986400',
  'Y0988600',
  'Y0988800',
  'Y0989800',
  'Y0990300',
  'Y1009100',
  'Y1011400',
  'Y1012500',
  'Y1012900',
  'Y1013100',
  'Y1013300',
  'Y1016200',
  'Y1017400',
  'Y1017500',
  'Y1017600',
  'Y1019500',
  'Y1019600',
  'Y1021200',
  'Y1120200',
  'Y1120300',
  'Y1120400',
  'Y1120500',
  'Y1120600',
  'Y1120700',
  'Y1120800',
  'Y1120900',
  'Y1121000',
  'Y1121100',
  'Y1121200',
  'Y1121300',
  'Y1121400',
  'Y1121500',
  'Y1121600',
  'Y1121700',
  'Y1121800',
  'Y1121900',
  'Y1146800',
  'Y1147204',
  'Y1147208',
  'Y1147211',
  'Y1147215',
  'Y1147218',
  'Y1147221',
  'Y1147222',
  'Y1147224',
  'Y1147227',
  'Y1147230',
  'Y1147900',
  'Y1148000',
  'Y1149206',
  'Y1149306',
  'Y1149406',
  'Y1149500',
  'Y1149600',
  'Y1149700',
  'Y1150400',
  'Y1150500',
  'Y1160801',
  'Y1160802',
  'Y1160803',
  'Y1161300',
  'Y1162400',
  'Y1162500',
  'Y1164300',
  'Y1164500',
  'Y1170800',
  'Y1176300',
  'Y1176808',
  'Y1176809',
  'Y1176811',
  'Y1178600',
  'Y1178700',
  'Y1212200',
  'Y1212400',
  'Y1212501',
  'Y1212600',
  'Y1212800',
  'Y1212901',
  'Y1213000',
  'Y1213101',
  'Y1213200',
  'Y1213301',
  'Y1213400',
  'Y1213501',
  'Y1213600',
  'Y1213701',
  'Y1214100',
  'Y1214300',
  'Y1225800',
  'Y1226600',
  'Y1228900',
  'Y1229100',
  'Y1230100',
  'Y1230200',
  'Y1230900',
  'Y1251300',
  'Y1253600',
  'Y1254700',
  'Y1255100',
  'Y1255300',
  'Y1255700',
  'Y1258700',
  'Y1259800',
  'Y1259900',
  'Y1260000',
  'Y1261900',
  'Y1262000',
  'Y1263100',
  'Y1263200',
  'Y1263400',
  'Y1263500',
  'Y1263600',
  'Y1263700',
  'Y1263800',
  'Y1263900',
  'Y1264000',
  'Y1264100',
  'Y1264200',
  'Y1264400',
  'Y1266200',
  'Y1359300',
  'Y1359400',
  'Y1359500',
  'Y1359600',
  'Y1359700',
  'Y1359800',
  'Y1359900',
  'Y1360000',
  'Y1360100',
  'Y1360200',
  'Y1360300',
  'Y1360400',
  'Y1360500',
  'Y1360600',
  'Y1360700',
  'Y1360800',
  'Y1381200',
  'Y1381604',
  'Y1381608',
  'Y1381611',
  'Y1381615',
  'Y1381618',
  'Y1381621',
  'Y1381622',
  'Y1381624',
  'Y1381627',
  'Y1381630',
  'Y1382300',
  'Y1382400',
  'Y1383906',
  'Y1384006',
  'Y1384106',
  'Y1384206',
  'Y1384300',
  'Y1384400',
  'Y1384500',
  'Y1384600',
  'Y1385400',
  'Y1385500',
  'Y1395901',
  'Y1395902',
  'Y1395903',
  'Y1396400',
  'Y1398400',
  'Y1398500',
  'Y1401100',
  'Y1401300',
  'Y1401700',
  'Y1402100',
  'Y1415800',
  'Y1415900',
  'Y1416000',
  'Y1416200',
  'Y1416500',
  'Y1416600',
  'Y1416900',
  'Y1417408',
  'Y1417409',
  'Y1417411',
  'Y1419200',
  'Y1419300',
  'Y1455500',
  'Y1456300',
  'Y1458600',
  'Y1458800',
  'Y1459800',
  'Y1459900',
  'Y1460700',
  'Y1484300',
  'Y1486700',
  'Y1488400',
  'Y1488800',
  'Y1489000',
  'Y1489200',
  'Y1492400',
  'Y1493500',
  'Y1493600',
  'Y1495500',
  'Y1495600',
  'Y1496800',
  'Y1496900',
  'Y1499800',
  'Y1602200',
  'Y1602300',
  'Y1602400',
  'Y1602500',
  'Y1602600',
  'Y1602700',
  'Y1602800',
  'Y1602900',
  'Y1603000',
  'Y1603100',
  'Y1603200',
  'Y1603300',
  'Y1603400',
  'Y1603500',
  'Y1603600',
  'Y1623400',
  'Y1623500',
  'Y1623600',
  'Y1623700',
  'Y1623800',
  'Y1623900',
  'Y1629600',
  'Y1629700',
  'Y1631600',
  'Y1632004',
  'Y1632008',
  'Y1632011',
  'Y1632015',
  'Y1632018',
  'Y1632021',
  'Y1632022',
  'Y1632024',
  'Y1632027',
  'Y1632030',
  'Y1633200',
  'Y1633300',
  'Y1635106',
  'Y1635206',
  'Y1635306',
  'Y1635406',
  'Y1635506',
  'Y1635600',
  'Y1635700',
  'Y1635800',
  'Y1635900',
  'Y1636000',
  'Y1637000',
  'Y1637100',
  'Y1637200',
  'Y1647401',
  'Y1647402',
  'Y1647403',
  'Y1647900',
  'Y1648900',
  'Y1649000',
  'Y1649100',
  'Y1649200',
  'Y1649400',
  'Y1649700',
  'Y1649800',
  'Y1652500',
  'Y1652700',
  'Y1653100',
  'Y1653500',
  'Y1667200',
  'Y1667300',
  'Y1667400',
  'Y1667600',
  'Y1667900',
  'Y1668000',
  'Y1668300',
  'Y1668808',
  'Y1668809',
  'Y1668811',
  'Y1670600',
  'Y1670700',
  'Y1700600',
  'Y1701400',
  'Y1703700',
  'Y1703900',
  'Y1704900',
  'Y1705000',
  'Y1705800',
  'Y1736206',
  'Y1738200',
  'Y1738600',
  'Y1738800',
  'Y1739000',
  'Y1742200',
  'Y1743300',
  'Y1743400',
  'Y1745300',
  'Y1745400',
  'Y1746700',
  'Y1746800',
  'Y1749700',
  'Y1853900',
  'Y1854000',
  'Y1854100',
  'Y1854200',
  'Y1854300',
  'Y1854400',
  'Y1854500',
  'Y1854600',
  'Y1854700',
  'Y1854800',
  'Y1854900',
  'Y1855000',
  'Y1855100',
  'Y1855200',
  'Y1855300',
  'Y1875700',
  'Y1875800',
  'Y1875900',
  'Y1876000',
  'Y1876100',
  'Y1876200',
  'Y1876300',
  'Y1883400',
  'Y1883500',
  'Y1885600',
  'Y1886004',
  'Y1886008',
  'Y1886011',
  'Y1886015',
  'Y1886018',
  'Y1886021',
  'Y1886022',
  'Y1886024',
  'Y1886027',
  'Y1886030',
  'Y1887300',
  'Y1887400',
  'Y1888906',
  'Y1889006',
  'Y1889106',
  'Y1889206',
  'Y1889300',
  'Y1889400',
  'Y1889500',
  'Y1889600',
  'Y1890600',
  'Y1890700',
  'Y1890800',
  'Y1901900',
  'Y1919201',
  'Y1919202',
  'Y1919203',
  'Y1919700',
  'Y1920700',
  'Y1920800',
  'Y1920900',
  'Y1921000',
  'Y1921200',
  'Y1921800',
  'Y1921900',
  'Y1924600',
  'Y1924800',
  'Y1925200',
  'Y1925600',
  'Y1940500',
  'Y1940600',
  'Y1940700',
  'Y1940900',
  'Y1941200',
  'Y1941300',
  'Y1941600',
  'Y1942108',
  'Y1942109',
  'Y1942111',
  'Y1942400',
  'Y1942401',
  'Y1942508',
  'Y1942509',
  'Y1942511',
  'Y1944400',
  'Y1944500',
  'Y1986100',
  'Y1986900',
  'Y1989200',
  'Y1989400',
  'Y1990400',
  'Y1990500',
  'Y1991300',
  'Y2017006',
  'Y2019000',
  'Y2019400',
  'Y2019600',
  'Y2019800',
  'Y2023000',
  'Y2024100',
  'Y2024200',
  'Y2026100',
  'Y2026200',
  'Y2027500',
  'Y2027600',
  'Y2030500',
  'Y2157000',
  'Y2157100',
  'Y2157200',
  'Y2157300',
  'Y2157400',
  'Y2157500',
  'Y2157600',
  'Y2157700',
  'Y2157800',
  'Y2157900',
  'Y2158000',
  'Y2158100',
  'Y2158200',
  'Y2158300',
  'Y2190100',
  'Y2190200',
  'Y2190300',
  'Y2190400',
  'Y2190500',
  'Y2190600',
  'Y2197600',
  'Y2197700',
  'Y2199800',
  'Y2200204',
  'Y2200208',
  'Y2200211',
  'Y2200215',
  'Y2200218',
  'Y2200221',
  'Y2200222',
  'Y2200224',
  'Y2200227',
  'Y2200230',
  'Y2201700',
  'Y2201800',
  'Y2204206',
  'Y2204306',
  'Y2204406',
  'Y2204506',
  'Y2204606',
  'Y2204706',
  'Y2204806',
  'Y2204900',
  'Y2205000',
  'Y2205100',
  'Y2205200',
  'Y2205300',
  'Y2205400',
  'Y2205500',
  'Y2206500',
  'Y2206600',
  'Y2206700',
  'Y2217500',
  'Y2234900',
  'Y2237500',
  'Y2237600',
  'Y2237700',
  'Y2237800',
  'Y2238000',
  'Y2238700',
  'Y2238800',
  'Y2241500',
  'Y2241700',
  'Y2242100',
  'Y2242500',
  'Y2256500',
  'Y2256600',
  'Y2256700',
  'Y2256900',
  'Y2257200',
  'Y2257300',
  'Y2257600',
  'Y2258108',
  'Y2258109',
  'Y2258111',
  'Y2258400',
  'Y2258401',
  'Y2258508',
  'Y2258509',
  'Y2258511',
  'Y2260800',
  'Y2260900',
  'Y2267000',
  'Y2304900',
  'Y2305700',
  'Y2308000',
  'Y2308200',
  'Y2309200',
  'Y2309300',
  'Y2310100',
  'Y2341506',
  'Y2344100',
  'Y2344500',
  'Y2344700',
  'Y2344900',
  'Y2348100',
  'Y2349200',
  'Y2349300',
  'Y2351200',
  'Y2351300',
  'Y2352600',
  'Y2352700',
  'Y2355600',
  'Y2494100',
  'Y2494200',
  'Y2494300',
  'Y2494400',
  'Y2524400',
  'Y2524500',
  'Y2524600',
  'Y2524700',
  'Y2524800',
  'Y2534100',
  'Y2534504',
  'Y2534508',
  'Y2534511',
  'Y2534515',
  'Y2534518',
  'Y2534521',
  'Y2534522',
  'Y2534524',
  'Y2534527',
  'Y2534530',
  'Y2537300',
  'Y2537500',
  'Y2537700',
  'Y2537800',
  'Y2541106',
  'Y2541206',
  'Y2541306',
  'Y2541406',
  'Y2541506',
  'Y2541606',
  'Y2541706',
  'Y2541806',
  'Y2541906',
  'Y2542006',
  'Y2542100',
  'Y2542200',
  'Y2542300',
  'Y2542400',
  'Y2542500',
  'Y2542600',
  'Y2542700',
  'Y2542800',
  'Y2542900',
  'Y2543000',
  'Y2544000',
  'Y2544100',
  'Y2544200',
  'Y2560400',
  'Y2570000',
  'Y2570200',
  'Y2570400',
  'Y2570600',
  'Y2573200',
  'Y2573300',
  'Y2573400',
  'Y2573500',
  'Y2586500',
  'Y2589700',
  'Y2589800',
  'Y2589900',
  'Y2590000',
  'Y2590200',
  'Y2590800',
  'Y2590900',
  'Y2593600',
  'Y2593800',
  'Y2594200',
  'Y2594600',
  'Y2608100',
  'Y2608200',
  'Y2608300',
  'Y2608500',
  'Y2608800',
  'Y2608900',
  'Y2609200',
  'Y2609708',
  'Y2609709',
  'Y2609711',
  'Y2610000',
  'Y2610001',
  'Y2610108',
  'Y2610109',
  'Y2610111',
  'Y2613700',
  'Y2613800',
  'Y2637600',
  'Y2638400',
  'Y2640700',
  'Y2640900',
  'Y2641900',
  'Y2642000',
  'Y2642800',
  'Y2670906',
  'Y2673600',
  'Y2674000',
  'Y2674200',
  'Y2674400',
  'Y2677600',
  'Y2678700',
  'Y2678800',
  'Y2680700',
  'Y2680800',
  'Y2682100',
  'Y2682200',
  'Y2685100',
  'Y2824000',
  'Y2824100',
  'Y2824200',
  'Y2824300',
  'Y2824400',
  'Y2824500',
  'Y2824600',
  'Y2824700',
  'Y2824800',
  'Y2824900',
  'Y2825000',
  'Y2825100',
  'Y2862500',
  'Y2862600',
  'Y2862700',
  'Y2862800',
  'Y2862900',
  'Y2863000',
  'Y2863100',
  'Y2864600',
  'Y2864601',
  'Y2864602',
  'Y2864603',
  'Y2864604',
  'Y2864605',
  'Y2864606',
  'Y2864607',
  'Y2864608',
  'Y2864609',
  'Y2866505',
  'Y2866605',
  'Y2866705',
  'Y2866805',
  'Y2880100',
  'Y2880200',
  'Y2882300',
  'Y2882706',
  'Y2882708',
  'Y2882710',
  'Y2882712',
  'Y2882713',
  'Y2882714',
  'Y2882716',
  'Y2882717',
  'Y2882718',
  'Y2885400',
  'Y2885600',
  'Y2885800',
  'Y2885900',
  'Y2889206',
  'Y2889306',
  'Y2889406',
  'Y2889506',
  'Y2889606',
  'Y2889706',
  'Y2889806',
  'Y2889906',
  'Y2890006',
  'Y2890106',
  'Y2890200',
  'Y2890300',
  'Y2890400',
  'Y2890500',
  'Y2890600',
  'Y2890700',
  'Y2890800',
  'Y2890900',
  'Y2891000',
  'Y2891100',
  'Y2892100',
  'Y2892200',
  'Y2892300',
  'Y2907900',
  'Y2917400',
  'Y2917600',
  'Y2917800',
  'Y2918000',
  'Y2920900',
  'Y2921000',
  'Y2921100',
  'Y2921200',
  'Y2934400',
  'Y2936500',
  'Y2936600',
  'Y2936700',
  'Y2936800',
  'Y2937000',
  'Y2938000',
  'Y2938100',
  'Y2938200',
  'Y2938300',
  'Y2938400',
  'Y2938500',
  'Y2938600',
  'Y2938700',
  'Y2938800',
  'Y2938900',
  'Y2939000',
  'Y2939100',
  'Y2939200',
  'Y2939300',
  'Y2939400',
  'Y2939500',
  'Y2939600',
  'Y2939700',
  'Y2939800',
  'Y2940000',
  'Y2940500',
  'Y2940600',
  'Y2943300',
  'Y2943500',
  'Y2943900',
  'Y2944300',
  'Y2946700',
  'Y2946800',
  'Y2958200',
  'Y2958300',
  'Y2958400',
  'Y2958600',
  'Y2958900',
  'Y2959000',
  'Y2959300',
  'Y2959808',
  'Y2959809',
  'Y2959811',
  'Y2960100',
  'Y2960101',
  'Y2960208',
  'Y2960209',
  'Y2960211',
  'Y2963800',
  'Y2963900',
  'Y2994800',
  'Y2995600',
  'Y2997900',
  'Y2998100',
  'Y2999100',
  'Y2999200',
  'Y3000000',
  'Y3027306',
  'Y3030000',
  'Y3030400',
  'Y3030600',
  'Y3030800',
  'Y3034100',
  'Y3035200',
  'Y3035300',
  'Y3036100',
  'Y3036200',
  'Y3037500',
  'Y3037600',
  'Y3040500',
  'Y3194100',
  'Y3194200',
  'Y3194300',
  'Y3194400',
  'Y3194500',
  'Y3194600',
  'Y3194700',
  'Y3194800',
  'Y3194900',
  'Y3195000',
  'Y3195100',
  'Y3195200',
  'Y3195300',
  'Y3195400',
  'Y3195500',
  'Y3195600',
  'Y3195700',
  'Y3234100',
  'Y3234200',
  'Y3234300',
  'Y3234400',
  'Y3234500',
  'Y3234600',
  'Y3235900',
  'Y3235901',
  'Y3235902',
  'Y3235903',
  'Y3235904',
  'Y3235905',
  'Y3235906',
  'Y3235907',
  'Y3235908',
  'Y3235909',
  'Y3237505',
  'Y3237605',
  'Y3237705',
  'Y3237805',
  'Y3237905',
  'Y3250000',
  'Y3250100',
  'Y3252000',
  'Y3252106',
  'Y3252108',
  'Y3252110',
  'Y3252112',
  'Y3252113',
  'Y3252114',
  'Y3252116',
  'Y3252117',
  'Y3252118',
  'Y3252300',
  'Y3252706',
  'Y3252708',
  'Y3252710',
  'Y3252712',
  'Y3252713',
  'Y3252714',
  'Y3252716',
  'Y3252717',
  'Y3252718',
  'Y3254700',
  'Y3254800',
  'Y3255800',
  'Y3255900',
  'Y3257100',
  'Y3257200',
  'Y3258200',
  'Y3258300',
  'Y3258400',
  'Y3274500',
  'Y3281300',
  'Y3282600',
  'Y3282700',
  'Y3282800',
  'Y3283000',
  'Y3287200',
  'Y3287400',
  'Y3287600',
  'Y3287800',
  'Y3290700',
  'Y3290800',
  'Y3290900',
  'Y3291000',
  'Y3304500',
  'Y3306700',
  'Y3306800',
  'Y3306900',
  'Y3307000',
  'Y3307200',
  'Y3307300',
  'Y3308300',
  'Y3308400',
  'Y3308500',
  'Y3308600',
  'Y3308700',
  'Y3308800',
  'Y3308900',
  'Y3309000',
  'Y3309100',
  'Y3309200',
  'Y3309400',
  'Y3309500',
  'Y3309600',
  'Y3309700',
  'Y3309800',
  'Y3309900',
  'Y3310000',
  'Y3310100',
  'Y3310200',
  'Y3310400',
  'Y3310900',
  'Y3311000',
  'Y3312500',
  'Y3312700',
  'Y3313100',
  'Y3313500',
  'Y3315300',
  'Y3315400',
  'Y3325700',
  'Y3325701',
  'Y3325702',
  'Y3325704',
  'Y3325707',
  'Y3325708',
  'Y3325802',
  'Y3326208',
  'Y3326209',
  'Y3326211',
  'Y3326500',
  'Y3326501',
  'Y3326608',
  'Y3326609',
  'Y3326611',
  'Y3329100',
  'Y3329200',
  'Y3364200',
  'Y3366500',
  'Y3366700',
  'Y3367700',
  'Y3367800',
  'Y3368600',
  'Y3392706',
  'Y3395500',
  'Y3395900',
  'Y3396100',
  'Y3396300',
  'Y3399800',
  'Y3400900',
  'Y3401000',
  'Y3401800',
  'Y3401900',
  'Y3403300',
  'Y3403400',
  'Y3406300',
  'Y3538600',
  'Y3538700',
  'Y3538800',
  'Y3538900',
  'Y3539000',
  'Y3539100',
  'Y3539200',
  'Y3539300',
  'Y3539400',
  'Y3539500',
  'Y3574400',
  'Y3574500',
  'Y3574600',
  'Y3574700',
  'Y3574800',
  'Y3574900',
  'Y3576200',
  'Y3576201',
  'Y3576202',
  'Y3576203',
  'Y3576204',
  'Y3576205',
  'Y3576206',
  'Y3576207',
  'Y3576208',
  'Y3576209',
  'Y3576210',
  'Y3578005',
  'Y3578105',
  'Y3578205',
  'Y3578305',
  'Y3590400',
  'Y3592500',
  'Y3592606',
  'Y3592608',
  'Y3592610',
  'Y3592612',
  'Y3592613',
  'Y3592614',
  'Y3592616',
  'Y3592617',
  'Y3592618',
  'Y3592800',
  'Y3593206',
  'Y3593208',
  'Y3593210',
  'Y3593212',
  'Y3593213',
  'Y3593214',
  'Y3593216',
  'Y3593217',
  'Y3593218',
  'Y3594904',
  'Y3594905',
  'Y3595800',
  'Y3595900',
  'Y3597100',
  'Y3597200',
  'Y3598200',
  'Y3598300',
  'Y3598400',
  'Y3614600',
  'Y3621400',
  'Y3623000',
  'Y3623100',
  'Y3623200',
  'Y3623400',
  'Y3627500',
  'Y3627700',
  'Y3627900',
  'Y3628100',
  'Y3631000',
  'Y3631100',
  'Y3631200',
  'Y3631300',
  'Y3643700',
  'Y3644100',
  'Y3644500',
  'Y3644700',
  'Y3647300',
  'Y3650900',
  'Y3651000',
  'Y3651100',
  'Y3651200',
  'Y3651400',
  'Y3651500',
  'Y3652000',
  'Y3652100',
  'Y3652200',
  'Y3652300',
  'Y3652400',
  'Y3652500',
  'Y3652600',
  'Y3652700',
  'Y3652800',
  'Y3652900',
  'Y3653100',
  'Y3653200',
  'Y3653300',
  'Y3653400',
  'Y3653500',
  'Y3653600',
  'Y3653700',
  'Y3653800',
  'Y3653900',
  'Y3654100',
  'Y3654700',
  'Y3654800',
  'Y3656300',
  'Y3656500',
  'Y3656900',
  'Y3657300',
  'Y3659100',
  'Y3659200',
  'Y3670800',
  'Y3670801',
  'Y3670802',
  'Y3670804',
  'Y3670807',
  'Y3670808',
  'Y3670902',
  'Y3671408',
  'Y3671409',
  'Y3671411',
  'Y3671700',
  'Y3671701',
  'Y3671808',
  'Y3671809',
  'Y3671811',
  'Y3673301',
  'Y3673313',
  'Y3673316',
  'Y3673400')

# Handle missing values

  child_match_data[child_match_data == -1] = NA  # Refused 
  child_match_data[child_match_data == -2] = NA  # Dont know 
  child_match_data[child_match_data == -3] = NA  # Invalid missing 
  child_match_data[child_match_data == -7] = NA  # Missing 
```
### Clean
```{r}
# create a small function for calculating the mode
Mode <- function(x) {
  ux <- unique(x)
  ux <- ux[!is.na(ux)]
  ux[which.max(tabulate(match(x, ux)))]
}

# get vector of original reference numbers (column names) of the child data with multiple waves
child_long_cols <- (codebook_child %>% filter(year != "XRND" & grepl("match", var.type)))$RNUM
# get vector of the new variable names of the child data with multiple waves
child_new_cols <- (codebook_child %>% filter(year != "XRND" & grepl("match", var.type)))$comb_varname


codebook_match <- codebook_child %>%
  select(comb_varname, Rule.Age, Rule.Item, reverse_code) %>% # add in rules for 
  filter(comb_varname %in% child_new_cols) %>% # compositing and reverse coding
  mutate(item = comb_varname)

  
match_long <- child_match_data %>%
  # select ID, DOB, and items for compositing
  select(C0000100, C0000200, C0005700, C0005400, one_of(child_long_cols)) %>%               
  gather(key = item, value = value, one_of(child_long_cols)) %>% # switch to long format
  setNames(c("PROC_CID", "PROC_MID", "Dem_DOBYear", "DemCSex", "item", "value")) %>% # rename columns
  mutate(item = mapvalues(item, child_long_cols, child_new_cols)) %>% # recode items to to new names
  left_join(codebook_match) %>%
  full_join((mom_long)) %>%# compositing and reverse coding
  separate(item, c("category","item", "year"), sep = "[.]") %>%
  unite(broad, category:item, remove = TRUE) %>%# split items in item and year columns
  mutate(year = as.numeric(year), # convert year to numeric
         age = ifelse(!is.na(value) & year >= Dem_DOBYear, 
                      year - Dem_DOBYear, NA))  # calculate age

match_long2 <- match_long %>%
    full_join(match_long %>%
      filter(grepl("HlthCndLimChck", broad)) %>%
      select(-broad, -Rule.Age, -Rule.Item, -reverse_code) %>%
      rename(hlthChck = value)) %>%
  mutate(hlthChck = ifelse(grepl("HlthCndLim_", broad) == T & is.na(value) == T, hlthChck, value)) %>%
  filter((!is.na(age) | !is.na(value)) & (age <= 14 | 
        (broad %in% c("HHJail_HHJail", "HHMomDead_HHMomDead", "HHDadDead_HHDadDead")))) %>%
  mutate(value = ifelse(grepl("UsualRes", broad) == T, 
                        mapvalues(value, seq(1,12,1), c(1, rep(0, 11))), # 1 = with mother; 2 = otherwise
                 ifelse(grepl("Limit", broad) == T, 
                        mapvalues(value, seq(3,0,-1), seq(0,3,1)), # reverse weird scale for Limiting / Structure
                 ifelse(grepl("HrTV", broad) == T, value/100, 
                 ifelse(grepl("HlthCndLim", broad) == T & !is.na(value) == T & value != 0, 1, 
                 ifelse(grepl("HlthCndLim", broad) == T & !is.na(value) == T & value == 0, 0, 
                 ifelse(grepl("HlthCndLimScl", broad) == T & year %in% seq(1986, 2004,2), 
                        mapvalues(value, seq(0,2,1), c(0,1,0)), 
                 ifelse(grepl("EduRemed", broad) == T & year %in% seq(1988,1998,2), 
                        mapvalues(value, c(0,1,2,4), c(0,1,0,0)), 
                 ifelse(broad == "HlthCndReqTr12mo_HlthCndReqTr12mo", 
                        mapvalues(value, seq(0,2,1), c(0,1,NA)), 
                 ifelse(broad == "DemFathNHH_FathNHH", 
                        mapvalues(value, 1:4, c(1:3,1)), 
                 ifelse(grepl("Mom2Dad", broad) == T, 
                        mapvalues(value, seq(1,13,1), c(1, rep(0,12))), 
                 ifelse(grepl("FathGrade", broad) == T, 
                        mapvalues(value, c(seq(0,20,1),95), c(seq(0,20,1),NA)), 
                 ifelse(grepl("Home", broad) == T & value > 99, 99, 
                 ifelse(grepl("NghdSf2Scl", broad) == T, 
                        mapvalues(value, c(seq(1,4,1), 6, 25), c(seq(1,4,1), NA, NA)), 
                        value)))))))))))))) %>%          #Recode weird time variable where 100 = 1 hr to 1 hr = 1 hr
  group_by(broad) %>%
  mutate(min = min(value, na.rm = T), max = max(value, na.rm = T),                  # find min & max for reverse scoring
         value = ifelse(reverse_code != "rev", value,                               # leave pos keyed items alone
                        reverse.code(-1, value, mini = min[1], maxi = max[1]))) %>% # reverse code neg keyed items
  select(-min, -max) # get rid of min and max columns


seq_years <- seq(1988,1992, 2)

# create a sum variable for mom's response to tantrums #
final_match_long <- match_long2 %>%
  filter(grepl("DSTantrum", broad) == T) %>%
  mutate(value = ifelse(grepl("DSTantrum", broad) == T, 
                 ifelse(year %in% seq_years & is.na(value) == F, 1, # different selected events in 88-92 coded as 1-7
                 ifelse(year %in% seq_years & is.na(value) == T, 0, # unselected events not coded
                 ifelse(year == 1996, recode(value, `2` = 0), 
                 ifelse(grepl("Talk", broad) == T, recode(value, `1` = 0, `0` = 1), value)))), value)) %>%
  group_by(PROC_CID, PROC_MID, age, broad, Rule.Age, Rule.Item) %>%
  summarise(value = max(value, na.rm = T), # some mothers filled out 6-9 and 10+ surveys in one year
            value = ifelse(is.infinite(value) == T, NA, value)) %>%  
  group_by(PROC_CID, PROC_MID, age, Rule.Age, Rule.Item) %>% # compositing across different responses
  summarise(value = sum(value, na.rm = T),
          broad = "MRTantrum_Tantrum") %>%
  filter(grepl("HlthCndLim_", broad)) %>%
  group_by(PROC_CID, PROC_MID, age, year, broad, Rule.Age, Rule.Item) %>%
  # average across unique items for the same age first
  mutate(value = mean(value)) %>%
  separate(broad, c("category", "item")) %>%
            group_by(PROC_CID, PROC_MID, age, year, category, Rule.Age, Rule.Item) %>%
             # sum across broader categories of items for the same ages second
            mutate(value = sum(value)) %>%
            unite(broad, category:item, remove = TRUE) %>%
  # add in all other match variables but the health and tantrum variables
  full_join(match_long2 %>% filter(grepl("DSTantrum", broad) == F & grepl("HlthCndLim_", broad) == F)) %>%
  rename(item = broad)


# create a function for compositing matching variables
sum_fun <- function(df, Rule1, Rule2){
  fun_call <- function(x, rule){
    switch(rule,
           average = mean(x, na.rm = T),
           mode = Mode(x)[1],
           sum = sum(x, na.rm = T),
           select = unique(x)[1],
           max = max(x, na.rm = T))
  }
  
  df %>%
    group_by(PROC_CID, item, Dem_DOBYear) %>% # group by person and item (collapse across age)
    summarize(value = fun_call(value, Rule1)) %>% # use proper summary function on each group combination
    mutate(value = ifelse(is.nan(value) == T, NA, # get rid of NaN and Inf values
                 ifelse(is.infinite(value) == T, NA, value))) %>%
    separate(item, c("category", "item")) %>% # split item further into category and unique item
    group_by(PROC_CID, category) %>% # group by subject and type (collapse across item)
    summarize(value = fun_call(value, Rule2)) %>% # use proper summary function on each group combination
    mutate(value = ifelse(is.nan(value) == T, NA, # get rid of NaN and Inf values
                 ifelse(is.infinite(value) == T, NA, value))) %>%
    ungroup()
}


#vector for matching variables

child_wide_cols <- (codebook_child %>% filter(year == "XRND" & grepl("match", var.type)))$RNUM
child_new_cols <- (codebook_child %>% filter(year == "XRND" & grepl("match", var.type)))$comb_varname
child_new_cols <- gsub(".XRND", "", child_new_cols)

# here, we are going to grab the child data with only one response, clean up variables that need to be recoded
# these are intentionally in wide format and will eventually be joined with other data

match_wide <- child_match_data %>%
  select(C0000100, C0000200, C0005700, C0005400, one_of(child_wide_cols)) %>% # select ID, DOB, and items for compositing
  gather(key = item, value = value, -C0000100, -C0000200, -C0005700, -C0005400) %>% # switch to long format
  setNames(c("PROC_CID", "PROC_MID", "Dem_DOBYear", "DemCSex", "item", "value")) %>% # rename columns
  mutate(item = mapvalues(item, child_wide_cols, child_new_cols)) %>%
  filter(!is.na(value) & !(item %in% c("DemHeightIN_HeightIN", "DemHeightFT_HeightFT", "DemWeightLBS_WeightLBS"))) %>%
  mutate(value = ifelse(grepl("MRed", item) == T, mapvalues(value, c(0,1,4), c(0,1,1)), value)) %>%
  separate(item, c("category", "item"), sep = "[.]") %>% # split items in item and year columns
  group_by(PROC_CID, PROC_MID, category, Dem_DOBYear, DemCSex) %>%
  mutate(value = mean(value, na.rm = T)) %>%
  ungroup() %>%
  mutate(value = ifelse(grepl("MRed", category) == T | grepl("Diuret", category) == T, ceiling(value), value)) %>%
  spread(key = category, value = value) %>%
  mutate(DemRace = mapvalues(DemRace, seq(1,3,1), seq(3,1,-1)),
         BreastFed = ifelse(WkBreastFedEnd > WkBreastFedBeg, WkBreastFedEnd - WkBreastFedBeg, NA)) %>%
  select(-WkBreastFedEnd, -WkBreastFedBeg) %>%
  group_by(PROC_CID) %>%
  filter(!is.na(BrnWkWnDueDate) | !is.na(BrthLnth) | !is.na(BrthWght) | !is.na(CSecBrth) | !is.na(DaysHosBrth) | !is.na(DemBirthOrder) | !is.na(DemMVitamin) | !is.na(DemRace) | !is.na(Dr4Ill1stYr) | !is.na(MDrugsPreg) | !is.na(MRedPreg) | !is.na(MSmoke) | !is.na(MVitamin) | !is.na(NumWkEarLt)) %>%
mutate(BrnWkWnDueDate = mean(BrnWkWnDueDate, na.rm = T), BrthLnth = mean(BrthLnth, na.rm = T), BrthWght = mean(BrthWght, na.rm = T), CSecBrth = mean(CSecBrth, na.rm = T), DaysHosBrth = mean(DaysHosBrth, na.rm = T), DemBirthOrder = mean(DemBirthOrder, na.rm = T), DemMVitamin = mean(DemMVitamin, na.rm = T), DemRace = mean(DemRace, na.rm = T), Dr4Ill1stYr = mean(Dr4Ill1stYr, na.rm = T), MDrugsPreg = mean(MDrugsPreg, na.rm = T), MRedPreg = mean(MRedPreg, na.rm = T), MSmoke = mean(MSmoke, na.rm = T), MVitamin = mean(MVitamin, na.rm = T), NumWkEarLt = mean(NumWkEarLt, na.rm = T)) %>%
  ungroup()


sum_match_wide <- final_match_long %>%
  group_by(Rule.Age, Rule.Item) %>%
  nest() %>%
  mutate(value = pmap(list(data, Rule.Age, Rule.Item), possibly(sum_fun, NA_real_))) %>%
  select(-data) %>%
  unnest(value) %>% # unnest the results
  ungroup() %>% 
  select(-contains("Rule")) %>% # get rid of the rule variables
  spread(key = category, value = value) %>% # change to wide format
  mutate(HomeBin = ceiling(HomeBin),
         MWelfare = ifelse(is.na(MWelfare) == T, 0, MWelfare),
         HlthCndLim = ifelse(is.na(HlthCndLim) == T, 0, HlthCndLim)) %>% 
  select(-contains("eight")) %>% # get rid of height and weight; we'll take care of those later
  full_join(match_wide) %>% # join with wide format matching variables
  mutate_all(as.numeric)


## norm height and weight information by age) ##
# height and weight are tricky, so instead of using sometimes unreliable raw height and weight data, we will use 
# the World Health Organization's norms to calculate height-for-age and weight-for-age percentiles

htwt <- final_match_long %>% ungroup() %>%
  # grab height and weight variables for 9-10 year olds
  filter(item %in% c("DemHeightFT_HeightFT", "DemHeightIN_HeightIN", "DemWeightLBS_WeightLBS") & age %in% c(9,10)) %>%
  select(PROC_CID, PROC_MID, age, DemCSex, year, item, value) %>%
  group_by(PROC_CID, PROC_MID, age, DemCSex, year, item) %>%
  summarize(value = mean(value, na.rm = T)) %>%
  ungroup() %>%
  spread(key = item, value = value) %>% # change to wide format
  # get rid of implausible height values
  filter(!(DemHeightFT_HeightFT > 5 & DemHeightIN_HeightIN < 12) &
         !is.na(DemHeightIN_HeightIN) & !is.na(DemWeightLBS_WeightLBS) & !is.na(DemHeightFT_HeightFT)) %>%
  # convert weight to kilograms, height to centimeters, and age to months
  mutate(DemWeightKG_WeightKG = DemWeightLBS_WeightLBS/2.2,
         DemHeightIN_HeightIN = ifelse(DemHeightIN_HeightIN < 12 & DemHeightFT_HeightFT < 6, 
                                       DemHeightIN_HeightIN + (DemHeightFT_HeightFT * 12), DemHeightIN_HeightIN),
         DemHeightCM_HeightCM = DemHeightIN_HeightIN * 2.54,
         ageMon = 12*age,
         ageDay = 365.25*age) %>%
  # catch remaining implausible values
  filter(DemWeightLBS_WeightLBS > 30 & DemHeightIN_HeightIN > 30) %>%
  as.data.frame()

htwt$sex_chr <- recode(htwt$DemCSex, `1` = "Male", `2` = "Female")



# load R package that conveniently has all of WHO's conversion standards ready for use
library(growthstandards)

htwt_z <- htwt %>%
  group_by(PROC_CID) %>%
  mutate(DemPweight = (who_wtkg2zscore(agedays = ageDay, wtkg = DemWeightKG_WeightKG, sex = sex_chr)),
         DemPheight = (who_htcm2zscore(agedays = ageDay, htcm = DemHeightCM_HeightCM, sex = sex_chr))) %>%
  select(PROC_CID, PROC_MID, DemCSex, DemPweight, DemPheight)

# add the height and weight variables to the matching dataset
match_wide <- sum_match_wide %>%
  left_join(htwt_z) %>% ungroup()
```

## Children Data: Substance Use   
### Clean
```{r}
# get vector of original reference numbers (column names) of the child data with multiple waves
child_long_cols <- (codebook_child %>% filter(year != "XRND" & var.type == "group"))$RNUM
# get vector of the new variable names of the child data with multiple waves
child_new_cols <-  (codebook_child %>% filter(year != "XRND" & var.type == "group"))$comb_varname

# create age categories
age_orig <- seq(8, 19, 1)
age_cat <- rep(c(9,10,12,14,16,18), each = 2)

group_long <- drug_pers_data %>%
  select(C0000100, C0000200, C0005700, C0005400, one_of(child_long_cols)) %>%
  gather(key = item, value = value, one_of(child_long_cols)) %>%
  setNames(c("PROC_CID", "PROC_MID", "Dem_DOBYear", "DemCSex", "item", "value")) %>% # rename columns
  mutate(item = mapvalues(item, child_long_cols, child_new_cols)) %>%
  separate(item, c("category", "class", "item", "year"), sep = "[.]") %>%
  mutate(year = as.numeric(year), 
         age = ifelse(!is.na(value) & year >= Dem_DOBYear, year - Dem_DOBYear, NA)) %>%
  filter(!is.na(age) & !is.na(value) & age <= 18) %>%
  mutate(age = mapvalues(age, age_orig, age_cat)) %>%
  group_by(PROC_CID, PROC_MID, DemCSex, class, item, age) %>%
  summarize(value = max(value, na.rm = T)) %>%
  ungroup() %>%
  group_by(PROC_CID, PROC_MID, DemCSex, class, age) %>%
  summarize(value = max(value), 
            value = ifelse(value != 0, 1,
                    ifelse(is.na(value) == T, NA, 0))) %>%
  ungroup()

  
  
#Each Drug Class is Shown
group_wide <- group_long %>%
  spread(key = class, value = value) %>%
  gather(key = class, value = value, Alcohol, Cig, Mar, Coke, Halluc, SH, UD) %>%
  mutate(value = mapvalues(value, c(0,1,NA), c(0,1,0))) %>%
  spread(key = class, value = value) %>%
  mutate(DrugYes = ifelse(Alcohol == 1 | Cig == 1 | Coke == 1 | Halluc == 1 | Mar == 1 | SH == 1 | UD == 1, 1, 0)) %>%
  group_by(PROC_CID) %>%
  mutate(DrugYes = max(DrugYes)) %>%
  ungroup()



# dataframe for getting demographic information - lose ability to get ages of initiation in this one so kept it separate

group_demo_wide <- group_wide %>%
  select(-age, -PROC_MID) %>%
  group_by(PROC_CID) %>%
  summarise(Alcohol = max(Alcohol), Cig = max(Cig), Coke = max(Coke), Halluc = max(Halluc), Mar = max(Mar), SH = max(SH), UD = max(UD), DrugYes = max(DrugYes))



groups_wide <- group_wide %>%
  select(PROC_CID, DrugYes, groups) %>%
  unique()



match_groups <- match_wide %>%
  left_join(groups_wide %>% ungroup() %>% select(PROC_CID, groups)) %>%
  filter(!is.na(groups)) %>%
  unique()
```

## Children Data: Personality
### Clean
```{r}
child_long_cols <- (codebook_child %>% filter(year != "XRND" & var.type == "outcome"))$RNUM
child_new_cols <-  (codebook_child %>% filter(year != "XRND" & var.type == "outcome"))$comb_varname

age_orig <- seq(8, 25, 1)
age_cat <- rep(seq(8,24,2), each = 2)

pre_outcome <- drug_pers_data %>%
  select(C0000100, C0000200, C0005700, C0005400, one_of(child_long_cols)) %>%
  gather(key = item, value = value, one_of(child_long_cols)) %>%
  setNames(c("PROC_CID", "PROC_MID", "Dem_DOBYear", "DemCSex", "item", "value")) %>% # rename columns
  mutate(item = mapvalues(item, child_long_cols, child_new_cols)) %>%
  left_join((codebook_child %>% 
               select(comb_varname, reverse_code) %>% # add in rules for 
               filter(comb_varname %in% child_new_cols) %>% # compositing and reverse coding
               rename(item = comb_varname))) %>%
  separate(item, c("category", "item", "year"), sep = "[.]") %>%
  mutate(year = as.numeric(year), 
         age = ifelse(!is.na(value) & year >= Dem_DOBYear, year - Dem_DOBYear, NA)) %>%
  filter(!is.na(age) & !is.na(value) & age > 9 & age <= 25) %>%
  mutate(age = mapvalues(age, age_orig, age_cat))

out_long <- pre_outcome %>%
  group_by(item) %>%
  mutate(value = ifelse(reverse_code != "rev", value,
                        reverse.code(-1, value, mini = 1, maxi = 4))) %>%
  ungroup() %>%
  mutate(item = gsub("chld", "", category)) %>%
  group_by(PROC_CID, item, age, year) %>%
  summarize(value = mean(value, na.rm = T)) %>%
  ungroup() %>%
  mutate(age0 = age-14)


# join with matching data

match_full <- out_long %>% filter(age == 14) %>%
  select(PROC_CID, item, value) %>% 
  spread(item, value) %>%
  right_join(match_groups) %>%
  distinct(PROC_CID, .keep_all = TRUE) %>%
  select(-item)



# missing values were labeled NaN so switched to NA for MI procedure

match_full$BrnWkWnDueDate[is.nan(match_full$BrnWkWnDueDate)] <- NA
match_full$BrthLnth[is.nan(match_full$BrthLnth)] <- NA
match_full$BrthWght[is.nan(match_full$BrthWght)] <- NA
match_full$CSecBrth[is.nan(match_full$CSecBrth)] <- NA
match_full$DaysHosBrth[is.nan(match_full$DaysHosBrth)] <- NA
match_full$DemBirthOrder[is.nan(match_full$DemBirthOrder)] <- NA
match_full$DemMVitamin[is.nan(match_full$DemMVitamin)] <- NA
match_full$DemRace[is.nan(match_full$DemRace)] <- NA
match_full$Dr4Ill1stYr[is.nan(match_full$Dr4Ill1stYr)] <- NA
match_full$MDrugsPreg[is.nan(match_full$MDrugsPreg)] <- NA
match_full$MRedPreg[is.nan(match_full$MRedPreg)] <- NA
match_full$MSmoke[is.nan(match_full$MSmoke)] <- NA
match_full$MVitamin[is.nan(match_full$MVitamin)] <- NA
match_full$NumWkEarLt[is.nan(match_full$NumWkEarLt)] <- NA
```
### Scale Reliability
```{r}
# outcome dataset grouped by both category (i.e. personality trait) and item so reliability could be calculated 

outcome_alpha <- pre_outcome %>%
  unite(item, category, item, sep = ".") %>%
  group_by(item) %>%
  mutate(value = ifelse(reverse_code != "rev", value,
                        reverse.code(-1, value, mini = 1, maxi = 4))) %>%
  ungroup() %>%
  mutate(item = gsub("chld", "", item)) %>%
  group_by(PROC_CID, item, age, year) %>%
  summarize(value = mean(value, na.rm = T)) %>%
  ungroup()

alpha_fun <- function(df){
  (df %>% select(PROC_CID, item, value) %>%
    spread(key = item, value = value) %>%
    select(-PROC_CID) %>%
    psych::alpha(.))$total[1]
}

alpha.df <- outcome_alpha %>%
  separate(item, c("category", "item"), sep = "[.]") %>%
  filter(item != "Capable") %>%
  group_by(category, age) %>%
  nest() %>%
  mutate(alpha = map(data, alpha_fun)) %>% 
  select(alpha, category, age) %>%
  unnest(alpha) %>% 
  spread(key = category, value = raw_alpha) 

alpha.df %>%
  kable(., format = "html", booktabs = T, digits = 2,
    caption = "Cronbach's Alpha  Over Ages") %>%
    kable_styling(latex_options = c("striped","repeat_header"),
                  full_width = F)
```

# Multiple Imputation
## MI: Pre-Work Correlations
```{r}
#view missingness pattern

r <- match_full %>% select(-PROC_CID, -PROC_MID) %>% mutate_all(funs(as.numeric)) %>% cor(., use = "pairwise")

data.frame(r) %>% mutate(var = colnames(.)) %>%
  gather(key = var2, value = value, -var) %>%
  mutate(value = ifelse(var == var2, 0, value)) %>%
  ggplot(aes(x = var, y = var2, fill = value)) +
  geom_raster() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red",
                       limit = c(-1,1), midpoint = 0) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
```
## MI: Procedure
```{r}
outcome_subs <- unique(as.character(out_long$PROC_CID))
match_subs <- unique(as.character(match_full$PROC_CID))
group_subs <- unique(as.character(groups_wide$PROC_CID))

# figure out which subjects have grouping, matching, predictor, and outcome data
subs <- match_subs[match_subs %in% group_subs]
subs <- subs[subs %in% outcome_subs]

# keep only those people
match_full_MI <- match_full %>% filter(PROC_CID %in% subs)
out_long_MI <- out_long %>% filter(PROC_CID %in% subs)


# MI doesn't like tibbles, so we need to unclass and reclass the data
match_full_MI <- data.frame(unclass(match_full_MI)) # mi doesn't like tibbles
nlsy_mdf <- missing_data.frame(data.frame(unclass(match_full_MI)))

image(nlsy_mdf)


# run MI
des <- describe(match_full_MI,fast = T)
nlsy_mdf <- change(data = nlsy_mdf, y = rownames(des)[des$range >= 3],
                   what = "type", to = "continuous")
nlsy_mdf <- change(data = nlsy_mdf, y = c("DemPweight", "DemPheight"),
                   what = "type", to = "continuous")

nlsy_mi <- mi(nlsy_mdf, n.chains = 10, n.iter = 20, parallel = T)

image(nlsy_mi)

completed_nlsy <- mi::complete(nlsy_mi)


# organize data

clean.mi.fun <- function(df, chain){
  df <- tbl_df(df) %>% select(-contains("missing_"))
}

nested_mi <- 
  tibble(chain = paste("chain", 1:10, sep = "."), data = completed_nlsy) %>%
  mutate(imp.data = map2(data, chain, possibly(clean.mi.fun, NA_real_)))

nested_mi <- nested_mi %>% mutate(match_set = "selection") %>%
  bind_rows(nested_mi %>% mutate(match_set = "socialization"))
```






# Piecewise Models
## Gen Sub
### Data
```{r}
group_wide_ageI <- group_wide %>%
  mutate(init_age = ifelse(DrugYes == 1, age, 100)) %>% # filtering out the measurement occasions for non-users that still 
                                                        # have ages by giving them an implausible value
  group_by(PROC_CID) %>%
  mutate(init_age = min(init_age)) %>%
  filter(init_age != 100)


new_spline_data <- group_wide_ageI %>%
  full_join(out_long) %>% # join with outcome data
  select(-PROC_MID, -DemCSex, -age0, -year) %>%
  filter(!is.na(DrugYes)) %>%
  rename(ageI = init_age) %>%
  ungroup() %>%
  mutate(cen_ageI = age - ageI) %>% # centering age around each person's age of initiation 
  mutate(cen_ageI_2 = (cen_ageI + 2)/2) %>% # moving the centered age to the measurement occasion that was two years before 
                                            # they reported their first use and scaling it to match our bi-annual measurement occasion schedule
  mutate(GMC_ageI = (scale(ageI, center = T, scale = F))/2) %>% # grand mean centering age of initiation and similarly scaling it - centering around age of initiation                                                vs age of 2 years before initiation are equivalent so kept it age of initiation just for ease of quick interpretability 
  mutate(GMC_ageI = round(GMC_ageI, digits = 2)) %>%
  mutate(PostInit = ifelse(cen_ageI < 0, 0, 1)) %>% # dummy coded variable indicating if initiation has occurred - helps to differences initiation period vs post-initiation period
  spread(item, value) %>%
  filter(!(is.na(CESD) & is.na(Impls) & is.na(SelfEstm) & is.na(SensSeek))) # got rid of the waves where participants have substance use data but no personality data whatsoever


new_spline_data$PostInit <- as.factor(new_spline_data$PostInit)
```

### Models
```{r}
PW_gen_imp <- lmer(Impls ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data)
summary(PW_gen_imp1)

PW_gen_SS <- lmer(SensSeek ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data)
summary(PW_gen_SS)

PW_gen_dep <- lmer(CESD ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data)
summary(PW_gen_dep)


PW_gen_SE <- lmer(SelfEstm ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data)
summary(PW_gen_SE)
```

### Contrasts
```{r}
# contrast matrix for impulsivity and sensation-seeking - longer than the one below since the models include an interaction term
region_matrix <- matrix(c(0,1,1,0,1,0,  0,1,0,0,1,0, 0,1,0,0,0,0), nrow = 3, ncol = 6, byrow = TRUE)
rownames(region_matrix) <- c("Start of Initiation Period vs End of Initiation Period", "Pre-Initiation Slope vs Initiation Period Slope", "Initiation Period Slope vs Post-Initiation Slope")

# contrast matrix for depression and self-esteem
sm_region_matrix <- matrix(c(0,1,1,0,0, 0,1,0,0,0), nrow = 2, ncol = 5, byrow = TRUE)
rownames(sm_region_matrix) <- c("Start of Initiation Period vs End of Initiation Period", "Initiation Period Slope vs Pre- and Post-Initiation Slopes")


#impls 
summary(multcomp::glht(PW_gen_SS, linfct = region_matrix, alternative = "two.sided"))
gen_impls_glht <- confint(summary(multcomp::glht(PW_gen_imp, linfct = region_matrix, alternative = "two.sided", calpha = multcomp::univariate_calpha())))
gen_imp_glht <- gen_impls_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


#SS 
summary(multcomp::glht(PW_gen_SS, linfct = region_matrix, alternative = "two.sided"))
gen_SS_glht <- confint(summary(multcomp::glht(PW_gen_SS, linfct = region_matrix, alternative = "two.sided", calpha = multcomp::univariate_calpha())))
gen_SS_glht <- gen_SS_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


#dep 
summary(multcomp::glht(PW_gen_dep, linfct = sm_region_matrix, alternative = "two.sided"))
gen_dep_glht <- confint(summary(multcomp::glht(PW_gen_dep, linfct = sm_region_matrix, alternative = "two.sided")))
gen_dep_glht <- gen_dep_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


#SE 
summary(multcomp::glht(PW_gen_SE, linfct = sm_region_matrix, alternative = "two.sided"))
gen_SE_glht <- confint(summary(multcomp::glht(PW_gen_SE, linfct = sm_region_matrix, alternative = "two.sided")))
gen_SE_glht <- gen_SE_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


gen_glht <- cbind(gen_impls_glht, gen_SS_glht, gen_dep_glht, gen_SE_glht)
rownames(gen_glht) <- c("Start of Initiation Period vs End of Initiation Period", "Pre-Initiation Slope vs Initiation Period Slope", "Initiation Period Slope vs Post-Initiation Slope")
```


## Alcohol
### Data
```{r}
new_spline_data_alc <- group_wide_ageI %>%
  select(PROC_CID, age, Alcohol, init_age) %>%
  mutate(init_age = ifelse(Alcohol == 1, age, 100)) %>%
  rename(ageI = init_age) %>%
  group_by(PROC_CID) %>%
  mutate(ageI = min(ageI)) %>%
  filter(ageI != 100) %>%
  full_join(out_long) %>%
  select(-age0, -year) %>%
  filter(!is.na(Alcohol)) %>%
  ungroup() %>%
  mutate(cen_ageI = age - ageI) %>%
  mutate(cen_ageI_2 = (cen_ageI + 2)/2) %>%
  mutate(GMC_ageI = (scale(ageI, center = T, scale = F))/2) %>%
  mutate(GMC_ageI = round(GMC_ageI, digits = 2)) %>%
  mutate(PostInit = ifelse(cen_ageI < 0, 0, 1)) %>%
  spread(item, value) %>%
  filter(!(is.na(CESD) & is.na(Impls) & is.na(SelfEstm) & is.na(SensSeek)))


new_spline_data_alc$PostInit <- as.factor(new_spline_data_alc$PostInit)
```

### Models
```{r}
PW_alc_imp <- lmer(Impls ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_alc)
summary(PW_alc_imp)

PW_alc_SS <- lmer(SensSeek ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_alc)
summary(PW_alc_SS)

PW_alc_dep <- lmer(CESD ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_alc)
summary(PW_alc_dep)

PW_alc_SE <- lmer(SelfEstm ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_alc)
summary(PW_alc_SE)
```

### Contrasts
```{r}

#impls 
summary(multcomp::glht(PW_alc_imp, linfct = region_matrix, alternative = "two.sided"))
alc_impls_glht <- confint(summary(multcomp::glht(PW_alc_imp, linfct = region_matrix, alternative = "two.sided")))
alc_impls_glht <- alc_impls_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


#SS 
summary(multcomp::glht(PW_alc_SS, linfct = region_matrix, alternative = "two.sided"))
alc_SS_glht <- confint(summary(multcomp::glht(PW_alc_SS, linfct = region_matrix, alternative = "two.sided")))
alc_SS_glht <- alc_SS_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#dep 
summary(multcomp::glht(PW_alc_dep, linfct = region_matrix, alternative = "two.sided"))
alc_dep_glht <- confint(summary(multcomp::glht(PW_alc_dep, linfct = region_matrix, alternative = "two.sided")))
alc_dep_glht <- alc_dep_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SE 
summary(multcomp::glht(PW_alc_SE, linfct = region_matrix, alternative = "two.sided"))
alc_SE_glht <- confint(summary(multcomp::glht(PW_alc_SE, linfct = region_matrix, alternative = "two.sided")))
alc_SE_glht <- alc_SE_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


alc_glht <- cbind(alc_impls_glht, alc_SS_glht, alc_dep_glht, alc_SE_glht)
rownames(alc_glht) <- c("Start of Initiation Period vs End of Initiation Period", "Pre-Initiation Slope vs Initiation Period Slope", "Initiation Period Slope vs Post-Initiation Slope")
```

## Cig
### Data
```{r}
new_spline_data_cig <- group_wide_ageI %>%
  select(PROC_CID, age, Cig, init_age) %>%
  mutate(init_age = ifelse(Cig == 1, age, 100)) %>%
  rename(ageI = init_age) %>%
  group_by(PROC_CID) %>%
  mutate(ageI = min(ageI)) %>%
  filter(ageI != 100) %>%
  full_join(out_long) %>%
  select(-age0, -year) %>%
  filter(!is.na(Cig)) %>%
  ungroup() %>%
  mutate(cen_ageI = age - ageI) %>%
  mutate(cen_ageI_2 = (cen_ageI + 2)/2) %>%
  mutate(GMC_ageI = (scale(ageI, center = T, scale = F))/2) %>%
  mutate(GMC_ageI = round(GMC_ageI, digits = 2)) %>%
  mutate(PostInit = ifelse(cen_ageI < 0, 0, 1)) %>%
  spread(item, value) %>%
  filter(!(is.na(CESD) & is.na(Impls) & is.na(SelfEstm) & is.na(SensSeek)))

new_spline_data_cig$PostInit <- as.factor(new_spline_data_cig$PostInit)
```

### Models
```{r}
PW_cig_imp <- lmer(Impls ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_cig, control = lmerControl(optimizer = "bobyqa"))
summary(PW_cig_imp)

PW_cig_SS <- lmer(SensSeek ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_cig)
summary(PW_cig_SS)

PW_cig_dep <- lmer(CESD ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_cig)
summary(PW_cig_dep)

PW_cig_SE <- lmer(SelfEstm ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_cig)
summary(PW_cig_SE)
```

### Contrasts
```{r}

#impls 
summary(multcomp::glht(PW_cig_imp, linfct = region_matrix, alternative = "two.sided"))
cig_impls_glht <- confint(summary(multcomp::glht(PW_cig_imp, linfct = region_matrix, alternative = "two.sided")))
cig_impls_glht <- cig_impls_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SS 
summary(multcomp::glht(PW_cig_SS, linfct = region_matrix, alternative = "two.sided"))
cig_SS_glht <- confint(summary(multcomp::glht(PW_cig_SS, linfct = region_matrix, alternative = "two.sided")))
cig_SS_glht <- cig_SS_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#dep 
summary(multcomp::glht(PW_cig_dep, linfct = sm_region_matrix, alternative = "two.sided"))
cig_dep_glht <- confint(summary(multcomp::glht(PW_cig_dep, linfct = sm_region_matrix, alternative = "two.sided")))
cig_dep_glht <- cig_dep_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


#SE 
summary(multcomp::glht(PW_cig_SE, linfct = sm_region_matrix, alternative = "two.sided"))
cig_SE_glht <- confint(summary(multcomp::glht(PW_cig_SE, linfct = sm_region_matrix, alternative = "two.sided")))
cig_SE_glht <- cig_SE_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)
```


## Coke
### Data
```{r}
new_spline_data_coke <- group_wide_ageI %>%
  select(PROC_CID, age, Coke, init_age) %>%
  mutate(init_age = ifelse(Coke == 1, age, 100)) %>%
  rename(ageI = init_age) %>%
  group_by(PROC_CID) %>%
  mutate(ageI = min(ageI)) %>%
  filter(ageI != 100) %>%
  full_join(out_long) %>%
  select(-age0, -year) %>%
  filter(!is.na(Coke)) %>%
  ungroup() %>%
  mutate(cen_ageI = age - ageI) %>%
  mutate(cen_ageI_2 = (cen_ageI + 2)/2) %>%
  mutate(GMC_ageI = (scale(ageI, center = T, scale = F))/2) %>%
  mutate(GMC_ageI = round(GMC_ageI, digits = 2)) %>%
  mutate(PostInit = ifelse(cen_ageI < 0, 0, 1)) %>%
  spread(item, value) %>%
  filter(!(is.na(CESD) & is.na(Impls) & is.na(SelfEstm) & is.na(SensSeek)))


new_spline_data_coke$PostInit <- as.factor(new_spline_data_coke$PostInit)

new_spline_data_coke <- new_spline_data_coke %>%
  filter(!is.na(Coke))
```

### Models
```{r}
PW_coke_imp <- lmer(Impls ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_coke)
summary(PW_coke_imp)

PW_coke_SS <- lmer(SensSeek ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_coke)
summary(PW_coke_SS)

PW_coke_dep <- lmer(CESD ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_coke)
summary(PW_coke_dep)

PW_coke_SE <- lmer(SelfEstm ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_coke)
summary(PW_coke_SE)
```

### Contrasts
```{r}

#impls 
summary(multcomp::glht(PW_coke_imp, linfct = region_matrix, alternative = "two.sided"))
coke_impls_glht <- confint(summary(multcomp::glht(PW_coke_imp, linfct = region_matrix, alternative = "two.sided")))
coke_impls_glht <- coke_impls_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


#SS 
summary(multcomp::glht(PW_coke_SS, linfct = region_matrix, alternative = "two.sided"))
coke_SS_glht <- confint(summary(multcomp::glht(PW_coke_SS, linfct = region_matrix, alternative = "two.sided")))
coke_SS_glht <- coke_SS_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#dep 
summary(multcomp::glht(PW_coke_dep, linfct = sm_region_matrix, alternative = "two.sided"))
coke_dep_glht <- confint(summary(multcomp::glht(PW_coke_dep, linfct = sm_region_matrix, alternative = "two.sided")))
coke_dep_glht <- coke_dep_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SE no
summary(multcomp::glht(PW_coke_SE, linfct = sm_region_matrix, alternative = "two.sided"))
coke_SE_glht <- confint(summary(multcomp::glht(PW_coke_SE, linfct = sm_region_matrix, alternative = "two.sided")))
coke_SE_glht <- coke_SE_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

coke_glht <- cbind(coke_impls_glht, coke_SS_glht, coke_dep_glht, coke_SE_glht)
```

## Halluc
### Data
```{r}
new_spline_data_halluc <- group_wide_ageI %>%
  select(PROC_CID, age, Halluc, init_age) %>%
  mutate(init_age = ifelse(Halluc == 1, age, 100)) %>%
  rename(ageI = init_age) %>%
  group_by(PROC_CID) %>%
  mutate(ageI = min(ageI)) %>%
  filter(ageI != 100) %>%
  full_join(out_long) %>%
  select(-age0, -year) %>%
  filter(!is.na(Halluc)) %>%
  ungroup() %>%
  mutate(cen_ageI = age - ageI) %>%
  mutate(cen_ageI_2 = (cen_ageI + 2)/2) %>%
  mutate(GMC_ageI = (scale(ageI, center = T, scale = F))/2) %>%
  mutate(GMC_ageI = round(GMC_ageI, digits = 2)) %>%
  mutate(PostInit = ifelse(cen_ageI < 0, 0, 1)) %>%
  spread(item, value) %>%
  filter(!(is.na(CESD) & is.na(Impls) & is.na(SelfEstm) & is.na(SensSeek)))


new_spline_data_halluc$PostInit <- as.factor(new_spline_data_halluc$PostInit)

```

### Models
```{r}
PW_halluc_imp <- lmer(Impls ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_halluc)
summary(PW_halluc_imp)

PW_halluc_SS <- lmer(SensSeek ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_halluc, control = lmerControl(optimizer = "bobyqa"))
summary(PW_halluc_SS)

PW_halluc_dep <- lmer(CESD ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_halluc)
summary(PW_halluc_dep)

PW_halluc_SE <- lmer(SelfEstm ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_halluc)
summary(PW_halluc_SE)

```

### Contrasts
```{r}

#impls 
summary(multcomp::glht(PW_halluc_imp, linfct = region_matrix, alternative = "two.sided"))
halluc_impls_glht <- confint(summary(multcomp::glht(PW_halluc_imp, linfct = region_matrix, alternative = "two.sided")))
halluc_impls_glht <- halluc_impls_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SS 
summary(multcomp::glht(PW_halluc_SS, linfct = region_matrix, alternative = "two.sided"))
halluc_SS_glht <- confint(summary(multcomp::glht(PW_halluc_SS, linfct = region_matrix, alternative = "two.sided")))
halluc_SS_glht <- halluc_SS_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#dep 
summary(multcomp::glht(PW_halluc_dep, linfct = sm_region_matrix, alternative = "two.sided"))
halluc_dep_glht <- confint(summary(multcomp::glht(PW_halluc_dep, linfct = sm_region_matrix, alternative = "two.sided")))
halluc_dep_glht <- halluc_dep_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SE 
summary(multcomp::glht(PW_halluc_SE, linfct = sm_region_matrix, alternative = "two.sided"))
halluc_SE_glht <- confint(summary(multcomp::glht(PW_halluc_SE, linfct = sm_region_matrix, alternative = "two.sided")))
halluc_SE_glht <- halluc_SE_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


halluc_glht <- cbind(halluc_impls_glht, halluc_SS_glht, halluc_dep_glht, halluc_SE_glht)
```

## Mar
### Data
```{r}
new_spline_data_mar <- group_wide_ageI %>%
  select(PROC_CID, age, Mar, init_age) %>%
  mutate(init_age = ifelse(Mar == 1, age, 100)) %>%
  rename(ageI = init_age) %>%
  group_by(PROC_CID) %>%
  mutate(ageI = min(ageI)) %>%
  filter(ageI != 100) %>%
  full_join(out_long) %>%
  select(-age0, -year) %>%
  filter(!is.na(Mar)) %>%
  ungroup() %>%
  mutate(cen_ageI = age - ageI) %>%
  mutate(cen_ageI_2 = (cen_ageI + 2)/2) %>%
  mutate(GMC_ageI = (scale(ageI, center = T, scale = F))/2) %>%
  mutate(GMC_ageI = round(GMC_ageI, digits = 2)) %>%
  mutate(PostInit = ifelse(cen_ageI < 0, 0, 1)) %>%
  spread(item, value) %>%
  filter(!(is.na(CESD) & is.na(Impls) & is.na(SelfEstm) & is.na(SensSeek)))


new_spline_data_mar$PostInit <- as.factor(new_spline_data_mar$PostInit)
```

### Models
```{r}
PW_mar_imp <- lmer(Impls ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_mar)
summary(PW_mar_imp)

PW_mar_SS <- lmer(SensSeek ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_mar)
summary(PW_mar_SS)

PW_mar_dep <- lmer(CESD ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_mar)
summary(PW_mar_dep)

PW_mar_SE <- lmer(SelfEstm ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_mar)
summary(PW_mar_SE)
```

### Contrasts
```{r}
#impls 
summary(multcomp::glht(PW_mar_imp, linfct = region_matrix, alternative = "two.sided"))
mar_impls_glht <- confint(summary(multcomp::glht(PW_mar_imp, linfct = region_matrix, alternative = "two.sided")))
mar_impls_glht <- mar_impls_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SS 
summary(multcomp::glht(PW_mar_SS, linfct = region_matrix, alternative = "two.sided"))
mar_SS_glht <- confint(summary(multcomp::glht(PW_mar_SS, linfct = region_matrix, alternative = "two.sided")))
mar_SS_glht <- mar_SS_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#dep 
summary(multcomp::glht(PW_mar_dep, linfct = sm_region_matrix, alternative = "two.sided"))
mar_dep_glht <- confint(summary(multcomp::glht(PW_mar_dep, linfct = sm_region_matrix, alternative = "two.sided")))
mar_dep_glht <- mar_dep_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SE 
summary(multcomp::glht(PW_mar_SE, linfct = sm_region_matrix, alternative = "two.sided"))
mar_SE_glht <- confint(summary(multcomp::glht(PW_mar_SE, linfct = sm_region_matrix, alternative = "two.sided")))
mar_SE_glht <- mar_SE_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


mar_glht <- cbind(mar_impls_glht, mar_SS_glht, mar_dep_glht, mar_SE_glht)

```


## SH
### Data
```{r}
new_spline_data_SH <- group_wide_ageI %>%
  select(PROC_CID, age, SH, init_age) %>%
  mutate(init_age = ifelse(SH == 1, age, 100)) %>%
  rename(ageI = init_age) %>%
  group_by(PROC_CID) %>%
  mutate(ageI = min(ageI)) %>%
  filter(ageI != 100) %>%
  full_join(out_long) %>%
  select(-age0, -year) %>%
  filter(!is.na(SH)) %>%
  ungroup() %>%
  mutate(cen_ageI = age - ageI) %>%
  mutate(cen_ageI_2 = (cen_ageI + 2)/2) %>%
  mutate(GMC_ageI = (scale(ageI, center = T, scale = F))/2) %>%
  mutate(GMC_ageI = round(GMC_ageI, digits = 2)) %>%
  mutate(PostInit = ifelse(cen_ageI < 0, 0, 1)) %>%
  spread(item, value) %>%
  filter(!(is.na(CESD) & is.na(Impls) & is.na(SelfEstm) & is.na(SensSeek)))


new_spline_data_SH$PostInit <- as.factor(new_spline_data_SH$PostInit)
```

### Models
```{r}
PW_SH_imp <- lmer(Impls ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_SH)
summary(PW_SH_imp)

PW_SH_SS <- lmer(SensSeek ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_SH)
summary(PW_SH_SS)

PW_SH_dep <- lmer(CESD ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_SH)
summary(PW_SH_dep)

PW_SH_SE <- lmer(SelfEstm ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_SH)
summary(PW_SH_SE)

```

### Contrasts
```{r}

#impls 
summary(multcomp::glht(PW_SH_imp, linfct = region_matrix, alternative = "two.sided"))
SH_impls_glht <- confint(summary(multcomp::glht(PW_SH_imp, linfct = region_matrix, alternative = "two.sided")))
SH_impls_glht <- SH_impls_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SS 
summary(multcomp::glht(PW_SH_SS, linfct = region_matrix, alternative = "two.sided"))
SH_SS_glht <- confint(summary(multcomp::glht(PW_SH_SS, linfct = region_matrix, alternative = "two.sided")))
SH_SS_glht <- SH_SS_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#dep 
summary(multcomp::glht(PW_SH_dep, linfct = sm_region_matrix, alternative = "two.sided"))
SH_dep_glht <- confint(summary(multcomp::glht(PW_SH_dep, linfct = sm_region_matrix, alternative = "two.sided")))
SH_dep_glht <- SH_dep_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SE 
summary(multcomp::glht(PW_SH_SE, linfct = sm_region_matrix, alternative = "two.sided"))
SH_SE_glht <- confint(summary(multcomp::glht(PW_SH_SE, linfct = sm_region_matrix, alternative = "two.sided")))
SH_SE_glht <- SH_SE_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)


SH_glht <- cbind(SH_impls_glht, SH_SS_glht, SH_dep_glht, SH_SE_glht)
```

## UD
### Data
```{r}
new_spline_data_UD <- group_wide_ageI %>%
  select(PROC_CID, age, UD, init_age) %>%
  mutate(init_age = ifelse(UD == 1, age, 100)) %>%
  rename(ageI = init_age) %>%
  group_by(PROC_CID) %>%
  mutate(ageI = min(ageI)) %>%
  filter(ageI != 100) %>%
  full_join(out_long) %>%
  select(-age0, -year) %>%
  filter(!is.na(UD)) %>%
  ungroup() %>%
  mutate(cen_ageI = age - ageI) %>%
  mutate(cen_ageI_2 = (cen_ageI + 2)/2) %>%
  mutate(GMC_ageI = (scale(ageI, center = T, scale = F))/2) %>%
  mutate(GMC_ageI = round(GMC_ageI, digits = 2)) %>%
  mutate(PostInit = ifelse(cen_ageI < 0, 0, 1)) %>%
  spread(item, value) %>%
  filter(!(is.na(CESD) & is.na(Impls) & is.na(SelfEstm) & is.na(SensSeek)))


new_spline_data_UD$PostInit <- as.factor(new_spline_data_UD$PostInit)
```

### Models
```{r}
PW_UD_imp <- lmer(Impls ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_UD)
summary(PW_UD_imp)

PW_UD_SS <- lmer(SensSeek ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 + cen_ageI_2 | PROC_CID), data = new_spline_data_UD)
summary(PW_UD_SS)

PW_UD_dep <- lmer(CESD ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_UD)
summary(PW_UD_dep)

PW_UD_SE <- lmer(SelfEstm ~ 1 + PostInit + cen_ageI_2 + GMC_ageI + PostInit:cen_ageI_2 + PostInit:GMC_ageI + (1 | PROC_CID), data = new_spline_data_UD)
summary(PW_UD_SE)

```

### Contrasts
```{r}
#impls 
summary(multcomp::glht(PW_UD_imp, linfct = region_matrix, alternative = "two.sided"))
UD_impls_glht <- confint(summary(multcomp::glht(PW_UD_imp, linfct = region_matrix, alternative = "two.sided")))
UD_impls_glht <- UD_impls_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SS 
summary(multcomp::glht(PW_UD_SS, linfct = region_matrix, alternative = "two.sided"))
UD_SS_glht <- confint(summary(multcomp::glht(PW_UD_SS, linfct = region_matrix, alternative = "two.sided")))
UD_SS_glht <- UD_SS_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#dep 
summary(multcomp::glht(PW_UD_dep, linfct = sm_region_matrix, alternative = "two.sided"))
UD_dep_glht <- confint(summary(multcomp::glht(PW_UD_dep, linfct = sm_region_matrix, alternative = "two.sided")))
UD_dep_glht <- UD_dep_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

#SE 
summary(multcomp::glht(PW_UD_SE, linfct = sm_region_matrix, alternative = "two.sided"))
UD_SE_glht <- confint(summary(multcomp::glht(PW_UD_SE, linfct = sm_region_matrix, alternative = "two.sided")))
UD_SE_glht <- UD_SE_glht$confint %>% data.frame() %>% mutate(CI = sprintf("[%.2f, %.2f]", lwr, upr)) %>% select(-lwr, -upr)

UD_glht <- cbind(UD_impls_glht, UD_SS_glht, UD_dep_glht, UD_SE_glht)
```








# General Substance Use
## Propensity Score Weighting
### PSW: Raw Group Differences
```{r}
match_full_MI <- match_full_MI %>%
  left_join((group_demo_wide %>% select(-DrugYes)))

match_full_MI$Alcohol <- as.factor(match_full_MI$Alcohol)
match_full_MI$Cig <- as.factor(match_full_MI$Cig)
match_full_MI$Coke <- as.factor(match_full_MI$Coke)
match_full_MI$Halluc <- as.factor(match_full_MI$Halluc)
match_full_MI$Mar <- as.factor(match_full_MI$Mar)
match_full_MI$SH <- as.factor(match_full_MI$SH)
match_full_MI$UD <- as.factor(match_full_MI$UD)


tempMI <- tbl_df(match_full_MI) %>% 
  group_by(groups) %>%
  summarize(n = n(), 
            `% Female` = sum(DemCSex == 2)/ sum(DemCSex %in% c(1,2)),
            `Mean Age 2020` = mean(2020 - Dem_DOBYear, na.rm = T)) 
  bind_rows(tempMI, tempMI %>% ungroup() %>% 
              summarize(n = sum(n), 
                        `% Female` = mean(`% Female`), groups = "Total",
                        `Mean Age 2020` = mean(`Mean Age 2020`))) %>%
  kable(., "html", #"latex", 
          escape = F, booktabs = T, digits = 2,
          col.names = c("Group", "N", "\\% Female", "Mean Age 2020")) %>%
  # kable_styling(latex_options = c("striped","repeat_header"),full_width = F)
    kable_styling(bootstrap_options = c("striped","repeat_header"),full_width = F)

```
### PSW: Raw Matching Variable Differences
```{r}
df <- tbl_df(completed_nlsy[[1]]) %>% select(-contains("missing"))
df <- df %>% select(-groups) %>%
  mutate_if(is.factor, funs(as.numeric(as.character(.)))) %>%
  full_join(df %>% select(PROC_CID, groups)) %>%
  gather(key = item, value = value, CESD:DemPheight) 

d_fun <- function(Item, V1, V2){
  dat <- df %>% filter(item == Item & groups %in% c(V1, V2)) %>%
    mutate(groups = factor(groups, levels = c(V1, V2)))
  d <- lsr::cohensD(value ~ groups, data = dat)
}  

keepMI <- expand.grid(
  Groups = c("NoDrugs-Drugs"),
  Item = unique(df$item),
  stringsAsFactors = F
) %>%
  tbl_df() %>%
  separate(Groups, c("V1", "V2")) %>%
  mutate(d = pmap_dbl(list(Item, V1, V2), d_fun))

keep_vars <- unique(keepMI$Item)
```
### PSW: Removing Labels
```{r}
#matchit didn't like labels for the factor variables


# selection
nested_mi[[3]][[1]]$groups_f <- dplyr::recode(nested_mi[[3]][[1]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[2]]$groups_f <- dplyr::recode(nested_mi[[3]][[2]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[3]]$groups_f <- dplyr::recode(nested_mi[[3]][[3]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[4]]$groups_f <- dplyr::recode(nested_mi[[3]][[4]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[5]]$groups_f <- dplyr::recode(nested_mi[[3]][[5]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[6]]$groups_f <- dplyr::recode(nested_mi[[3]][[6]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[7]]$groups_f <- dplyr::recode(nested_mi[[3]][[7]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[8]]$groups_f <- dplyr::recode(nested_mi[[3]][[8]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[9]]$groups_f <- dplyr::recode(nested_mi[[3]][[9]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[10]]$groups_f <- dplyr::recode(nested_mi[[3]][[10]]$groups, NoDrugs = 0, Drugs = 1)

# socialization
nested_mi[[3]][[11]]$groups_f <- dplyr::recode(nested_mi[[3]][[11]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[12]]$groups_f <- dplyr::recode(nested_mi[[3]][[12]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[13]]$groups_f <- dplyr::recode(nested_mi[[3]][[13]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[14]]$groups_f <- dplyr::recode(nested_mi[[3]][[14]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[15]]$groups_f <- dplyr::recode(nested_mi[[3]][[15]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[16]]$groups_f <- dplyr::recode(nested_mi[[3]][[16]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[17]]$groups_f <- dplyr::recode(nested_mi[[3]][[17]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[18]]$groups_f <- dplyr::recode(nested_mi[[3]][[18]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[19]]$groups_f <- dplyr::recode(nested_mi[[3]][[19]]$groups, NoDrugs = 0, Drugs = 1)
nested_mi[[3]][[20]]$groups_f <- dplyr::recode(nested_mi[[3]][[20]]$groups, NoDrugs = 0, Drugs = 1)
```
### PSW: Defining the Functions 
```{r}
# this function actually runs the propensity score weighting procedure
psw_fun <- function(df, match_set){
   if(match_set == "socialization"){
  to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","groups_f"))]
  } else{
    to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","groups_f",
                                            "CESD", "SelfEstm", "Impls", "SensSeek"))]
  }
  match.formula <- as.formula(paste("groups_f ~ ", paste(to.match, collapse=" + "), sep = " "))
  y <- matchit(match.formula, data = df, method = "nearest", caliper = .1, ratio = 4)
}


# changing the data fed into psw into a data frame because it won't work with tibbles
psw_df <- function(psw){psw$result <- data.frame(psw$result); psw}

psw_df <- function(psw){
  as.data.frame(match.data(psw))
}

## tables and plots

unbalanced_fun <- function(x){
  y <- summary(x, standardize = T)
  raw <- y$sum.all %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  smalldiff.var <- raw %>% filter(abs(`Std. Mean Diff.`) <= .05)
  matched <- y$sum.matched %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  unbalanced.var <- matched %>% filter(abs(`Std. Mean Diff.`) >= .2)
  return(list(raw = raw, matched = matched, 
              unbalanced = unbalanced.var,smalldiff = smalldiff.var))
}
```
### PSW: Running Matching
```{r}
#getting only those participants who started using substances after age 14

all_sub_good <- group_demo_wide %>%
  left_join(new_spline_data %>% select(PROC_CID, ageI)) %>%
  mutate(ageI = ifelse(is.na(ageI), 100, ageI)) %>%
  filter(ageI > 14)

allsubgood_subs <- unique(all_sub_good$PROC_CID)

nested_mi_allsub <- nested_mi %>%
  mutate(imp.data = map(imp.data, ~filter(.x, PROC_CID %in% allsubgood_subs)))

nested.psw <- nested_mi_allsub %>%
  mutate(imp.data = map(imp.data, function(x){x %>% select(PROC_CID, groups_f, one_of(keep_vars))}),
         psw = map2(imp.data, match_set, possibly(psw_fun, NA_real_)),
         psw.df = map(psw, possibly(psw_df, NA_real_)))



# larger dataset - used for tables/plots
nested.psw.table <- nested.psw %>%
  mutate(bal.df = map(psw, unbalanced_fun),
         raw = map(bal.df, ~.$raw),
         matched = map(bal.df, ~.$matched),
         unbal.tab = map(bal.df, possibly(~.$unbalanced, NA_real_)),
         smalldiff.tab = map(bal.df, possibly(~.$smalldiff, NA_real_)))
```
### PSW: Balance Tables 
```{r}
# this table shows matched variables
matched.tab <- nested.psw.table %>% 
   filter(match_set == "socialization") %>%
   unnest(matched) %>% 
   group_by(var) %>% 
   filter(var != "distance") %>% # this is the propensity score weight - don't want it in effect size calculations
   summarize(mean = mean(`Std. Mean Diff.`, na.rm = T)) 


 kable(matched.tab, "html", longtable = T, booktabs = T, digits = 2,
       caption = "Matched Variables after Propensity Score Weighting") %>%
   kable_styling(bootstrap_options = c("striped","repeat_header"),full_width = F) %>%
  scroll_box(width = "750px", height = "400px")
 
 
# this table shows raw variables
raw.tab.gen <- nested.psw.table %>% 
   filter(match_set == "socialization") %>%
   unnest(raw) %>% 
   group_by(var) %>% 
   filter(var != "distance") %>%
   summarize(mean = mean(`Std. Mean Diff.`, na.rm = T))


 kable(raw.tab, "html", longtable = T, booktabs = T, digits = 2,
       caption = "Raw Variables in Propensity Score Weighting") %>%
   kable_styling(bootstrap_options = c("striped","repeat_header"),full_width = F) %>%
  scroll_box(width = "750px", height = "400px")
 
 
 # this table shows variables that are not matched after weighting
unbal.tab <- nested.psw.table %>% 
  filter(match_set == "socialization") %>%
  unnest(unbal.tab) %>% 
  group_by(var) %>% 
  filter(var != "distance") %>%
  summarize(`Average Standardized Effect` = mean(`Std. Mean Diff.`, na.rm = T)) %>%
 

kable(unbal.tab, "html", longtable = T, booktabs = T,
       caption = "Unbalanced Variables after Propensity Score Weighting") %>%
  kable_styling(latex_options = c("striped","repeat_header"),full_width = F)
 
 
# this table shows variables that were already matched prior to weighting
smalldiff.tab <- nested.psw.table %>%  filter(match_set == "socialization") %>%
  unnest(smalldiff.tab, .drop = T) %>% 
  group_by(var) %>% 
  filter(var != "distance") %>%
  summarize(`Average Standardized Effect` = mean(`Std. Mean Diff.`, na.rm = T)) %>%


kable(smalldiff.tab, "html", # "latex", 
      longtable = T, booktabs = T,
      caption = "Balanced Variables after Propensity Score Weighting") %>%
  # kable_styling(latex_options = c("striped","repeat_header"),full_width = F)
  kable_styling(bootstrap_options = c("striped","repeat_header"),full_width = F) %>%
  scroll_box(width = "750px", height = "400px")
```
## Selection Effects
### Data
```{r}
nested.sel <- expand.grid(
  Trait = unique(out_long_MI$item),
  weight = c("weighted", "unweighted"),
  stringsAsFactors = F
  )

# function for running logistic regressions on imputed datasets

sel_fun <- function (trait, weight, ms){
  models <- lapply(1:10, function(x){
    print(paste(trait, x), sep = " ")
    df <- nested.all.sub %>% filter(chain == paste("chain", x, sep = ".") & match_set == ms) %>%
          unnest(imp.data.long) %>% 
          left_join(out_long_MI %>% filter(age == 14 & item == trait)) %>%
      filter(!is.na(item))
   if(weight != "weighted"){
      df$psw.weights <- rep(1, nrow(df))
    } 
      mod <- nnet::multinom(
        groups ~ value, data = df, weights = psw.weights
        )
  return(mod)
  })
}


nested.sel.gen <- nested.sel %>% 
  mutate(sel.mod = map2(Trait, weight, ~sel_fun(.x, .y, "selection")))

```
### Pool Results
```{r}
sel_pool_fun <- function(models, type){
  nchains <- length(models)
  nterms    <- nrow(vcov(models[[1]]))

  
  coefs     <- sapply(models, function(x) summary(x)$coefficients)
  names <- names(summary(models[[1]])$coefficients)
  variances <- sapply(models, FUN = function(x) diag(vcov(x)))
  
   # average effects for each term
  coefs_mean <- apply(coefs,     1, mean)
  var_mean   <- apply(variances, 1, mean)
  # variance of fixed effects
  coefs_var <- apply(coefs, 1, var)
  e <- t(coefs) - matrix(coefs_mean, nrow = nchains, ncol = nterms, byrow = TRUE)
  b <- (t(e) %*% e)/(nchains - 1)
  t <- var_mean + (1 + 1/nchains) * b
  r <- (1 + 1/nchains) * diag(b/var_mean)
  lambda <- (1 + 1/nchains) * diag(b/t)
  dfcom <- df.residual(models[[1]])
  if (is.null(dfcom)) {
    dfcom <- 999999
    warning("Large sample assumed.")
  }
  lambda[lambda < 1e-04] <- 1e-04
  dfold <- (nchains - 1)/lambda^2
  dfobs <- (dfcom + 1)/(dfcom + 3) * dfcom * (1 - lambda)
  df <- dfold * dfobs/(dfold + dfobs)
  se <- sqrt(diag(t))
  t.val <- coefs_mean/se
  p <- 2 * (1 - pt(abs(t.val), df = df))
  CI = qt(.975, df = df)*se
  fmi <- (r + 2/(df + 3))/(r + 1)
  names(r) <- names(df) <- names(fmi) <- names(lambda) <- names
  
  fixeff <- tibble(
    term = names,
    Estimate = coefs_mean,
    # t = t.val,
    CI.lower = coefs_mean-CI,
    CI.upper = coefs_mean+CI
  ) 
}
```
### Table Results
```{r}
nested.sel.gen <- nested.sel.gen %>%
  mutate(pool = map(sel.mod, possibly(sel_pool_fun, NA_real_)))


traits <- tibble(
  old = c("SensSeek", "Impls", "CESD", "SelfEstm"),
  new = c("Sensation-Seeking", "Impulsivity", "Depression", "Self-Esteem"),
  breaks = c("Sensation-\nSeeking", "Impulsivity", "Depression", "Self-\nEsteem")
)


sel.tab.gen <- nested.sel.gen %>%
  select(-sel.mod) %>%
  unnest(pool) %>% 
  mutate(sig = ifelse(sign(CI.lower) == sign(CI.upper), "sig", "ns")) %>%
  mutate(Trait = plyr::mapvalues(Trait, traits$old, traits$breaks),
         Trait = factor(Trait, levels = traits$breaks)) %>%
  mutate_at(vars(Estimate, CI.lower, CI.upper), funs(exp)) %>%
  filter(term == "value") %>%
  mutate(term = "GenSub")


# OR figure

sel.tab.gen %>% 
  filter(weight == "weighted") %>%
  ggplot(aes(x = term, y = Estimate)) +
    scale_color_manual(values = c("springgreen3", "blue")) +
    geom_hline(aes(yintercept = exp(0)), linetype = "dashed") +
    geom_errorbar(aes(ymin = CI.lower, ymax = CI.upper), width = .2, size = .75) +
    geom_point(aes(color = term), size = 4) +
    labs(y = "Odds", x = NULL) +
    facet_grid(.~Trait, scale = "free") +
    theme_classic() +
    theme(legend.position = "none",
          axis.text = element_text(face = "bold", size = rel(1.2)),
          axis.text.x = element_text(face = "bold", size = rel(1.2), hjust = 1, angle = 45),
          axis.title = element_text(face = "bold", size = rel(1.2)),
          strip.text = element_text(face = "bold", size = rel(1.2)))
```

## Socialization Effects: Trajectories
### Zero-Order Correlations
```{r}
r_fun <- function(df, Item){
  print(knitr::kable(
    (df %>% select(PROC_CID, age, value) %>%
    spread(age, value) %>%
    select(-PROC_CID) %>%
    cor(., use = "pairwise")),
    format = "html", booktabs = T, digits = 2,
    caption = sprintf("Correlations of %s Over Ages", Item)) %>%
    kable_styling(bootstrap_options = c("striped","repeat_header"),
                  full_width = F))
}

out_cor <- out_long_MI %>%
  filter(!is.na(value)) %>%
  group_by(item) %>%
  nest()

out_cor %>%
  mutate(r = map2(data, item, r_fun))
```
### Mean-Level Change
```{r}
# assessing general mean-level trends of personality for entire sample

ML_long <- out_long_MI %>%
  mutate(age0 = ifelse(item == "Impls" | item == "SensSeek", age - 10, age0),
         age0 = age0/5,
         age02 = (age0^2)) %>%
  spread(item, value)


ML_impls <- lmer(Impls ~ 1 + age0 + age02 + (1 + age0 | PROC_CID), data = ML_long, control = lmerControl(optimizer = "bobyqa"))
summary(ML_impls)

ML_SS <- lmer(SensSeek ~ 1 + age0 + age02 + (1 + age0 | PROC_CID), data = ML_long, control = lmerControl(optimizer = "bobyqa"))
summary(ML_SS)

ML_CESD <- lmer(CESD ~ 1 + age0 + age02 + (1 + age0 | PROC_CID), data = ML_long, control = lmerControl(optimizer = "bobyqa"))
summary(ML_CESD)

ML_SE <- lmer(SelfEstm ~ 1 + age0 + age02 + (1 + age0 | PROC_CID), data = ML_long, control = lmerControl(optimizer = "bobyqa"))
summary(ML_SE)

```
### Basic Models
```{r}
# adding the weights from PSW to the dataset used for models
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$groups_f
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "None", `1` = "Drugs")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  return(psw.df)
}

nested.all.sub <- nested.psw %>% 
  mutate(imp.data.long = map(psw.df, possibly(add_psw_weights, NA_real_)))

imp.data.allsub <- (nested.all.sub %>% filter(match_set == "socialization"))$imp.data.long


mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}


# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.allsub[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = age0/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}


nested.mods <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Define Functions
#### Pool Models
```{r}
pool_fun <- function(model, pool_re){
  nchains <- length(model)
#####
  ### Get FE's and RE's for pooling FE's across imputations ###
####
  fixeffs <- sapply(model, lme4::fixef)
  raneffs <- sapply(model, function(z) diag(matrix(vcov(summary(z))@x, 
                                                   nrow(fixeffs))))
  R2 <- sapply(model, MuMIn::r.squaredGLMM)
  rownames(raneffs) <- rownames(fixeffs)

  # average effects for each term
  fixeff_mean <- apply(fixeffs, 1, mean)
  raneff_mean <- apply(raneffs, 1, mean)
  R2_mean     <- apply(R2,      1, mean)
  
  # variance of fixed effects
  fixeff_var <- apply(fixeffs, 1, var)
  
  T <- raneff_mean + (1 + nchains^(-1)) * fixeff_var # ??
  r <- (1 + nchains^(-1)) * fixeff_var/raneff_mean# RIV value 
  df <- (nchains - 1) * (1 + r^(-1))^2
  se <- sqrt(T)
  t.val <- fixeff_mean/se
  p <- 2 * (1 - pt(abs(t.val), df = df))
  CI = qt(.975, df = df)*se
  
  
  CI_fun <- function(mod){
    CI <- confint.merMod(mod, method = "boot", nsim = 100, oldNames = TRUE)
    CI <- data.frame(CI) %>% mutate(term = rownames(.))
  }
  
    # variance and correlation components
  res <- tibble(chain = 1:10,
         model = model) %>%
    mutate(mod_tab = map(model, function(z) {
      tbl_df(broom::tidy(z)) %>% dplyr::filter(group != "fixed")}),
      CI = map(model, CI_fun))
  CI_ran <- res %>% select(chain, CI) %>% unnest(CI) %>% 
    setNames(c("chain", "CI.lower", "CI.upper", "term")) %>%
    filter(grepl(".sig", term)) %>%
    group_by(term) %>%
    summarize_at(vars(CI.lower, CI.upper), funs(mean)) %>%
    mutate(term = mapvalues(term, unique(term), 
            c("\\tau_{00}", "\\tau_{10}", "\\tau_{11}", "\\hat{\\sigma^2}")),
            CI.lower = CI.lower^2, CI.upper = CI.upper^2) 
  raneff <- res %>% select(mod_tab) %>%
    unnest(mod_tab) %>% group_by(term, group) %>% 
    summarize(Estimate = mean(estimate, na.rm = T), type = "raneff") %>%
    ungroup() %>%
    mutate(term = mapvalues(term, unique(term), c("\\tau_{10}", 
                      "\\tau_{00}", "\\tau_{11}", "\\hat{\\sigma^2}"))) %>%
    full_join(CI_ran) %>%
    mutate(CI = ifelse((abs(CI.lower) < .005 | abs(CI.upper) < .005) & 
                       (abs(CI.lower) > .0005 | abs(CI.upper) > .0005),
                           sprintf("[%.3f, %.3f]", CI.lower, CI.upper), 
                    ifelse((abs(CI.lower) < .0005 | abs(CI.upper) < .0005), 
                           sprintf("[%0.4e, %0.4e]", CI.lower, CI.upper),
                           sprintf("[%.2f, %.2f]", CI.lower, CI.upper)))) %>%
    select(-CI.lower, -CI.upper, -group)

  
  sd_re <- (pool_re %>% 
    summarize(sd = sd(`(Intercept)`, na.rm = T)))$sd
  
  fixeff <- tibble(
    type = rep("fixeff",nrow(fixeffs)),
    term = rownames(fixeffs),
    Estimate = fixeff_mean,
    t = t.val,
    CI.lower = fixeff_mean - CI,
    CI.upper = fixeff_mean + CI,
    CI = sprintf("[%.2f, %.2f]", fixeff_mean - CI, fixeff_mean + CI),
    p = p,
    d = fixeff_mean/rep(sd_re, length(fixeff_mean))
  )
  
  sum_mod <- tribble(
    ~type, ~term, ~Estimate,
    "summary", "R2m", R2_mean[1],
    "summary", "R2c", R2_mean[2])
  
  results <- fixeff %>% full_join(raneff) %>% full_join(sum_mod)
}
```
#### Pooled Random Effects
```{r}
# short function for pooling each person's random effects of the models
pooled_re_fun <- function(mods){
  tibble(chain = 1:10,
         coef = llply(mods, function(y){
           z <- coef(y)$PROC_CID
           z <- tbl_df(z) %>% mutate(PROC_CID = as.numeric(row.names(z))) })) %>%
    unnest(coef) %>%
    group_by(PROC_CID) %>%
    summarize_at(vars(-chain), funs(mean)) 
}
```
#### Pooled vcov() matrix
```{r}
pool_vcov <- function(model){
  nvar <- nrow(vcov(model[[1]]))
  varnames <- str_replace_all(colnames(vcov(model[[1]])), "[()]", "")
  if(any(grepl("age02", varnames))){
  varnames[grepl(":age02", varnames)] <- sprintf("age02:%s",
    str_replace(varnames[grepl(":age02", varnames)], ":age02", ""))
  }
  vcov_sum <- sapply(model, function(z) matrix(vcov(summary(z))@x, nvar))
  vcov_mean <- matrix(apply(vcov_sum, 1, mean), nrow = nvar)
  colnames(vcov_mean) <- varnames; rownames(vcov_mean) <- varnames
  return(vcov_mean)
}
```
#### Standard Error Function
```{r}
se_fun <- function(vcov_mat, x, m){
  se_map <- function(vcov, parameter, w){
    z <- 1
    vcov[parameter, parameter] + 2 * z * vcov[parameter, w] + z^2 * vcov[w, w]
  }
  cols <- colnames(vcov_mat)
  x <- cols[grepl(x,cols) & !grepl(":", cols)]
  se <- expand.grid(
    parameter = c("Intercept", x),
    term = m, 
    stringsAsFactors = T
  ) %>% tbl_df() %>%
    mutate(se = map2_dbl(parameter, term, ~se_map(vcov_mat, .x, .y)),
           parameter = str_replace(parameter, "0", ""),
           term = str_replace(term, "groups", ""), 
           term = ifelse(grepl("2", parameter) == T, sprintf("%s2", term), term),
           parameter = ifelse(parameter == "Intercept", parameter, "Slope"))
return(se)
}
```
#### Model Comparisons
```{r}
dev_fun <- function(mods){
  tibble(chain = 1:10,
         mdeviance = llply(mods, function(y){
          tibble(mdeviance = REMLcrit(y),
                 df = attr(logLik(y), "df"))})) %>%
    tidyr::unnest(mdeviance) %>%
    summarize(mdeviance = mean(mdeviance),
              df = mean(df))
}
```
#### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoDrugs_Intercept", "NoDrugs_Slope", "Drugs_Intercept",  "Drugs_Slope", "NoDrugs_Slope2", "Drugs_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoDrugs_Intercept", "NoDrugs_Slope", "Drugs_Intercept",  "Drugs_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}

# pool population and individual level effects
nested.mods <- nested.mods %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsDrugs"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))


# switching the pooled SD used for calculating cohen's d to the SD of the intercept variance random effect         
nested.mods.d <- nested.mods %>%
  select(pred, weighted, mod, pool) %>%
  unnest(pool) %>%
  filter(term == "\\tau_{00}") %>%
  mutate(new_sd = sqrt(Estimate)) %>%
  select(pred, weighted, mod, new_sd) %>%
  left_join(nested.mods %>% unnest(pool) %>% filter(type == "fixeff") %>% select(pred, weighted, mod, term, Estimate)) %>%
  mutate(new_d = Estimate/new_sd) %>%
  right_join(nested.mods %>% select(pred, weighted, mod, pool) %>% unnest(pool)) %>%
  group_by(pred, weighted, mod) %>%
  nest() %>%
  rename(pool = data) %>%
  left_join(nested.mods %>% select(-pool))

```
## Socialization Effects: End Intercept
### Basic Models
```{r}
mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.allsub[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = (age0 - 10)/5) %>% # centering around age 24 instead of 14
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.end <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.end <- nested.mods.end %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsDrugs"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))


nested.mods.end.d <- nested.mods.end %>%
  select(pred, weighted, mod, pool) %>%
  unnest(pool) %>%
  filter(term == "\\tau_{00}") %>%
  mutate(new_sd = sqrt(Estimate)) %>%
  select(pred, weighted, mod, new_sd) %>%
  left_join(nested.mods %>% unnest(pool) %>% filter(type == "fixeff") %>% select(pred, weighted, mod, term, Estimate)) %>%
  mutate(new_d = Estimate/new_sd) %>%
  right_join(nested.mods %>% select(pred, weighted, mod, pool) %>% unnest(pool)) %>%
  group_by(pred, weighted, mod) %>%
  nest() %>%
  rename(pool = data) %>%
  left_join(nested.mods %>% select(-pool))

```
# Alcohol
## Propensity Score Weighting
### Defining Functions
```{r}
# this function actually runs the propensity score weighting procedure
psw_fun <- function(df, match_set){
   if(match_set == "socialization"){
  to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Alcohol"))]
  } else{
    to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Alcohol",
                                            "CESD", "SelfEstm", "Impls", "SensSeek"))]
  }
  match.formula <- as.formula(paste("Alcohol ~ ", paste(to.match, collapse=" + "), sep = " "))
  y <- matchit(match.formula, data = df, method = "nearest", caliper = .1, ratio = 4)
}

unbalanced_fun <- function(x){
  y <- summary(x, standardize = T)
  raw <- y$sum.all %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  smalldiff.var <- raw %>% filter(abs(`Std. Mean Diff.`) <= .05)
  matched <- y$sum.matched %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  unbalanced.var <- matched %>% filter(abs(`Std. Mean Diff.`) >= .2)
  return(list(raw = raw, matched = matched, 
              unbalanced = unbalanced.var,smalldiff = smalldiff.var))
}
```
### Running Matching
```{r}
alc_good <- group_demo_wide %>%
  left_join(new_spline_data_alc %>% select(PROC_CID, ageI)) %>%
  mutate(ageI = ifelse(is.na(ageI), 100, ageI)) %>%
  filter(ageI > 14)

alc_subs <- unique(alc_good$PROC_CID)

nested_mi_alc <- nested_mi %>%
  mutate(imp.data = map(imp.data, ~filter(.x, PROC_CID %in% alc_subs)))


nested.psw.alc <- nested_mi_alc %>%
  mutate(imp.data = map(imp.data, function(x){x %>% select(PROC_CID, Alcohol, one_of(keep_vars))}),
         psw = map2(imp.data, match_set, possibly(psw_fun, NA_real_)),
         psw.df = map(psw, possibly(psw_df, NA_real_)))


nested.psw.table.alc <- nested.psw.alc %>%
  mutate(bal.df = map(psw, unbalanced_fun),
         raw = map(bal.df, ~.$raw),
         matched = map(bal.df, ~.$matched),
         unbal.tab = map(bal.df, possibly(~.$unbalanced, NA_real_)),
         smalldiff.tab = map(bal.df, possibly(~.$smalldiff, NA_real_)))
```

## Selection Effects: Alcohol
### Data
```{r}
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$Alcohol
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "NoAlc", `1` = "Alcohol")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  return(psw.df)
}


sel_fun <- function (trait, weight, ms){
  models <- lapply(1:10, function(x){
    print(paste(trait, x), sep = " ")
    df <- nested.psw.UD %>% filter(chain == paste("chain", x, sep = ".") & match_set == ms) %>%
          unnest(imp.data.long) %>% 
          left_join(out_long_MI %>% filter(age == 14 & item == trait)) %>%
      filter(!is.na(item))
   if(weight != "weighted"){
      df$psw.weights <- rep(1, nrow(df))
    } 
      mod <- nnet::multinom(
        groups ~ value, data = df, weights = psw.weights)
  return(mod)
  })
}


nested.sel.alc <- nested.sel %>% 
  mutate(sel.mod = map2(Trait, weight, ~sel_fun(.x, .y, "selection")))
```
### Table Results
```{r}
nested.sel.alc <- nested.sel.alc %>%
  mutate(pool = map(sel.mod, possibly(sel_pool_fun, NA_real_)))

sel.tab.alc <- nested.sel.alc %>%
  select(-sel.mod) %>%
  unnest(pool) %>% 
  mutate(sig = ifelse(sign(CI.lower) == sign(CI.upper), "sig", "ns")) %>%
  mutate(Trait = plyr::mapvalues(Trait, traits$old, traits$breaks),
         Trait = factor(Trait, levels = traits$breaks)) %>%
  mutate_at(vars(Estimate, CI.lower, CI.upper), funs(exp)) %>%
  filter(term == "value") %>%
  mutate(term = "Alcohol")

```


## Socialization Effects: Trajectories
### Basic Models
```{r}
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$Alcohol
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "NoAlc", `1` = "Alcohol")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  #mutate(groups = relevel(groups, "None"))
  return(psw.df)
}


nested.psw.alc <- nested.psw.alc %>% 
  mutate(imp.data.long = map(psw.df, possibly(add_psw_weights, NA_real_)))

imp.data.psw.alc <- (nested.psw.alc %>% filter(match_set == "socialization"))$imp.data.long


mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.alc[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = age0/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.alc <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad"),
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Define Functions
#### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoAlc_Intercept", "NoAlc_Slope", "Alcohol_Intercept",  "Alcohol_Slope", "NoAlc_Slope2", "Alcohol_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoAlc_Intercept", "NoAlc_Slope", "Alcohol_Intercept",  "Alcohol_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.alc <- nested.mods.alc %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsAlcohol"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))
```
## Socialization Effects: End Intercept 
### Basic Models
```{r}
mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.alc[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = (age0 - 10)/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.alc.end <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.alc.end <- nested.mods.alc.end %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsAlcohol"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))
```
# Cigarettes
## Propensity Score Weighting
### Defining Functions
```{r}
# this function actually runs the propensity score weighting procedure
psw_fun <- function(df, match_set){
   if(match_set == "socialization"){
  to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Cig"))]
  } else{
    to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Cig",
                                            "CESD", "SelfEstm", "Impls", "SensSeek"))]
  }
  match.formula <- as.formula(paste("Cig ~ ", paste(to.match, collapse=" + "), sep = " "))
  y <- matchit(match.formula, data = df, method = "nearest", caliper = .1, ratio = 4)
}

unbalanced_fun <- function(x){
  y <- summary(x, standardize = T)
  raw <- y$sum.all %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  smalldiff.var <- raw %>% filter(abs(`Std. Mean Diff.`) <= .05)
  matched <- y$sum.matched %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  unbalanced.var <- matched %>% filter(abs(`Std. Mean Diff.`) >= .2)
  return(list(raw = raw, matched = matched, 
              unbalanced = unbalanced.var,smalldiff = smalldiff.var))
}
```
### Running Matching
```{r}
cig_good <- group_demo_wide %>%
  left_join(new_spline_data_cig %>% select(PROC_CID, ageI)) %>%
  mutate(ageI = ifelse(is.na(ageI), 100, ageI)) %>%
  filter(ageI > 14)

cig_subs <- unique(cig_good$PROC_CID)

nested_mi_cig <- nested_mi %>%
  mutate(imp.data = map(imp.data, ~filter(.x, PROC_CID %in% cig_subs)))


nested.psw.cig <- nested_mi_cig %>%
  mutate(imp.data = map(imp.data, function(x){x %>% select(PROC_CID, Cig, one_of(keep_vars))}),
         psw = map2(imp.data, match_set, possibly(psw_fun, NA_real_)),
         psw.df = map(psw, possibly(psw_df, NA_real_)))



 nested.psw.cig.table <- nested.psw.cig %>%
  mutate(bal.df = map(psw, unbalanced_fun),
         raw = map(bal.df, ~.$raw),
         matched = map(bal.df, ~.$matched),
         unbal.tab = map(bal.df, possibly(~.$unbalanced, NA_real_)),
         smalldiff.tab = map(bal.df, possibly(~.$smalldiff, NA_real_)))
```
## Selection Effects 
### Data
```{r}
sel_fun <- function (trait, weight, ms){
  models <- lapply(1:10, function(x){
    # require(tidyverse); require(lavaan)
    print(paste(trait, x), sep = " ")
    df <- nested.psw.cig %>% filter(chain == paste("chain", x, sep = ".") & match_set == ms) %>%
          unnest(imp.data.long) %>% 
          left_join(out_long_MI %>% filter(age == 14 & item == trait)) %>%
      filter(!is.na(item))
   if(weight != "weighted"){
      df$psw.weights <- rep(1, nrow(df))
    } 
      mod <- nnet::multinom(
        groups ~ value, data = df, weights = psw.weights
        )
  return(mod)
  })
}

nested.sel.cig <- nested.sel %>% 
  mutate(sel.mod = map2(Trait, weight, ~sel_fun(.x, .y, "selection")))
```
### Table Results
```{r}
nested.sel.cig <- nested.sel.cig %>%
  mutate(pool = map(sel.mod, possibly(sel_pool_fun, NA_real_)))

sel.tab.cig <- nested.sel.cig %>%
  select(-sel.mod) %>%
  unnest(pool) %>% 
  mutate(sig = ifelse(sign(CI.lower) == sign(CI.upper), "sig", "ns")) %>%
  mutate(Trait = mapvalues(Trait, traits$old, traits$breaks),
         Trait = factor(Trait, levels = traits$breaks)) %>%
  mutate_at(vars(Estimate, CI.lower, CI.upper), funs(exp)) %>%
  filter(term == "value") %>%
  mutate(term = "Cig")
```
## Socialization Effects: Trajectories
### Basic Models
```{r}
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$Cig
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "NoCig", `1` = "Cig")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  return(psw.df)
}


nested.psw.cig <- nested.psw.cig %>% 
  mutate(imp.data.long = map(psw.df, possibly(add_psw_weights, NA_real_)))

head(nested.psw.cig$imp.data.long)

imp.data.psw.cig <- (nested.psw.cig %>% filter(match_set == "socialization"))$imp.data.long
#good after here


mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.cig[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = age0/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.cig <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad"),
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Define Functions
#### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoCig_Intercept", "NoCig_Slope", "Cig_Intercept",  "Cig_Slope", "NoCig_Slope2", "Cig_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoCig_Intercept", "NoCig_Slope", "Cig_Intercept",  "Cig_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.cig <- nested.mods.cig %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsCig"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))


```




## Socialization Effects: End Intercept
### Basic Models
```{r}
mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.cig[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = (age0 - 10)/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.cig.end <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.cig.end <- nested.mods.cig.end %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsCig"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))
```

# Coke
## Propensity Score Weighting
### Defining Functions
```{r}
# this function actually runs the propensity score weighting procedure
psw_fun <- function(df, match_set){
   if(match_set == "socialization"){
  to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Coke"))]
  } else{
    to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Coke",
                                            "CESD", "SelfEstm", "Impls", "SensSeek"))]
  }
  match.formula <- as.formula(paste("Coke ~ ", paste(to.match, collapse=" + "), sep = " "))
  y <- matchit(match.formula, data = df, method = "nearest", caliper = .1, ratio = 4)
}

unbalanced_fun <- function(x){
  y <- summary(x, standardize = T)
  raw <- y$sum.all %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  smalldiff.var <- raw %>% filter(abs(`Std. Mean Diff.`) <= .05)
  matched <- y$sum.matched %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  unbalanced.var <- matched %>% filter(abs(`Std. Mean Diff.`) >= .2)
  return(list(raw = raw, matched = matched, 
              unbalanced = unbalanced.var,smalldiff = smalldiff.var))
}

```
### Running Matching
```{r}
coke_good <- group_demo_wide %>%
  left_join(new_spline_data_coke %>% select(PROC_CID, ageI)) %>%
  mutate(ageI = ifelse(is.na(ageI), 100, ageI)) %>%
  filter(ageI > 14)

coke_subs <- unique(coke_good$PROC_CID)

nested_mi_coke <- nested_mi %>%
  mutate(imp.data = map(imp.data, ~filter(.x, PROC_CID %in% coke_subs)))


nested.psw.coke <- nested_mi_coke %>%
  mutate(imp.data = map(imp.data, function(x){x %>% select(PROC_CID, Coke, one_of(keep_vars))}),
         psw = map2(imp.data, match_set, possibly(psw_fun, NA_real_)),
         psw.df = map(psw, possibly(psw_df, NA_real_)))


 nested.psw.coke.table <- nested.psw.coke %>%
  mutate(bal.df = map(psw, unbalanced_fun),
         raw = map(bal.df, ~.$raw),
         matched = map(bal.df, ~.$matched),
         unbal.tab = map(bal.df, possibly(~.$unbalanced, NA_real_)),
         smalldiff.tab = map(bal.df, possibly(~.$smalldiff, NA_real_)))
```
## Selection Effects
### Data
```{r}
sel_fun <- function (trait, weight, ms){
  models <- lapply(1:10, function(x){
    print(paste(trait, x), sep = " ")
    df <- nested.psw.coke %>% filter(chain == paste("chain", x, sep = ".") & match_set == ms) %>%
          unnest(imp.data.long) %>% 
          left_join(out_long_MI %>% filter(age == 14 & item == trait)) %>%
      filter(!is.na(item))
   if(weight != "weighted"){
      df$psw.weights <- rep(1, nrow(df))
    } 
      mod <- nnet::multinom(
        groups ~ value, data = df, weights = psw.weights
        )
  return(mod)
  })
}

nested.sel.coke <- nested.sel %>% 
  mutate(sel.mod = map2(Trait, weight, ~sel_fun(.x, .y, "selection")))
```
### Table Results
```{r}
nested.sel.coke <- nested.sel.coke %>%
  mutate(pool = map(sel.mod, possibly(sel_pool_fun, NA_real_)))

sel.tab.coke <- nested.sel.coke %>%
  select(-sel.mod) %>%
  unnest(pool) %>% 
  mutate(sig = ifelse(sign(CI.lower) == sign(CI.upper), "sig", "ns")) %>%
  mutate(Trait = mapvalues(Trait, traits$old, traits$breaks),
         Trait = factor(Trait, levels = traits$breaks)) %>%
  mutate_at(vars(Estimate, CI.lower, CI.upper), funs(exp)) %>%
  filter(term == "value") %>%
  mutate(term = "Coke")

```


## Socialization Effects: Trajectories
### Basic Models
```{r}
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$Coke
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "NoCoke", `1` = "Coke")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  return(psw.df)
}


nested.psw.coke <- nested.psw.coke %>% 
  mutate(imp.data.long = map(psw.df, possibly(add_psw_weights, NA_real_)))


imp.data.psw.coke <- (nested.psw.coke %>% filter(match_set == "socialization"))$imp.data.long
#good after here


mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.coke[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = age0/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.coke <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad"),
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
 ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Define Functions
#### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoCoke_Intercept", "NoCoke_Slope", "Coke_Intercept",  "Coke_Slope", "NoCoke_Slope2", "Coke_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoCoke_Intercept", "NoCoke_Slope", "Coke_Intercept",  "Coke_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
 
# pool population and individual level effects
nested.mods.coke <- nested.mods.coke %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsCoke"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))
```
## Socialization Effects: End Intercept
### Basic Models
```{r}
mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.coke[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = (age0 - 10)/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.coke.end <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.coke.end <- nested.mods.coke.end %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsCoke"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))

```
# Hallucinogens
## Propensity Score Weighting 
### Defining Functions
```{r}
# this function actually runs the propensity score weighting procedure
psw_fun <- function(df, match_set){
   if(match_set == "socialization"){
  to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Halluc"))]
  } else{
    to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Halluc",
                                            "CESD", "SelfEstm", "Impls", "SensSeek"))]
  }
  match.formula <- as.formula(paste("Halluc ~ ", paste(to.match, collapse=" + "), sep = " "))
  y <- matchit(match.formula, data = df, method = "nearest", caliper = .1, ratio = 4)
}

unbalanced_fun <- function(x){
  y <- summary(x, standardize = T)
  raw <- y$sum.all %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  smalldiff.var <- raw %>% filter(abs(`Std. Mean Diff.`) <= .05)
  matched <- y$sum.matched %>%
    mutate(var = rownames(.)) %>%
    select(var, `Means Treated`, `Means Control`, `Std. Mean Diff.`)
  unbalanced.var <- matched %>% filter(abs(`Std. Mean Diff.`) >= .2)
  return(list(raw = raw, matched = matched, 
              unbalanced = unbalanced.var,smalldiff = smalldiff.var))
}
```
### Running Matching
```{r}
halluc_good <- group_demo_wide %>%
  left_join(new_spline_data_halluc %>% select(PROC_CID, ageI)) %>%
  mutate(ageI = ifelse(is.na(ageI), 100, ageI)) %>%
  filter(ageI > 14)

halluc_subs <- unique(halluc_good$PROC_CID)

nested_mi_halluc <- nested_mi %>%
  mutate(imp.data = map(imp.data, ~filter(.x, PROC_CID %in% halluc_subs)))


nested.psw.halluc <- nested_mi_halluc %>%
  mutate(imp.data = map(imp.data, function(x){x %>% select(PROC_CID, Halluc, one_of(keep_vars))}),
         psw = map2(imp.data, match_set, possibly(psw_fun, NA_real_)),
         psw.df = map(psw, possibly(psw_df, NA_real_)))




 nested.psw.halluc.table <- nested.psw.halluc %>%
  mutate(bal.df = map(psw, unbalanced_fun),
         raw = map(bal.df, ~.$raw),
         matched = map(bal.df, ~.$matched),
         unbal.tab = map(bal.df, possibly(~.$unbalanced, NA_real_)),
         smalldiff.tab = map(bal.df, possibly(~.$smalldiff, NA_real_)))
```
### Balance Tables
## Selection Effects
### Data
```{r}
sel_fun <- function (trait, weight, ms){
  models <- lapply(1:10, function(x){
    # require(tidyverse); require(lavaan)
    print(paste(trait, x), sep = " ")
    df <- nested.psw.halluc %>% filter(chain == paste("chain", x, sep = ".") & match_set == ms) %>%
          unnest(imp.data.long) %>% 
          left_join(out_long_MI %>% filter(age == 14 & item == trait)) %>%
      filter(!is.na(item))
   if(weight != "weighted"){
      df$psw.weights <- rep(1, nrow(df))
    } 
      mod <- nnet::multinom(
        groups ~ value, data = df, weights = psw.weights
        )
  return(mod)
  })
}

nested.sel.halluc <- nested.sel %>% 
  mutate(sel.mod = map2(Trait, weight, ~sel_fun(.x, .y, "selection")))
```
### Table Results
```{r}
nested.sel.halluc <- nested.sel.halluc %>%
  mutate(pool = map(sel.mod, possibly(sel_pool_fun, NA_real_)))

sel.tab.halluc <- nested.sel.halluc %>%
  select(-sel.mod) %>%
  unnest(pool) %>% 
  mutate(sig = ifelse(sign(CI.lower) == sign(CI.upper), "sig", "ns")) %>%
  mutate(Trait = mapvalues(Trait, traits$old, traits$breaks),
         Trait = factor(Trait, levels = traits$breaks)) %>%
  mutate_at(vars(Estimate, CI.lower, CI.upper), funs(exp)) %>%
  filter(term == "value") %>%
  mutate(term = "Halluc")

```


## Socialization Effects: Trajectories
### Basic Models
```{r}
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$Halluc
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "NoHalluc", `1` = "Halluc")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  return(psw.df)
}


nested.psw.halluc <- nested.psw.halluc %>% 
  mutate(imp.data.long = map(psw.df, possibly(add_psw_weights, NA_real_)))

imp.data.psw.halluc <- (nested.psw.halluc %>% filter(match_set == "socialization"))$imp.data.long
#good after here


mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.halluc[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = age0/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.halluc <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad"),
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))

```
### Define Functions
#### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoHalluc_Intercept", "NoHalluc_Slope", "Halluc_Intercept",  "Halluc_Slope", "NoHalluc_Slope2", "Halluc_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoHalluc_Intercept", "NoHalluc_Slope", "Halluc_Intercept",  "Halluc_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.halluc <- nested.mods.halluc %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsHalluc"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))

```
## Socialization Effects: End Intercept 
### Basic Models
```{r}
mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.halluc[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = (age0 - 10)/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.halluc.end <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoHalluc_Intercept", "NoHalluc_Slope", "Halluc_Intercept",  "Halluc_Slope", "NoHalluc_Slope2", "Halluc_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoHalluc_Intercept", "NoHalluc_Slope", "Halluc_Intercept",  "Halluc_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.halluc.end <- nested.mods.halluc.end %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsHalluc"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))

```



Marijuana

# Marijuana
## Propensity Score Weighting 
### Defining Functions
```{r}
# this function actually runs the propensity score weighting procedure
psw_fun <- function(df, match_set){
   if(match_set == "socialization"){
  to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Mar"))]
  } else{
    to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","Mar",
                                            "CESD", "SelfEstm", "Impls", "SensSeek"))]
  }
  match.formula <- as.formula(paste("Mar ~ ", paste(to.match, collapse=" + "), sep = " "))
  y <- matchit(match.formula, data = df, method = "nearest", caliper = .1, ratio = 4)
}

```
### Running Matching
```{r}
mar_good <- group_demo_wide %>%
  left_join(new_spline_data_mar %>% select(PROC_CID, ageI)) %>%
  mutate(ageI = ifelse(is.na(ageI), 100, ageI)) %>%
  filter(ageI > 14)

mar_subs <- unique(mar_good$PROC_CID)

nested_mi_mar <- nested_mi %>%
  mutate(imp.data = map(imp.data, ~filter(.x, PROC_CID %in% mar_subs)))


nested.psw.mar <- nested_mi_mar %>%
  mutate(imp.data = map(imp.data, function(x){x %>% select(PROC_CID, Mar, one_of(keep_vars))}),
         psw = map2(imp.data, match_set, possibly(psw_fun, NA_real_)),
         psw.df = map(psw, possibly(psw_df, NA_real_)))


 nested.psw.mar.table <- nested.psw.mar %>%
  mutate(bal.df = map(psw, unbalanced_fun),
         raw = map(bal.df, ~.$raw),
         matched = map(bal.df, ~.$matched),
         unbal.tab = map(bal.df, possibly(~.$unbalanced, NA_real_)),
         smalldiff.tab = map(bal.df, possibly(~.$smalldiff, NA_real_)))
```
## Selection Effects
### Data
```{r}
sel_fun <- function (trait, weight, ms){
  models <- lapply(1:10, function(x){
    print(paste(trait, x), sep = " ")
    df <- nested.psw.mar %>% filter(chain == paste("chain", x, sep = ".") & match_set == ms) %>%
          unnest(imp.data.long) %>% 
          left_join(out_long_MI %>% filter(age == 14 & item == trait)) %>%
      filter(!is.na(item))
   if(weight != "weighted"){
      df$psw.weights <- rep(1, nrow(df))
    } 
      mod <- nnet::multinom(
        groups ~ value, data = df, weights = psw.weights
        )
  return(mod)
  })
}

nested.sel.mar <- nested.sel %>% 
  mutate(sel.mod = map2(Trait, weight, ~sel_fun(.x, .y, "selection")))
```
### Table Results
```{r}
nested.sel.mar <- nested.sel.mar %>%
  mutate(pool = map(sel.mod, possibly(sel_pool_fun, NA_real_)))

sel.tab.mar <- nested.sel.mar %>%
  select(-sel.mod) %>%
  unnest(pool) %>% 
  mutate(sig = ifelse(sign(CI.lower) == sign(CI.upper), "sig", "ns")) %>%
  mutate(Trait = mapvalues(Trait, traits$old, traits$breaks),
         Trait = factor(Trait, levels = traits$breaks)) %>%
  mutate_at(vars(Estimate, CI.lower, CI.upper), funs(exp)) %>%
  filter(term == "value") %>%
  mutate(term = "Mar")


sel.tab.mar %>% 
  filter(weight == "weighted") %>%
  ggplot(aes(x = term, y = Estimate)) +
    scale_color_manual(values = c("springgreen3", "blue")) +
    geom_hline(aes(yintercept = exp(0)), linetype = "dashed") +
    geom_errorbar(aes(ymin = CI.lower, ymax = CI.upper), width = .2, size = .75) +
    geom_point(aes(color = term), size = 4) +
    labs(y = "Odds", x = NULL) +
    facet_grid(.~Trait, scale = "free") +
    theme_classic() +
    theme(legend.position = "none",
          axis.text = element_text(face = "bold", size = rel(1.2)),
          axis.text.x = element_text(face = "bold", size = rel(1.2), hjust = 1, angle = 45),
          axis.title = element_text(face = "bold", size = rel(1.2)),
          strip.text = element_text(face = "bold", size = rel(1.2)))
```


## Socialization Effects: Trajectories
### Basic Models
```{r}
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$Mar
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "NoMar", `1` = "Mar")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  return(psw.df)
}


nested.psw.mar <- nested.psw.mar %>% 
  mutate(imp.data.long = map(psw.df, possibly(add_psw_weights, NA_real_)))


imp.data.psw.mar <- (nested.psw.mar %>% filter(match_set == "socialization"))$imp.data.long
#good after here


mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.mar[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = age0/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.mar <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad"),
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Define Functions
#### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoMar_Intercept", "NoMar_Slope", "Mar_Intercept",  "Mar_Slope", "NoMar_Slope2", "Mar_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoMar_Intercept", "NoMar_Slope", "Mar_Intercept",  "Mar_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.mar <- nested.mods.mar %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsMar"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))

```




## Socialization: End Intercept 
### Basic Models
```{r}
mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.mar[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = (age0 - 10)/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.mar.end <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoMar_Intercept", "NoMar_Slope", "Mar_Intercept",  "Mar_Slope", "NoMar_Slope2", "Mar_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoMar_Intercept", "NoMar_Slope", "Mar_Intercept",  "Mar_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.mar.end <- nested.mods.mar.end %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsMar"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))

```
# Inhalants
## Propensity Score Weighting 
### Defining Functions 
```{r}
# this function actually runs the propensity score weighting procedure
psw_fun <- function(df, match_set){
   if(match_set == "socialization"){
  to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","SH"))]
  } else{
    to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","SH",
                                            "CESD", "SelfEstm", "Impls", "SensSeek"))]
  }
  match.formula <- as.formula(paste("SH ~ ", paste(to.match, collapse=" + "), sep = " "))
  y <- matchit(match.formula, data = df, method = "nearest", caliper = .1, ratio = 4)
}

```
### Running Matching
```{r}
SH_good <- group_demo_wide %>%
  left_join(new_spline_data_SH %>% select(PROC_CID, ageI)) %>%
  mutate(ageI = ifelse(is.na(ageI), 100, ageI)) %>%
  filter(ageI > 14)

SH_subs <- unique(SH_good$PROC_CID)

nested_mi_SH <- nested_mi %>%
  mutate(imp.data = map(imp.data, ~filter(.x, PROC_CID %in% SH_subs)))


nested.psw.SH <- nested_mi_SH %>%
  mutate(imp.data = map(imp.data, function(x){x %>% select(PROC_CID, SH, one_of(keep_vars))}),
         psw = map2(imp.data, match_set, possibly(psw_fun, NA_real_)),
         psw.df = map(psw, possibly(psw_df, NA_real_)))

 nested.psw.SH.table <- nested.psw.SH %>%
  mutate(bal.df = map(psw, unbalanced_fun),
         raw = map(bal.df, ~.$raw),
         matched = map(bal.df, ~.$matched),
         unbal.tab = map(bal.df, possibly(~.$unbalanced, NA_real_)),
         smalldiff.tab = map(bal.df, possibly(~.$smalldiff, NA_real_)))
```
## Selection Effects
### Data
```{r}
sel_fun <- function (trait, weight, ms){
  models <- lapply(1:10, function(x){
    print(paste(trait, x), sep = " ")
    df <- nested.psw.SH %>% filter(chain == paste("chain", x, sep = ".") & match_set == ms) %>%
          unnest(imp.data.long) %>% 
          left_join(out_long_MI %>% filter(age == 14 & item == trait)) %>%
      filter(!is.na(item))
   if(weight != "weighted"){
      df$psw.weights <- rep(1, nrow(df))
    } 
      mod <- nnet::multinom(
        groups ~ value, data = df, weights = psw.weights
        )
  return(mod)
  })
}

nested.sel.SH <- nested.sel %>% 
  mutate(sel.mod = map2(Trait, weight, ~sel_fun(.x, .y, "selection")))
```
### Table Results
```{r}
nested.sel.SH <- nested.sel.SH %>%
  mutate(pool = map(sel.mod, possibly(sel_pool_fun, NA_real_)))

sel.tab.SH <- nested.sel.SH %>%
  select(-sel.mod) %>%
  unnest(pool) %>% 
  mutate(sig = ifelse(sign(CI.lower) == sign(CI.upper), "sig", "ns")) %>%
  mutate(Trait = mapvalues(Trait, traits$old, traits$breaks),
         Trait = factor(Trait, levels = traits$breaks)) %>%
  mutate_at(vars(Estimate, CI.lower, CI.upper), funs(exp)) %>%
  filter(term == "value") %>%
  mutate(term = "SH")

```
## Socialization Effects: Trajectories
### Basic Models
```{r}
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$SH
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "NoSH", `1` = "SH")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  return(psw.df)
}


nested.psw.SH <- nested.psw.SH %>% 
  mutate(imp.data.long = map(psw.df, possibly(add_psw_weights, NA_real_)))


imp.data.psw.SH <- (nested.psw.SH %>% filter(match_set == "socialization"))$imp.data.long
#good after here


mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.SH[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = age0/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.SH <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad"),
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Define Functions
#### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoSH_Intercept", "NoSH_Slope", "SH_Intercept",  "SH_Slope", "NoSH_Slope2", "SH_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoSH_Intercept", "NoSH_Slope", "SH_Intercept",  "SH_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.SH <- nested.mods.SH %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsSH"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))

```
## Socialization Effects: End Intercept 
### Basic Models
```{r}
mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.SH[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = (age0 - 10)/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.SH.end <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoSH_Intercept", "NoSH_Slope", "SH_Intercept",  "SH_Slope", "NoSH_Slope2", "SH_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoSH_Intercept", "NoSH_Slope", "SH_Intercept",  "SH_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.SH.end <- nested.mods.SH.end %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsSH"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))
```
# Downers
## Propensity Score Weighting 
### Defining Functions 
```{r}
# this function actually runs the propensity score weighting procedure

psw_fun <- function(df, match_set){
   if(match_set == "socialization"){
  to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","UD"))]
  } else{
    to.match <- colnames(df)[-which(colnames(df) %in% c("PROC_CID","PROC_MID","UD",
                                            "CESD", "SelfEstm", "Impls", "SensSeek"))]
  }
  match.formula <- as.formula(paste("UD ~ ", paste(to.match, collapse=" + "), sep = " "))
  y <- matchit(match.formula, data = df, method = "nearest", caliper = .1, ratio = 4)
}

```
### Running Matching
```{r}
UD_good <- group_demo_wide %>%
  left_join(new_spline_data_UD %>% select(PROC_CID, ageI)) %>%
  mutate(ageI = ifelse(is.na(ageI), 100, ageI)) %>%
  filter(ageI > 14)

UD_subs <- unique(UD_good$PROC_CID)

nested_mi_UD <- nested_mi %>%
  mutate(imp.data = map(imp.data, ~filter(.x, PROC_CID %in% UD_subs)))


nested.psw.UD <- nested_mi_UD %>%
  mutate(imp.data = map(imp.data, function(x){x %>% select(PROC_CID, UD, one_of(keep_vars))}),
         psw = map2(imp.data, match_set, possibly(psw_fun, NA_real_)),
         psw.df = map(psw, possibly(psw_df, NA_real_)))


 nested.psw.UD.table <- nested.psw.UD %>%
  mutate(bal.df = map(psw, unbalanced_fun),
         raw = map(bal.df, ~.$raw),
         matched = map(bal.df, ~.$matched),
         unbal.tab = map(bal.df, possibly(~.$unbalanced, NA_real_)),
         smalldiff.tab = map(bal.df, possibly(~.$smalldiff, NA_real_)))
```
## Selection Effects
### Data
```{r}
sel_fun <- function (trait, weight, ms){
  models <- lapply(1:10, function(x){
    print(paste(trait, x), sep = " ")
    df <- nested.psw.UD %>% filter(chain == paste("chain", x, sep = ".") & match_set == ms) %>%
          unnest(imp.data.long) %>% 
          left_join(out_long_MI %>% filter(age == 14 & item == trait)) %>%
      filter(!is.na(item))
   if(weight != "weighted"){
      df$psw.weights <- rep(1, nrow(df))
    } 
      mod <- nnet::multinom(
        groups ~ value, data = df, weights = psw.weights
        )
  return(mod)
  })
}

nested.sel.UD <- nested.sel %>% 
  mutate(sel.mod = map2(Trait, weight, ~sel_fun(.x, .y, "selection")))
```
### Table Results
```{r}
nested.sel.UD <- nested.sel.UD %>%
  mutate(pool = map(sel.mod, possibly(sel_pool_fun, NA_real_)))

sel.tab.UD <- nested.sel.UD %>%
  select(-sel.mod) %>%
  unnest(pool) %>% 
  mutate(sig = ifelse(sign(CI.lower) == sign(CI.upper), "sig", "ns")) %>%
  mutate(Trait = mapvalues(Trait, traits$old, traits$breaks),
         Trait = factor(Trait, levels = traits$breaks)) %>%
  mutate_at(vars(Estimate, CI.lower, CI.upper), funs(exp)) %>%
  filter(term == "value") %>%
  mutate(term = "UD")

```

## Socialization Effects: Trajectories
### Basic Models
```{r}
add_psw_weights <- function(psw.df){
  psw.df$psw.weights <- psw.df$distance
  psw.df$groups <- psw.df$UD
  psw.df$groups <- recode_factor(psw.df$groups, `0` = "NoUD", `1` = "UD")
  psw.df <- psw.df %>% 
    dplyr::select(PROC_CID, groups, psw.weights, CESD, SelfEstm, SensSeek, Impls)
  return(psw.df)
}


nested.psw.UD <- nested.psw.UD %>% 
  mutate(imp.data.long = map(psw.df, possibly(add_psw_weights, NA_real_)))


imp.data.psw.UD <- (nested.psw.UD %>% filter(match_set == "socialization"))$imp.data.long
#good after here


mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.UD[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = age0/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.UD <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad"),
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Define Functions
#### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoUD_Intercept", "NoUD_Slope", "UD_Intercept",  "UD_Slope", "NoUD_Slope2", "UD_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoUD_Intercept", "NoUD_Slope", "UD_Intercept",  "UD_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.UD <- nested.mods.UD %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsUD"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))

```
## Socialization Effects: End Intercept
### Basic Models
```{r}
mod_fun <- function(dv, psw.Weights, Form){
  print(paste(dv, psw.Weights, Form, sep = " "))
  lapply(1:10, function(x){
    lmer_fun(X = x, DV = dv, PSW.Weights = psw.Weights, form = Form)})
}

# short function for running models
lmer_fun <- function(X, DV, PSW.Weights, form){
    df <- imp.data.psw.UD[[X]] %>% gather(key = dv, value = T1_value, CESD:Impls) %>% filter(dv == DV) %>%
    full_join(out_long_MI %>% filter(item == DV) %>% select(PROC_CID, age0, value))
    df <- data.frame(unclass(df)) %>%
    mutate(age0 = (age0 - 10)/5) %>%
    mutate(age02 = age0^2, age03 = age0^3) 
  if(PSW.Weights == "weighted"){PSW.Weights <- df$psw.weights}
  else{PSW.Weights <- rep(1, nrow(df))}
  lmerControl(check.conv.grad     = .makeCC("ignore", tol = 2e-2, relTol = NULL),
    check.conv.singular = .makeCC(action = "ignore",  tol = 1e-2),
    check.conv.hess     = .makeCC(action = "ignore", tol = 1e-3),
    check.scaleX = c("ignore"))
  if(form == "linear"){y <- lme4::lmer(formula = value ~ T1_value + age0*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights, 
                      control = )}
  else{y <- lme4::lmer(formula = value ~ T1_value + age0*groups + age02*groups + 
                      (age0 | PROC_CID),  data = df, weights = PSW.Weights)}
}

nested.mods.UD.end <- expand.grid(
  pred = unique(out_long_MI$item), 
  mod = c("linear", "quad") ,
  weighted = c("weighted", "unweighted"),
  stringsAsFactors = F
  ) %>% tbl_df %>%
  mutate(models = pmap(.l = list(pred, weighted, mod), .f = mod_fun))
```
### Hypothesis Tests
```{r}
hyp_tests <- function(mods, ml){
  int_hyp_fun <- function(mod, ml){
    if(ml == "quad"){
    h <- rbind(c(1,0,0,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0,0,0), # Drug Intercept
               c(0,0,1,0,0,1,0), # Drug Linear Slope
               c(0,0,0,0,1,0,0), # NoDrug Quadratic Slope
               c(0,0,0,0,1,0,1)) # Drug Quadratic Slope
    row.names(h) <- c("NoUD_Intercept", "NoUD_Slope", "UD_Intercept",  "UD_Slope", "NoUD_Slope2", "UD_Slope2")
    } else{
    h <- rbind(c(1,0,0,0,0), # NoDrug Intercept
               c(0,0,1,0,0), # NoDrug Linear Slope
               c(1,0,0,1,0), # Drug Intercept
               c(0,0,1,0,1)) # Drug Linear Slope
    row.names(h) <- c("NoUD_Intercept", "NoUD_Slope", "UD_Intercept",  "UD_Slope")
    }
    h  <- multcomp::glht(mod, h)
    ci <- confint(h, calpha = multcomp::univariate_calpha()) 
    res <- ci$confint %>% data.frame() %>% mutate(term = row.names(.))
  }
  tibble(chain = 1:10, models = mods) %>%
    mutate(h = map(mods, ~int_hyp_fun(., ml))) %>%
    unnest(h) %>%
    group_by(term) %>%
    summarise_at(vars(Estimate:upr), funs(mean(., na.rm = T)))
}
```
### Pool Models
```{r}
# pool population and individual level effects
nested.mods.UD.end <- nested.mods.UD.end %>%
  mutate(pooled_re = map(models, possibly(pooled_re_fun, NA_real_)),
         pool = map2(models, pooled_re, possibly(pool_fun, NA_real_)),
         pooled_vcov = map(models, possibly(pool_vcov, NA_real_)),
         pooled.dev = map(models, possibly(dev_fun, NA_real_)), 
         pooled_se = map(pooled_vcov, possibly(~se_fun(., "age0", "groupsUD"), NA_real_)),
         pooled_hyp = map2(models, mod, hyp_tests))

```